<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v5.0.1</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- iOS 26 Future Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-glass: rgba(255, 255, 255, 0.75);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-success: #34C759;
      --ios-warning: #FFCC00;
      --glass-blur: blur(35px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html { height: 100%; overscroll-behavior-y: none; }
    body {
      height: 100%;
      font-family: var(--font-stack);
      background-color: #000;
      margin: 0;
      color: #000;
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    main {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 20px;
        padding-bottom: 120px; /* Space for Dock */
    }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }

    /* iOS Glass Card */
    .ios-card {
      background: var(--ios-card-glass);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.04);
      overflow: hidden;
    }

    /* Dark Premium Card */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white;
      position: relative;
      overflow: hidden;
    }
    .dark-glass-gradient {
        position: absolute;
        top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none; z-index: 0;
    }

    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      margin-bottom: 10px; 
      padding: 14px;
      display: flex;
      align-items: center; 
      justify-content: space-between;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.6);
    }
    .ios-list-item:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.95); }

    /* Drag & Drop */
    .sortable-ghost { opacity: 0.4; background: #E5E5EA; border: 1px dashed #AEAEB2; }
    .drag-handle { cursor: grab; padding: 10px; margin: -10px; color: #C7C7CC; touch-action: none; }
    
    /* Action Buttons */
    .action-btn-group {
        display: flex; align-items: center; gap: 4px; padding-left: 8px;
        opacity: 0.3; transition: opacity 0.2s;
    }
    .ios-list-item:hover .action-btn-group, .action-btn-group:active { opacity: 1; }
    .icon-btn { padding: 8px; color: #8E8E93; border-radius: 50%; }
    .icon-btn.edit:hover { color: var(--ios-primary); background: rgba(0,122,255,0.1); }
    .icon-btn.delete:hover { color: var(--ios-danger); background: rgba(255,59,48,0.1); }

    /* Modals */
    .modal-backdrop { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px); z-index: 100; transition: all 0.3s; }
    .ios-modal-container {
      background: #F2F2F7;
      border-radius: 32px;
      display: flex; flex-direction: column;
      max-height: 90vh; width: 94%; max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .ios-modal-header { padding: 18px; text-align: center; font-weight: 700; font-size: 17px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); z-index: 10; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; background: #F2F2F7; }
    .ios-modal-footer { padding: 16px 24px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; }

    /* Buttons & Inputs */
    .ios-input {
      background: #FFFFFF;
      border: none; border-radius: 14px; padding: 14px 16px;
      font-size: 17px; color: #000; width: 100%; box-sizing: border-box;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .btn-ios-cancel {
      flex: 1; height: 50px; border-radius: 14px; background: #E5E5EA; color: #000; font-weight: 600; display: flex; align-items: center; justify-content: center;
    }
    .btn-ios-primary {
      flex: 1; height: 50px; border-radius: 14px; background: var(--ios-primary); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    /* Dock */
    .iphone-dock {
      background: rgba(250, 250, 250, 0.85);
      backdrop-filter: blur(60px) saturate(180%);
      -webkit-backdrop-filter: blur(60px) saturate(180%);
      border-radius: 38px;
      padding: 10px 10px 8px 10px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px;
    }
    .dock-item {
        display: flex; flex-col; flex-direction: column; align-items: center; justify-content: flex-end;
        height: 100%; color: #999; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .dock-item.active { color: var(--ios-primary); transform: translateY(-4px); }
    .dock-item.active i { font-weight: bold; fill: currentColor; text-shadow: 0 0 15px rgba(0,122,255,0.4); }

    /* Tabs */
    .day-tab { transition: all 0.3s; background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.2); }
    .day-tab.active { background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transform: scale(1.02); }

    /* Category Icons (iOS 26 Style) */
    .cat-icon-box {
        width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
        font-size: 20px; color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    /* Gradients for Categories */
    .bg-grad-ticket { background: linear-gradient(135deg, #AF52DE, #BF5AF2); }
    .bg-grad-transport { background: linear-gradient(135deg, #007AFF, #5AC8FA); }
    .bg-grad-shopping { background: linear-gradient(135deg, #FF2D55, #FF375F); }
    .bg-grad-dining { background: linear-gradient(135deg, #FF9500, #FFCC00); }
    .bg-grad-entertainment { background: linear-gradient(135deg, #5856D6, #5E5CE6); }
    .bg-grad-stay { background: linear-gradient(135deg, #30B0C7, #32ADE6); }
    .bg-grad-service { background: linear-gradient(135deg, #34C759, #30D158); }
    .bg-grad-other { background: linear-gradient(135deg, #8E8E93, #AEAEB2); }

    /* Calculator & Keypad */
    .calc-display {
        background: #000; color: white; font-family: 'SF Mono', monospace;
        font-size: 32px; padding: 16px; border-radius: 16px; text-align: right;
        margin-bottom: 12px; height: 70px; display: flex; align-items: center; justify-content: flex-end;
    }
    .keypad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .key-btn {
        height: 50px; border-radius: 12px; border: none; font-size: 20px; font-weight: 500;
        display: flex; align-items: center; justify-content: center;
        background: #FFF; box-shadow: 0 2px 0 rgba(0,0,0,0.05); color: #000;
        active: bg-gray-200;
    }
    .key-btn:active { background: #E5E5EA; transform: translateY(1px); box-shadow: none; }
    .key-btn.op { background: #FF9F0A; color: white; font-weight: 700; }
    .key-btn.op:active { background: #D48806; }
    .key-btn.grey { background: #D1D1D6; color: black; }

    /* Animations */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

  </style>
</head>

<body>
  <div id="app">
    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80" class="w-full h-full object-cover blur-[6px] scale-105 opacity-80" alt="Background">
      <div class="absolute inset-0 bg-gradient-to-b from-white/60 to-[#F2F2F7]/90 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 px-5">
      
      <div class="flex items-center justify-between mb-6 mt-4">
        <div>
          <h1 class="text-[32px] leading-tight font-bold tracking-tight text-gray-900 font-[SF Pro Display]">
            Travel Sync
          </h1>
          <div class="flex items-center gap-2 pl-1">
            <span class="text-[10px] font-bold text-[#007AFF] bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">{{ appVersion }}</span>
            <div class="flex items-center gap-2 bg-white/60 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
                 <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300"
                     :class="syncState === 'synced' ? 'bg-[#34C759]' : (syncState === 'error' ? 'bg-[#FF3B30]' : 'bg-[#FFCC00]')"></div>
                <span class="text-[10px] font-medium text-gray-500">{{ syncStatusText }}</span>
            </div>
             <button @click="forceReloadCloud" class="text-gray-400 active:text-[#007AFF] transition p-1">
                <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
            </button>
          </div>
        </div>
      
        <div class="flex flex-col items-end text-right">
           <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide mb-0.5">HKD / TWD</span>
           <div class="text-2xl font-bold text-gray-800 tracking-tight font-mono leading-none my-0.5">
             {{ formattedRate }}
           </div>
           <div class="text-[9px] font-medium text-gray-400 font-mono">包括 2% 手續費</div>
        </div>
      </div>

      <div v-if="currentTab === '行程'" class="mb-6">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i)"
                  class="day-tab flex-shrink-0 w-[24%] h-[72px] rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group"
                  :class="{ 'active': selectedDay === i }">
            <span class="text-[10px] font-bold uppercase text-gray-400 mb-0.5 group-[.active]:text-[#007AFF]">Day {{ i + 1 }}</span>
            <span class="text-[11px] font-medium text-gray-400 group-[.active]:text-gray-800">{{ d.week }}</span>
            <span class="text-xl font-bold mt-0.5 leading-none text-gray-600 group-[.active]:text-black">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentTab === '行程'" class="space-y-5 animate-fade-in">
        
        <div class="ios-card p-5 relative">
          <div class="flex justify-between items-center"> 
             <div class="flex-1">
                  <div class="flex items-center gap-1.5 text-gray-500 mb-2">
                    <i class="ph ph-map-pin-simple-area text-xs"></i>
                    <span class="text-[11px] font-bold uppercase tracking-wider">台北市</span>
                  </div>
                  <div class="flex items-center gap-4"> 
                      <div class="text-[60px] leading-none font-light tracking-tighter text-black flex items-start">
                        {{ weather.temp }}<span class="text-3xl mt-1 font-normal">°</span>
                      </div>
                      <div class="flex flex-col gap-0.5">
                          <div class="text-xs font-medium text-gray-500">體感 {{ weather.feelsLike }}°</div>
                          <div class="text-xs font-medium text-gray-500">降雨 {{ weather.rain }}%</div>
                      </div>
                  </div>
               </div>
               <div class="text-right">
                  <i :class="weatherIconClass" class="text-[3.5rem] text-gray-800/80 drop-shadow-sm"></i>
                  <div class="text-sm font-bold text-gray-800 mt-1">{{ weather.desc }}</div>
              </div>
          </div>
        </div>

        <transition name="fade">
          <div v-if="shouldShowFlightCard" class="ios-card-dark-glass p-0">
              <div class="dark-glass-gradient"></div>
              <div class="p-4 pb-2 relative z-10 flex justify-between items-center">
                   <div class="flex items-center gap-2">
                      <i class="ph ph-airplane-in-flight text-[#007AFF]"></i>
                      <span class="text-xs font-bold uppercase tracking-widest opacity-70">航班動態</span>
                  </div>
                  <div class="px-2 py-0.5 rounded text-[10px] font-bold border border-white/20" :class="getStatusClass(activeFlight.status)">{{ activeFlight.status }}</div>
              </div>

              <div class="px-5 pb-6 relative z-10">
                  <div class="flex items-center justify-between mt-2">
                    <div class="text-center min-w-[60px]">
                       <div class="text-3xl font-bold text-white">{{ activeFlight.fromCode }}</div>
                       <div class="text-[10px] opacity-60 mt-1">{{ activeFlight.depTime }}</div>
                    </div>
                    <div class="flex-1 px-4 flex flex-col items-center">
                        <div class="text-[10px] font-mono opacity-50 mb-1">{{ activeFlight.code }}</div>
                       <div class="w-full h-[2px] bg-white/20 rounded-full relative">
                           <i class="ph ph-airplane-tilt absolute -top-2.5 left-1/2 -translate-x-1/2 text-lg text-[#007AFF]"></i>
                       </div>
                   </div>
                    <div class="text-center min-w-[60px]">
                       <div class="text-3xl font-bold text-white">{{ activeFlight.toCode }}</div>
                       <div class="text-[10px] opacity-60 mt-1">{{ activeFlight.arrTime }}</div>
                    </div>
                  </div>
              </div>
          </div>
        </transition>

        <div class="relative pl-4 border-l-2 border-gray-300/50 ml-3 space-y-3 py-2" id="sortable-itinerary">
            <div v-for="it in sortedItinerary" :key="it.id" :data-id="it.id"
              @click="showLocationOnMap(it)" class="relative group cursor-pointer">
               <div class="absolute -left-[23px] top-4 w-3.5 h-3.5 rounded-full bg-white border-[3px] border-gray-300 group-hover:border-[#007AFF] transition-colors z-10 shadow-sm"></div>
               <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-4 border border-white/60 shadow-sm transition-all active:scale-[0.99] flex gap-3">
                   <div class="drag-handle flex items-center text-gray-300"><i class="ph ph-dots-six-vertical text-lg"></i></div>
                   <div class="flex-1">
                       <div class="flex justify-between mb-1">
                           <span class="text-xs font-bold text-[#007AFF] bg-blue-50 px-1.5 py-0.5 rounded">{{ it.time || '--:--' }}</span>
                           <div class="flex gap-2">
                               <button @click.stop="openItineraryModal(it)" class="text-gray-400 hover:text-[#007AFF]"><i class="ph ph-pencil-simple text-lg"></i></button>
                               <button @click.stop="removeItineraryItem(it.id)" class="text-gray-400 hover:text-[#FF3B30]"><i class="ph ph-trash text-lg"></i></button>
                           </div>
                       </div>
                       <div class="font-bold text-[16px] text-gray-900">{{ it.title }}</div>
                       <div v-if="it.note" class="text-xs text-gray-500 mt-1">{{ it.note }}</div>
                   </div>
               </div>
            </div>
            
            <div v-if="sortedItinerary.length === 0" class="py-8 text-center text-gray-400 text-sm">今日無行程</div>
        </div>

        <div class="mt-4 ios-card !bg-white/70 p-3"> 
           <div class="flex gap-2">
               <input v-model="quickItinerary.time" type="time" class="ios-input !w-auto text-center !px-2 font-mono text-sm !bg-white">
               <input v-model="quickItinerary.title" @keyup.enter="addQuickItinerary" class="ios-input flex-1 text-sm !bg-white" placeholder="快速新增行程...">
                <button @click="addQuickItinerary" class="w-12 bg-[#007AFF] text-white rounded-xl shadow-md active:scale-95 transition flex items-center justify-center"><i class="ph ph-plus text-xl"></i></button>
           </div>
        </div>
      </div>

      <div v-if="currentTab === '記帳'" class="animate-fade-in">
          
         <div class="ios-card-dark-glass p-5 mb-5">
             <div class="dark-glass-gradient"></div>
             
             <div class="flex justify-between items-start relative z-10 mb-2">
                 <button @click="membersModalOpen = true" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition backdrop-blur-md">
                     <i class="ph ph-gear text-white text-lg"></i>
                 </button>
                 <button @click="openExpenseModal(null)" class="bg-white text-black p-2 rounded-full shadow-lg hover:bg-gray-100 transition">
                    <i class="ph ph-plus text-xl font-bold"></i>
                </button>
             </div>

            <div class="relative z-10 flex flex-col items-center justify-center -mt-2">
                <div class="text-white/60 text-[11px] font-bold tracking-widest uppercase mb-1">總支出 (HKD)</div>
                  <div class="text-5xl font-light tracking-tight mb-2 text-white flex items-baseline">
                    <span class="text-2xl opacity-60 mr-1">$</span>{{ formatNumber(totalExpense.hkd, 0) }}
                </div>
                <div class="text-white/40 text-sm font-medium">≈ TWD {{ formatNumber(totalExpense.twd, 0) }}</div>
              </div>
          </div>

          <div class="bg-gray-200/60 p-1 rounded-xl flex mb-5 mx-1 backdrop-blur-md">
                <button v-for="f in ['all', 'credit', 'cash']" :key="f"
                    @click="expenseFilter = f"
                    class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-all duration-200 capitalize"
                    :class="expenseFilter === f ? 'bg-white text-black shadow-sm' : 'text-gray-500'">
                    {{ f === 'all' ? '全部' : (f === 'credit' ? '信用卡' : '現金') }}
                </button>
                <div class="w-[1px] bg-gray-300 my-1 mx-1"></div>
                <button @click="expenseFilter = 'settlement'" 
                    class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-1"
                    :class="expenseFilter === 'settlement' ? 'bg-[#34C759] text-white shadow-sm' : 'text-[#34C759]'">
                    <i class="ph ph-calculator"></i> 結算
                </button>
          </div>

          <div v-if="expenseFilter === 'settlement'" class="space-y-3">
              <div v-if="settlementResult.length > 0">
                <div class="text-center text-xs text-gray-400 mb-2">結算中樞：{{ members[0] }} (第一用戶)</div>
                <div v-for="(res, idx) in settlementResult" :key="idx" class="ios-card p-4 flex items-center justify-between">
                     <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-sm"
                              :class="res.amount > 0 ? 'bg-[#34C759]' : 'bg-[#FF3B30]'">
                             {{ res.name.charAt(0) }}
                         </div>
                         <div class="font-bold text-gray-800">{{ res.name }}</div>
                     </div>
                     <div class="text-right">
                         <div class="text-[10px] uppercase font-bold text-gray-400">{{ res.amount > 0 ? '需收取' : '需支付' }}</div>
                         <div class="text-xl font-bold font-mono" :class="res.amount > 0 ? 'text-[#34C759]' : 'text-[#FF3B30]'">
                             HKD {{ formatNumber(Math.abs(res.amount), 1) }}
                         </div>
                     </div>
                </div>
              </div>
              <div v-else class="text-center py-10 text-gray-400">目前無須結算</div>
          </div>

          <div v-else class="space-y-2 pb-20" id="sortable-expenses">
             <div v-for="e in filteredExpenses" :key="e.id" :data-id="e.id" class="ios-list-item !py-3 group">
                  <div class="drag-handle text-gray-300 mr-2"><i class="ph ph-dots-six-vertical text-lg"></i></div>
                  
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white text-lg shadow-sm mr-3 flex-shrink-0"
                       :class="getCategoryColor(e.category)">
                      <i :class="getCategoryIcon(e.category)"></i>
                  </div>

                  <div class="flex-1 flex flex-col gap-0.5 min-w-0">
                       <div class="flex justify-between items-center">
                           <div class="font-bold text-gray-900 truncate">{{ e.name }}</div>
                           <div class="font-bold text-gray-900 font-mono">
                               <span class="text-[10px] text-gray-400 font-sans mr-1">{{ e.currency }}</span>{{ formatNumber(e.amount, 0) }}
                           </div>
                       </div>
                       <div class="flex justify-between items-center text-[11px] text-gray-500">
                           <div class="flex gap-1 items-center">
                               <span>{{ e.payer }} 付款</span>
                               <span class="text-gray-300">•</span>
                               <span>{{ e.date.substring(5) }}</span>
                           </div>
                            <i class="ph" :class="e.paymentMethod === 'credit_card' ? 'ph-credit-card' : 'ph-coins'"></i>
                       </div>
                  </div>

                   <div class="action-btn-group ml-1">
                      <button @click="openExpenseModal(e)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                       <button @click="removeExpense(e.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                   </div>
             </div>
             <div v-if="filteredExpenses.length === 0" class="py-10 text-center text-gray-400 text-sm">無紀錄</div>
          </div>
      </div>

      <div v-if="currentTab === '準備'" class="animate-fade-in">
        <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">準備清單</h3>
        <ul class="space-y-2" id="sortable-pre-notes">
            <li v-for="note in preTripNotes" :key="note.id" :data-id="note.id" class="ios-list-item">
                <div class="drag-handle text-gray-300 mr-2"><i class="ph ph-dots-six-vertical text-lg"></i></div>
                <div class="flex items-center gap-3.5 flex-1 min-w-0">
                    <div @click="togglePreNoteDone(note.id)" class="cursor-pointer">
                         <i class="ph text-2xl transition-colors" :class="note.isDone ? 'ph-check-circle-fill text-[#007AFF]' : 'ph-circle text-gray-300'"></i>
                    </div>
                    <span class="font-medium text-[16px]" :class="{'line-through text-gray-400': note.isDone}">{{ note.name }}</span>
                </div>
                <div class="action-btn-group">
                    <button @click.stop="removePreNote(note.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                </div>
            </li>
        </ul>
        <div class="mt-4 flex gap-2">
            <input v-model="newPreNote" @keyup.enter="addPreNote" class="ios-input shadow-sm" placeholder="新增準備項目...">
            <button @click="addPreNote" class="w-12 h-12 flex items-center justify-center bg-[#007AFF] text-white rounded-xl shadow-lg active:scale-95"><i class="ph ph-plus text-xl"></i></button>
        </div>
      </div>

      <div v-if="currentTab === '購物'" class="animate-fade-in">
         <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">購物清單</h3>
         <ul class="space-y-3" id="sortable-shopping">
             <li v-for="item in shoppingList" :key="item.id" :data-id="item.id" class="ios-list-item !items-start">
                 <div class="drag-handle text-gray-300 mr-2 mt-1"><i class="ph ph-dots-six-vertical text-lg"></i></div>
                 <div class="flex-1 min-w-0">
                     <div class="flex items-center gap-3 mb-1">
                         <div @click="item.isDone = !item.isDone" class="cursor-pointer">
                             <i class="ph text-2xl" :class="item.isDone ? 'ph-check-circle-fill text-[#34C759]' : 'ph-circle text-gray-300'"></i>
                         </div>
                         <div class="font-bold text-[16px]" :class="{'line-through text-gray-400': item.isDone}">{{ item.name }}</div>
                     </div>
                     <div v-if="item.imageURL" class="mt-2 ml-9">
                         <img :src="item.imageURL" @click="openImageViewer(item.imageURL)" class="w-20 h-20 object-cover rounded-lg border border-gray-200 shadow-sm cursor-zoom-in">
                     </div>
                 </div>
                 <div class="action-btn-group self-start mt-1">
                     <button @click.stop="openShoppingModal(item)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                     <button @click.stop="removeShoppingItem(item.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                 </div>
             </li>
         </ul>
         <button @click="openShoppingModal()" class="mt-4 w-full h-12 rounded-xl bg-white text-[#007AFF] font-bold shadow-sm flex items-center justify-center gap-2">
             <i class="ph ph-plus"></i> 新增購物
         </button>
      </div>
      
       <div v-if="currentTab === '資訊'" class="animate-fade-in">
           <div class="grid grid-cols-2 gap-3" id="sortable-info">
               <div v-for="info in infoList" :key="info.id" :data-id="info.id" class="ios-card p-4 flex flex-col justify-between min-h-[140px]" @click="openInfoModal(info)">
                   <div>
                       <div class="font-bold text-lg leading-tight mb-2">{{ info.title }}</div>
                       <div class="text-xs text-gray-500 line-clamp-3">{{ info.note }}</div>
                   </div>
                   <div class="flex justify-between items-end mt-2">
                       <i v-if="info.imageURL" class="ph ph-image text-gray-400"></i>
                       <span v-else></span>
                       <button @click.stop="removeInfo(info.id)" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash text-lg"></i></button>
                   </div>
               </div>
               <button @click="openInfoModal()" class="ios-card p-4 flex flex-col items-center justify-center min-h-[140px] text-gray-400 hover:text-[#007AFF] transition">
                   <i class="ph ph-plus text-3xl mb-1"></i>
                   <span class="text-xs font-bold">新增筆記</span>
               </button>
           </div>
       </div>

    </main>

    <nav class="fixed bottom-6 left-0 right-0 z-30 px-3 pointer-events-none">
      <div class="iphone-dock w-full max-w-[380px] mx-auto pointer-events-auto">
        <button @click="currentTab='準備'" class="dock-item group" :class="{'active': currentTab==='準備'}">
            <i class="ph ph-list-checks text-[26px] mb-1"></i>
            <span class="text-[9px] font-medium tracking-wide">準備</span>
        </button>
        <button @click="currentTab='行程'" class="dock-item group" :class="{'active': currentTab==='行程'}">
            <i class="ph ph-map-pin text-[26px] mb-1"></i>
            <span class="text-[9px] font-medium tracking-wide">行程</span>
        </button>
        <button @click="currentTab='記帳'" class="dock-item group" :class="{'active': currentTab==='記帳'}">
            <i class="ph ph-wallet text-[26px] mb-1"></i>
            <span class="text-[9px] font-medium tracking-wide">記帳</span>
        </button>
        <button @click="currentTab='購物'" class="dock-item group" :class="{'active': currentTab==='購物'}">
            <i class="ph ph-bag text-[26px] mb-1"></i>
            <span class="text-[9px] font-medium tracking-wide">購物</span>
        </button>
        <button @click="currentTab='資訊'" class="dock-item group" :class="{'active': currentTab==='資訊'}">
            <i class="ph ph-info text-[26px] mb-1"></i>
            <span class="text-[9px] font-medium tracking-wide">資訊</span>
        </button>
      </div>
    </nav>

    <transition name="fade">
        <div v-if="expenseModalOpen" class="fixed inset-0 modal-backdrop flex items-center justify-center p-3" @click.self="closeExpenseModal">
            <div class="ios-modal-container max-w-[360px]">
                 <div class="ios-modal-header flex justify-between items-center px-4">
                     <button @click="closeExpenseModal" class="text-[#007AFF] font-normal">取消</button>
                     <span>{{ newExpense.id ? '編輯消費' : '新增消費' }}</span>
                     <div class="w-8"></div> </div>
                 
                 <div class="ios-modal-body !p-0 bg-gray-50">
                     <div class="p-4 pb-0">
                         <input v-model="newExpense.name" class="ios-input text-center font-bold mb-3" placeholder="項目名稱 (如: 晚餐)">
                         
                         <div class="calc-display">
                            <span class="text-xs text-gray-500 mr-auto self-start mt-1 font-sans">{{ newExpense.currency }}</span>
                            {{ calcDisplay }}
                         </div>

                         <div class="flex gap-3 overflow-x-auto no-scrollbar mb-4 py-1">
                             <button v-for="cat in categories" :key="cat.name"
                                 @click="newExpense.category = cat.name"
                                 class="flex flex-col items-center gap-1 flex-shrink-0 transition-all opacity-60 hover:opacity-100"
                                 :class="{'!opacity-100 scale-110': newExpense.category === cat.name}">
                                 <div class="cat-icon-box" :class="cat.bgClass"><i :class="cat.icon"></i></div>
                                 <span class="text-[9px] font-bold text-gray-500">{{ cat.name }}</span>
                             </button>
                         </div>
                     </div>

                     <div class="bg-white rounded-t-3xl p-5 shadow-inner space-y-4">
                         <div class="flex gap-2">
                             <div class="flex-1">
                                 <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">誰付錢 (代付)</label>
                                 <select v-model="newExpense.payer" class="ios-input h-10 py-1 text-sm bg-gray-100">
                                     <option v-for="m in members" :value="m">{{ m }}</option>
                                 </select>
                             </div>
                             <div class="flex-[2]">
                                 <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">分給誰 (參與者)</label>
                                 <div class="flex gap-1 overflow-x-auto py-1">
                                     <button v-for="m in members" :key="m" 
                                        @click="toggleInvolved(m)"
                                        class="px-2 py-1.5 rounded-lg text-xs font-bold border transition-colors whitespace-nowrap"
                                        :class="newExpense.involved.includes(m) ? 'bg-[#007AFF] text-white border-[#007AFF]' : 'bg-gray-50 text-gray-500 border-gray-200'">
                                        {{ m }}
                                     </button>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="keypad-grid">
                             <button @click="kp('7')" class="key-btn">7</button>
                             <button @click="kp('8')" class="key-btn">8</button>
                             <button @click="kp('9')" class="key-btn">9</button>
                             <button @click="kp('div')" class="key-btn op">÷</button>
                             
                             <button @click="kp('4')" class="key-btn">4</button>
                             <button @click="kp('5')" class="key-btn">5</button>
                             <button @click="kp('6')" class="key-btn">6</button>
                             <button @click="kp('mul')" class="key-btn op">×</button>
                             
                             <button @click="kp('1')" class="key-btn">1</button>
                             <button @click="kp('2')" class="key-btn">2</button>
                             <button @click="kp('3')" class="key-btn">3</button>
                             <button @click="kp('sub')" class="key-btn op">-</button>
                             
                             <button @click="kp('C')" class="key-btn grey">C</button>
                             <button @click="kp('0')" class="key-btn">0</button>
                             <button @click="kp('.')" class="key-btn">.</button>
                             <button @click="kp('add')" class="key-btn op">+</button>
                         </div>
                         
                         <div class="flex gap-2 pt-2">
                             <select v-model="newExpense.currency" class="ios-input !w-20 text-center font-bold bg-gray-100">
                                 <option>HKD</option><option>TWD</option><option>JPY</option>
                             </select>
                             <select v-model="newExpense.paymentMethod" class="ios-input !w-24 text-center text-sm bg-gray-100">
                                 <option value="cash">現金</option><option value="credit_card">信用卡</option>
                             </select>
                             <button @click="saveExpenseWithCalc" class="flex-1 btn-ios-primary h-12 text-lg">
                                 確定
                             </button>
                         </div>
                     </div>
                 </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="membersModalOpen" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4" @click.self="membersModalOpen = false">
            <div class="ios-modal-container">
                <div class="ios-modal-header">管理成員</div>
                <div class="ios-modal-body">
                    <div class="space-y-2 mb-4">
                        <div v-for="(m, i) in members" :key="i" class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-200">
                            <span class="font-bold text-gray-800">{{ m }}</span>
                            <button v-if="members.length > 1" @click="removeMember(i)" class="text-red-500 bg-red-50 p-1.5 rounded-full"><i class="ph ph-minus"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newMemberName" placeholder="輸入名字..." class="ios-input bg-white">
                        <button @click="addMember" class="w-12 btn-ios-primary"><i class="ph ph-plus"></i></button>
                    </div>
                </div>
                 <div class="ios-modal-footer">
                    <button @click="membersModalOpen = false" class="btn-ios-primary">完成</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="shoppingModalOpen" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4" @click.self="shoppingModalOpen = false">
            <div class="ios-modal-container">
                 <div class="ios-modal-header">購物項目</div>
                 <div class="ios-modal-body space-y-4">
                     <input v-model="newShoppingItem.name" class="ios-input" placeholder="名稱">
                     <input v-model="newShoppingItem.imageURL" class="ios-input text-xs" placeholder="圖片網址">
                     <button @click="newShoppingItem.isDone = !newShoppingItem.isDone" class="w-full py-3 bg-gray-100 rounded-xl font-bold text-gray-600">
                         {{ newShoppingItem.isDone ? '標記為未買' : '標記為已買' }}
                     </button>
                 </div>
                 <div class="ios-modal-footer">
                     <button @click="shoppingModalOpen = false" class="btn-ios-cancel">取消</button>
                     <button @click="saveShoppingItem" class="btn-ios-primary">儲存</button>
                 </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="itineraryModalOpen" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4" @click.self="itineraryModalOpen = false">
             <div class="ios-modal-container">
                <div class="ios-modal-header">行程詳情</div>
                <div class="ios-modal-body space-y-4">
                    <input v-model="newItineraryItem.title" class="ios-input" placeholder="標題">
                    <div class="flex gap-2">
                        <input v-model="newItineraryItem.time" type="time" class="ios-input">
                        <select v-model="newItineraryItem.dayIndex" class="ios-input">
                            <option v-for="(d, i) in days" :key="i" :value="i">{{ d.week }}</option>
                        </select>
                    </div>
                    <textarea v-model="newItineraryItem.note" class="ios-input" rows="3" placeholder="備註"></textarea>
                </div>
                <div class="ios-modal-footer">
                     <button @click="itineraryModalOpen = false" class="btn-ios-cancel">取消</button>
                     <button @click="saveItineraryItem" class="btn-ios-primary">儲存</button>
                </div>
             </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="infoModalOpen" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4" @click.self="infoModalOpen = false">
            <div class="ios-modal-container">
                <div class="ios-modal-header">資訊筆記</div>
                <div class="ios-modal-body space-y-4">
                    <input v-model="newInfoItem.title" class="ios-input" placeholder="標題">
                    <textarea v-model="newInfoItem.note" class="ios-input h-32" placeholder="內容..."></textarea>
                    <input v-model="newInfoItem.imageURL" class="ios-input text-xs" placeholder="圖片連結 (選填)">
                </div>
                <div class="ios-modal-footer">
                     <button @click="infoModalOpen = false" class="btn-ios-cancel">取消</button>
                     <button @click="saveInfoItem" class="btn-ios-primary">儲存</button>
                </div>
            </div>
        </div>
    </transition>

    <div v-if="imageViewer.open" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-2" @click="imageViewer.open = false">
        <img :src="imageViewer.url" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl">
    </div>

  </div> <script>
    const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi'; // Kept generic
    const TRIP_ID = 'taipei_trip2025_v5'; // New ID for v5 structure
    const CURRENCY_RATES = { 'HKD': 1, 'JPY': 0.052, 'USD': 7.8 };
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
      setup() {
        const appVersion = ref('v5.0.1');
        const syncState = ref('loading');
        const syncStatusText = computed(() => ({ 'synced': '已同步', 'saving': '儲存...', 'loading': '載入...', 'error': '離線' }[syncState.value]));
        
        // --- State ---
        const currentTab = ref('準備');
        const selectedDay = ref(0);
        const days = reactive([
           { date: '15', week: 'Mon', type: 'flight-out' },
           { date: '16', week: 'Tue', type: 'normal' },
           { date: '17', week: 'Wed', type: 'normal' },
           { date: '18', week: 'Thu', type: 'flight-return' },
        ]);
        
        // --- Data Models ---
        const members = ref(['我', '旅伴']); // Default members
        const membersModalOpen = ref(false);
        const newMemberName = ref('');

        const itinerary = reactive([[], [], [], []]);
        const sortedItinerary = computed(() => itinerary[selectedDay.value] || []);
        
        const shoppingList = ref([]);
        const expenses = ref([]);
        const infoList = ref([]);
        const preTripNotes = ref([]);
        
        const flights = ref([
            { id: 'outbound', type: 'outbound', status: 'On Time', fromCode: 'HKG', toCode: 'TPE', depTime: '12:45', arrTime: '14:45', code: 'CX400' },
            { id: 'return', type: 'return', status: 'Scheduled', fromCode: 'TPE', toCode: 'HKG', depTime: '17:00', arrTime: '18:55', code: 'CX443' }
        ]);
        const activeFlight = computed(() => selectedDay.value === 3 ? flights.value[1] : flights.value[0]);
        const shouldShowFlightCard = computed(() => ['flight-out', 'flight-return'].includes(days[selectedDay.value]?.type) && currentTab.value === '行程');

        // --- Weather & Rates ---
        const weather = reactive({ temp: 24, feelsLike: 26, rain: 10, desc: '多雲', code: 3 });
        const rate = ref(4.15);
        const formattedRate = computed(() => rate.value.toFixed(2));
        const weatherIconClass = computed(() => 'ph-cloud-sun'); 

        // --- Expenses Advanced ---
        const expenseFilter = ref('all');
        const expenseModalOpen = ref(false);
        const calcDisplay = ref('0'); // Calculator Screen
        const calcOp = ref(null); // Current Operator
        const calcPrev = ref(null); // Previous Number
        const lastPayer = ref(members.value[0]);
        
        const newExpense = reactive({ 
            id: null, name: '', amount: 0, currency: 'TWD', 
            category: '餐飲', paymentMethod: 'cash', date: '', 
            payer: '', involved: [] 
        });

        const categories = [
            { name: '門票', icon: 'ph-ticket', bgClass: 'bg-grad-ticket' },
            { name: '交通', icon: 'ph-train', bgClass: 'bg-grad-transport' },
            { name: '購物', icon: 'ph-bag', bgClass: 'bg-grad-shopping' },
            { name: '餐飲', icon: 'ph-hamburger', bgClass: 'bg-grad-dining' },
            { name: '娛樂', icon: 'ph-confetti', bgClass: 'bg-grad-entertainment' },
            { name: '住宿', icon: 'ph-bed', bgClass: 'bg-grad-stay' },
            { name: '服務', icon: 'ph-hand-heart', bgClass: 'bg-grad-service' },
            { name: '其他', icon: 'ph-dots-three-circle', bgClass: 'bg-grad-other' }
        ];

        function getCategoryIcon(name) { return categories.find(c => c.name === name)?.icon || 'ph-star'; }
        function getCategoryColor(name) { return categories.find(c => c.name === name)?.bgClass || 'bg-gray-400'; }

        // --- Calculator Logic ---
        function kp(key) {
            if (['add','sub','mul','div'].includes(key)) {
                if(calcOp.value) calculate(); // Chain calc
                calcPrev.value = parseFloat(calcDisplay.value);
                calcDisplay.value = '0';
                calcOp.value = key;
                return;
            }
            if (key === 'C') { calcDisplay.value = '0'; calcOp.value = null; calcPrev.value = null; return; }
            if (key === '.') { if(!calcDisplay.value.includes('.')) calcDisplay.value += '.'; return; }
            
            // Numbers
            if (calcDisplay.value === '0') calcDisplay.value = key;
            else calcDisplay.value += key;
        }

        function calculate() {
            if (!calcOp.value || calcPrev.value === null) return;
            const curr = parseFloat(calcDisplay.value);
            let res = 0;
            if (calcOp.value === 'add') res = calcPrev.value + curr;
            if (calcOp.value === 'sub') res = calcPrev.value - curr;
            if (calcOp.value === 'mul') res = calcPrev.value * curr;
            if (calcOp.value === 'div') res = calcPrev.value / curr;
            calcDisplay.value = String(Number(res.toFixed(2))); // Clean decimals
            calcOp.value = null;
            calcPrev.value = null;
        }

        // --- Settlement Logic ---
        const settlementResult = computed(() => {
            const balances = {};
            members.value.forEach(m => balances[m] = 0);
            
            const centerPerson = members.value[0]; 

            expenses.value.forEach(e => {
                let amtHKD = Number(e.amount);
                if (e.currency === 'TWD') amtHKD /= rate.value;
                if (e.currency === 'JPY') amtHKD *= 0.052;
                
                const payer = e.payer || centerPerson;
                const involved = (e.involved && e.involved.length > 0) ? e.involved : members.value;
                const splitAmt = amtHKD / involved.length;

                if (balances[payer] !== undefined) balances[payer] += amtHKD;
                
                involved.forEach(p => {
                    if (balances[p] !== undefined) balances[p] -= splitAmt;
                });
            });

            return Object.keys(balances).map(k => ({
                name: k,
                amount: balances[k]
            })).filter(x => Math.abs(x.amount) > 1); 
        });

        // --- Modals & Actions ---
        function openExpenseModal(item) {
            calcDisplay.value = item ? String(item.amount) : '0';
            calcOp.value = null;
            Object.assign(newExpense, item ? deepClone(item) : {
                id: null, name: '', amount: 0, currency: 'TWD', category: '餐飲',
                paymentMethod: 'cash', date: new Date().toISOString().split('T')[0],
                payer: lastPayer.value, involved: [...members.value] // Default all
            });
            expenseModalOpen.value = true;
        }

        function saveExpenseWithCalc() {
            if (calcOp.value) calculate(); // Finish pending math
            newExpense.amount = parseFloat(calcDisplay.value);
            if (!newExpense.name) newExpense.name = newExpense.category;
            
            const item = { ...newExpense, id: newExpense.id || generateId() };
            const idx = expenses.value.findIndex(e => e.id === item.id);
            if (idx !== -1) expenses.value.splice(idx, 1, item);
            else expenses.value.unshift(item);
            
            lastPayer.value = newExpense.payer; 
            expenseModalOpen.value = false;
            saveAll();
        }

        function toggleInvolved(m) {
            const idx = newExpense.involved.indexOf(m);
            if (idx > -1) newExpense.involved.splice(idx, 1);
            else newExpense.involved.push(m);
        }

        function addMember() {
            if (newMemberName.value && !members.value.includes(newMemberName.value)) {
                members.value.push(newMemberName.value);
                newMemberName.value = '';
                saveAll();
            }
        }
        function removeMember(i) {
            members.value.splice(i, 1);
            saveAll();
        }

        // --- Standard Logic ---
        const itineraryModalOpen = ref(false);
        const newItineraryItem = reactive({});
        const quickItinerary = reactive({time:'', title:''});
        function openItineraryModal(it) { Object.assign(newItineraryItem, it || {id:null, dayIndex:selectedDay.value}); itineraryModalOpen.value=true; }
        function saveItineraryItem() { 
            const item = {...newItineraryItem, id: newItineraryItem.id||generateId()};
            const list = itinerary[item.dayIndex];
            const idx = list.findIndex(x=>x.id===item.id);
            if(idx!==-1) list.splice(idx,1,item); else list.push(item);
            itineraryModalOpen.value=false; saveAll();
        }
        function addQuickItinerary() {
            if(!quickItinerary.title) return;
            itinerary[selectedDay.value].push({id:generateId(), time:quickItinerary.time, title:quickItinerary.title});
            quickItinerary.title=''; saveAll();
        }
        function removeItineraryItem(id) { 
            const idx = itinerary[selectedDay.value].findIndex(x=>x.id===id);
            if(idx!==-1) itinerary[selectedDay.value].splice(idx,1); saveAll();
        }

        // Shopping
        const shoppingModalOpen = ref(false);
        const newShoppingItem = reactive({});
        function openShoppingModal(it) { Object.assign(newShoppingItem, it||{id:null, isDone:false}); shoppingModalOpen.value=true; }
        function saveShoppingItem() {
            const item = {...newShoppingItem, id: newShoppingItem.id||generateId()};
            const idx = shoppingList.value.findIndex(x=>x.id===item.id);
            if(idx!==-1) shoppingList.value.splice(idx,1,item); else shoppingList.value.push(item);
            shoppingModalOpen.value=false; saveAll();
        }
        function removeShoppingItem(id) { shoppingList.value = shoppingList.value.filter(x=>x.id!==id); saveAll(); }

        // Info & Pre
        const infoModalOpen = ref(false);
        const newInfoItem = reactive({});
        function openInfoModal(it) { Object.assign(newInfoItem, it||{id:null}); infoModalOpen.value=true; }
        function saveInfoItem() {
             const item = {...newInfoItem, id: newInfoItem.id||generateId()};
             const idx = infoList.value.findIndex(x=>x.id===item.id);
             if(idx!==-1) infoList.value.splice(idx,1,item); else infoList.value.push(item);
             infoModalOpen.value=false; saveAll();
        }
        function removeInfo(id) { infoList.value = infoList.value.filter(x=>x.id!==id); saveAll(); }
        
        const newPreNote = ref('');
        function addPreNote() { if(newPreNote.value) { preTripNotes.value.push({id:generateId(), name:newPreNote.value, isDone:false}); newPreNote.value=''; saveAll(); }}
        function togglePreNoteDone(id) { const n = preTripNotes.value.find(x=>x.id===id); if(n) n.isDone=!n.isDone; saveAll(); }
        function removePreNote(id) { preTripNotes.value = preTripNotes.value.filter(x=>x.id!==id); saveAll(); }
        
        // Utils
        const totalExpense = computed(() => {
            let hkd = 0;
            expenses.value.forEach(e => {
                let amt = Number(e.amount);
                if(e.currency==='TWD') amt /= rate.value;
                if(e.currency==='JPY') amt *= 0.052;
                hkd += amt;
            });
            return { hkd, twd: hkd * rate.value };
        });
        
        const filteredExpenses = computed(() => {
            if(expenseFilter.value === 'all') return expenses.value;
            if(expenseFilter.value === 'credit') return expenses.value.filter(e => e.paymentMethod === 'credit_card');
            if(expenseFilter.value === 'cash') return expenses.value.filter(e => e.paymentMethod === 'cash');
            return expenses.value;
        });

        function formatNumber(n, d=0) { return Number(n).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d}); }
        function selectDay(i) { selectedDay.value = i; }
        function getStatusClass(s) { return s==='On Time'?'bg-[#34C759] text-white border-none':(s==='Delayed'?'bg-red-500 text-white border-none':'text-white'); }

        const imageViewer = reactive({open:false, url:''});
        function openImageViewer(u) { imageViewer.url=u; imageViewer.open=true; }

        // --- Backend Sync ---
        async function fetchCloud() {
            syncState.value = 'loading';
            const { data } = await supabaseClient.from('trip_data').select('content').eq('id', TRIP_ID).single();
            if(data?.content) {
                const c = data.content;
                if(c.itinerary) c.itinerary.forEach((d,i)=> itinerary[i] = d);
                if(c.shoppingList) shoppingList.value = c.shoppingList;
                if(c.expenses) expenses.value = c.expenses;
                if(c.infoList) infoList.value = c.infoList;
                if(c.preTripNotes) preTripNotes.value = c.preTripNotes;
                if(c.members) members.value = c.members; 
                syncState.value = 'synced';
            } else {
                syncState.value = 'synced'; 
            }
        }
        
        let debounceTimer;
        function saveAll() {
            clearTimeout(debounceTimer);
            syncState.value = 'saving';
            debounceTimer = setTimeout(async () => {
                const payload = {
                    updated_at: Date.now(),
                    itinerary, shoppingList: shoppingList.value, expenses: expenses.value,
                    infoList: infoList.value, preTripNotes: preTripNotes.value,
                    members: members.value 
                };
                await supabaseClient.from('trip_data').upsert({ id: TRIP_ID, content: payload });
                syncState.value = 'synced';
            }, 1000);
        }
        function forceReloadCloud() { fetchCloud(); }

        // Sortable Init Helper (Moved outside onMounted to avoid scope issues)
        const initSort = (id, list) => {
             const el = document.getElementById(id);
             if(el) Sortable.create(el, { handle:'.drag-handle', animation:150, onEnd:(e)=>{
                 const item = list.splice(e.oldIndex,1)[0]; list.splice(e.newIndex,0,item); saveAll();
             }});
        };

        onMounted(() => {
             fetchCloud();
             
             watch(currentTab, () => {
                 nextTick(() => {
                    if(currentTab.value==='行程') initSort('sortable-itinerary', itinerary[selectedDay.value]);
                    if(currentTab.value==='購物') initSort('sortable-shopping', shoppingList.value);
                    if(currentTab.value==='準備') initSort('sortable-pre-notes', preTripNotes.value);
                    if(currentTab.value==='記帳') initSort('sortable-expenses', expenses.value);
                 });
             });
        });

        return {
            appVersion, syncState, syncStatusText, forceReloadCloud,
            currentTab, days, selectedDay, selectDay, weather, weatherIconClass,
            flights, activeFlight, shouldShowFlightCard, getStatusClass,
            formattedRate, totalExpense, filteredExpenses, expenseFilter,
            
            // Lists
            sortedItinerary, shoppingList, infoList, preTripNotes,
            
            // Actions
            togglePreNoteDone, addPreNote, removePreNote, newPreNote,
            quickItinerary, addQuickItinerary, openItineraryModal,
            
            // Modals Logic
            members, membersModalOpen, newMemberName, addMember, removeMember,
            expenseModalOpen, newExpense, categories, openExpenseModal, saveExpenseWithCalc,
            toggleInvolved, kp, calcDisplay,
            
            shoppingModalOpen, newShoppingItem, openShoppingModal, saveShoppingItem, removeShoppingItem,
            infoModalOpen, newInfoItem, openInfoModal, saveInfoItem, removeInfo,
            itineraryModalOpen, newItineraryItem, saveItineraryItem, removeItineraryItem,
            
            // UI Helpers
            getCategoryIcon, getCategoryColor, formatNumber, settlementResult,
            imageViewer, openImageViewer, showLocationOnMap: (it) => { if(it.address) window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(it.address)); }
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
