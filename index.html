<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1.0,user-scalable=no" />
  <title>eMenu Taipei v2.01 â€” é›²ç«¯ç‰ˆ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.86);
      --card-radius: 18px;
    }
    html,body,#app { height:100%; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-color:#0f172a;
      margin:0;
    }
    /* hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    
    /* Animation */
    .fade-enter-active, .fade-leave-active { transition: opacity .25s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    
    .task-done { text-decoration: line-through; color: #9ca3af; }

    /* Dock Style */
    .iphone-dock {
        background: rgba(255,255,255,0.68);
        backdrop-filter: blur(10px);
        border-radius: 28px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.12);
        padding: 0.75rem 1.875rem;
        border: 1px solid rgba(255,255,255,0.35);
    }
    .iphone-dock button i { font-size: 1.875rem; }

    /* Card Style */
    .glass-card { 
        border-radius: var(--card-radius);
        background: rgba(255,255,255,0.88); 
        border: 1px solid rgba(255,255,255,0.35);
        padding: 0.75rem; 
        box-shadow: 0 8px 24px rgba(2,6,23,0.06);
    }

    /* FIX: Prevent iOS Zoom on focus */
    @media screen and (max-width: 768px) {
        input, select, textarea {
            font-size: 16px !important;
        }
    }
    
    /* Sync Status Indicator */
    .sync-status {
      transition: all 0.3s ease;
    }
    .sync-saving { color: #f59e0b; } /* Amber */
    .sync-synced { color: #10b981; } /* Emerald */
    .sync-error { color: #ef4444; } /* Red */
    .sync-loading { color: #3b82f6; } /* Blue */

    .rotate-icon {
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div id="app" class="relative min-h-screen flex flex-col">

    <div class="absolute inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover opacity-100" alt="Taipei Background">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-100/75 via-slate-100/55 to-slate-200/85"></div>
    </div>

    <main class="relative z-10 flex-1 overflow-y-auto no-scrollbar pb-safe pt-6 px-4">

      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">eMenu Taipei <span class="ml-1 text-sm">ğŸ‡¹ğŸ‡¼</span></h1>
          <div class="flex items-center gap-2 mt-1">
            <p class="text-xs text-gray-500">å°åŒ— 12/15 â€” 12/18 <span class="opacity-50 ml-1 text-[10px]">{{ appVersion }}</span></p>
            
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1 bg-white/60 px-2 py-0.5 rounded-full border border-gray-200">
                    <div class="w-2 h-2 rounded-full" 
                        :class="{
                            'bg-emerald-500': syncState === 'synced', 
                            'bg-yellow-500 animate-pulse': syncState === 'saving', 
                            'bg-blue-500 animate-pulse': syncState === 'loading',
                            'bg-red-500': syncState === 'error'
                        }"></div>
                    <span class="text-[10px] font-medium sync-status" 
                        :class="{
                            'sync-synced': syncState === 'synced', 
                            'sync-saving': syncState === 'saving', 
                            'sync-loading': syncState === 'loading',
                            'sync-error': syncState === 'error'
                        }">
                        {{ syncStatusText }}
                    </span>
                </div>
                <button @click="forceReloadCloud" class="bg-white/60 p-1 rounded-full border border-gray-200 text-gray-500 active:bg-gray-200" title="ç«‹å³åŒæ­¥">
                    <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
                </button>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-bold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-md border border-emerald-200 inline-block">å³æ™‚åŒ¯ç‡</div>
          <div class="text-xs font-bold text-gray-600 mt-1">
            1 TWD â‰ˆ <span class="text-emerald-600 text-sm">{{ formattedRate }}</span> HKD
            <div class="text-[10px] text-gray-400">æ›´æ–°ï¼š{{ lastRateUpdateLabel }}</div>
          </div>
        </div>
      </div>

      <div class="mb-5">
        <div class="flex justify-between gap-2 overflow-x-auto no-scrollbar pb-2">
          <button @click="currentTab = 'è¡Œå‰'" 
                  class="flex-shrink-0 w-[20%] min-w-[72px] h-20 rounded-xl flex flex-col items-center justify-center text-xs font-semibold transition-transform"
                  :class="currentTab === 'è¡Œå‰' ? 'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 border border-white/40 text-gray-600'">
             <i class="ph ph-list text-xl mb-1"></i>
             <span>è¡Œå‰</span>
          </button>
          
          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = 'è¡Œç¨‹'"
                  class="flex-shrink-0 w-[22%] min-w-[72px] h-20 rounded-xl flex flex-col items-center justify-center transition-transform"
                  :class="selectedDay === i && currentTab === 'è¡Œç¨‹' ? 'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 text-gray-600 border border-white/40'">
            <span class="text-[10px] font-semibold text-sky-600/90 mb-0.5">Day {{ i + 1 }}</span>
            <span class="text-[12px] font-medium">{{ d.week }}</span>
            <span class="text-base font-bold mt-0.5">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div class="space-y-4 mb-4">
        <div class="glass-card">
          <div class="flex items-center mb-2">
             <i class="ph ph-map-pin-simple-area text-sm text-gray-500 mr-1"></i>
             <span class="text-xs font-bold text-gray-600">å°åŒ—å¸‚</span>
          </div>
          <div class="flex h-24">
            <div class="flex-1 flex items-center justify-start">
              <div class="text-[64px] font-bold text-gray-800 leading-none">{{ weather.temp }}Â°</div>
            </div>
            <div class="flex-shrink-0 w-24 flex items-center justify-center">
                <i :class="weatherIconClass" class="text-[64px] text-sky-500 leading-none"></i>
            </div>
            <div class="flex-shrink-0 w-32 flex flex-col justify-center items-end text-right">
                <div class="text-base text-gray-600 font-bold mb-1">{{ weather.desc }}</div>
                <div class="text-xs text-gray-500">é™é›¨æ©Ÿç‡ {{ weather.rain }}%</div>
            </div>
          </div>
        </div>

        <transition name="fade">
          <div v-if="shouldShowFlightCard" 
               class="rounded-2xl p-4 text-white shadow-lg relative overflow-hidden" 
               style="background: linear-gradient(135deg,#60a5fa 0%,#2dd4bf 100%);">
              <div class="flex justify-between items-center mb-3 relative z-10">
                <div class="text-xs font-bold bg-white/20 px-2 py-1 rounded">FLIGHT</div>
                <div class="text-xs text-right">
                    <div class="font-mono font-semibold text-lg">{{ activeFlight.depTime }}</div>
                    <div class="text-xs opacity-80 mt-1">Arr. {{ activeFlight.arrTime }}</div>
                </div>
              </div>
              <div class="flex items-center justify-between relative z-10">
                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">from</div>
                  <div class="text-3xl font-bold tracking-widest">{{ activeFlight.fromCode }}</div>
                  <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.fromTerminal }}</div>
                </div>
                <div class="flex-1 px-4 text-center">
                  <i class="ph ph-airplane-tilt text-2xl"></i>
                  <div class="h-0.5 bg-white/30 my-3"></div>
                  <div class="text-xs opacity-75">{{ activeFlight.note }}</div>
                </div>
                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">to</div>
                  <div class="text-3xl font-bold tracking-widest">{{ activeFlight.toCode }}</div>
                   <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.toTerminal }}</div>
                </div>
              </div>
              <div class="mt-4 flex justify-between items-center relative z-10">
                <div class="text-sm">{{ activeFlight.code }} â€” {{ activeFlight.title }}</div>
                <div class="bg-white text-sky-600 px-3 py-1 rounded-full text-xs font-bold">å·²ç¢ºèª</div>
              </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="selectedMapLocation" class="glass-card !p-4 bg-white/95 border-2 border-sky-200 relative">
                <button @click="selectedMapLocation = null" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                    <i class="ph ph-x text-lg"></i>
                </button>
                <div class="mb-4 pr-6">
                    <div class="flex items-center gap-2 mb-1">
                         <i class="ph ph-map-pin-fill text-red-500 text-xl"></i>
                         <h4 class="text-lg font-bold text-gray-800">{{ selectedMapLocation.title }}</h4>
                    </div>
                    <p class="text-sm text-gray-500 pl-7">{{ selectedMapLocation.address }}</p>
                </div>
                <div class="flex justify-center gap-3">
                    <a :href="generateMapLink(selectedMapLocation.address, 'search')" target="_blank"
                       class="flex-1 max-w-[200px] py-3 px-2 flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 rounded-xl font-bold shadow-sm active:scale-95 transition text-sm">
                        <i class="ph ph-map-trifold text-lg text-blue-500"></i>
                        Google åœ°åœ–
                    </a>
                    <a :href="generateMapLink(selectedMapLocation.address, 'navigate')" target="_blank"
                       class="flex-1 max-w-[200px] py-3 px-2 flex items-center justify-center gap-2 bg-emerald-500 text-white rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition text-sm">
                        <i class="ph ph-navigation-arrow text-lg"></i>
                        é–‹å§‹å°èˆª
                    </a>
                </div>
            </div>
        </transition>
      </div>

      <div v-if="currentTab !== 'è³¼ç‰©' && currentTab !== 'è¡Œå‰'" class="flex justify-end mb-3">
        <button @click="openAddModal" class="bg-sky-600 text-white px-4 py-2 rounded-lg shadow active:scale-95 transition flex items-center gap-1">
            <i class="ph ph-plus-circle text-lg"></i>
            <span v-if="isFlightDay && currentTab === 'è¡Œç¨‹'">æ–°å¢èˆªç­</span>
            <span v-else>æ–°å¢</span>
        </button>
      </div>

      <div class="rounded-2xl p-3 bg-white/85 border border-white/30 backdrop-blur shadow">
        <div>

          <div v-if="currentTab === 'è¡Œå‰'">
            <h3 class="text-base font-bold mb-2">âœ… è¡Œå‰æº–å‚™æ¸…å–®</h3>
            <ul class="space-y-2">
              <li v-for="(note, i) in preTripNotes" :key="note.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <i class="ph text-xl cursor-pointer" 
                     :class="note.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="note.isDone = !note.isDone">
                  </i>
                  <span class="font-medium" :class="{'task-done': note.isDone, 'text-gray-900': !note.isDone}">{{ note.name }}</span>
                </div>
                <button class="text-red-500 text-base" @click="removePreNote(note.id)"><i class="ph ph-trash"></i></button>
              </li>
              <li v-if="preTripNotes.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">
                è«‹æ–°å¢è¡Œå‰æº–å‚™äº‹é …ï¼
              </li>
            </ul>
            <div class="mt-3">
              <label class="text-xs text-gray-600">æ–°å¢æº–å‚™äº‹é …</label>
              <div class="flex gap-2 mt-1">
                <input v-model="newPreNote" @keyup.enter="addPreNote" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="ä¾‹å¦‚ï¼šå…Œæ›å°å¹£">
                <button @click="addPreNote" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
              </div>
            </div>
          </div>

          <div v-if="currentTab === 'è¡Œç¨‹'">
            <h3 class="text-base font-bold mb-2">ä»Šæ—¥è¡Œç¨‹ â€” {{ days[selectedDay].label }}</h3>
            <ul class="space-y-2">
              <li v-for="(it, idx) in sortedItinerary" :key="it.id" 
                  @click="showLocationOnMap(it)"
                  :class="{'cursor-pointer hover:bg-sky-50 transition border-l-4 border-l-sky-400 pl-3': (it.address || '').trim() !== '', 'border-l-transparent': (it.address || '').trim() === ''}"
                  class="p-3 rounded-lg bg-white/80 border border-white/30 flex justify-between items-center relative overflow-hidden">
                
                <div class="flex-1">
                  <div class="font-medium text-gray-800">{{ it.title }}</div>
                  <div class="text-xs text-gray-500">{{ it.note }}</div>
                  <div v-if="(it.address || '').trim() !== ''" class="text-[10px] text-sky-500 mt-1 flex items-center">
                      <i class="ph ph-map-pin-line mr-1"></i> é»æ“Šå°èˆª
                  </div>
                </div>
     
                <div class="flex items-center gap-2">
                    <div class="text-sm font-bold text-gray-700 mr-2">{{ it.time || '--:--' }}</div>
                    <button @click.stop="openItineraryModal(it)" class="text-gray-400 text-lg hover:text-sky-600 transition p-1">
                      <i class="ph ph-pencil-simple"></i>
                    </button>
                    <button @click.stop="removeItineraryItem(it.id)" class="text-gray-400 text-lg hover:text-red-500 transition p-1">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
              </li>
            </ul>
            <p v-if="sortedItinerary.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">ä»Šæ—¥æš«ç„¡è¡Œç¨‹</p>

            <div v-if="isFlightDay" class="mt-4 pt-3 border-t border-gray-200/50">
               <label class="text-xs text-gray-600 font-bold mb-1 block">â• å¿«é€Ÿæ–°å¢è¡Œç¨‹</label>
               <div class="flex gap-2">
                   <input v-model="quickItinerary.time" type="time" class="w-20 p-2 rounded-lg border bg-white/70 text-base text-center">
                   <input v-model="quickItinerary.title" @keyup.enter="addQuickItinerary" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="è¡Œç¨‹åç¨±...">
                   <button @click="addQuickItinerary" class="px-3 bg-sky-600 text-white rounded-lg whitespace-nowrap">åŠ å…¥</button>
               </div>
            </div>
          </div>

          <div v-if="currentTab === 'è³¼ç‰©'">
            <h3 class="text-base font-bold mb-2">ğŸ›’ è³¼ç‰©æ¸…å–®</h3>
            <div class="flex justify-end mb-3">
                <button @click="openShoppingModal(null)" class="bg-sky-600 text-white px-3 py-1 rounded-lg text-sm font-medium">+ æ–°å¢é …ç›®</button>
            </div>
            <ul class="space-y-2">
              <li v-for="(item, i) in shoppingList" :key="item.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
               <div class="flex items-start gap-3 flex-1">
                  <i class="ph text-xl cursor-pointer mt-1 flex-shrink-0" 
                     :class="item.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="item.isDone = !item.isDone">
                  </i>
                  <div class="flex-1">
                    <div class="font-medium" :class="{'task-done': item.isDone, 'text-gray-900': !item.isDone}">{{ item.name }}</div>
                    <div v-if="item.imageURL" class="mt-2">
                        <a v-if="isInstagramLink(item.imageURL)" :href="item.imageURL" target="_blank" 
                           class="text-xs font-semibold text-pink-600 bg-pink-100 px-2 py-1 rounded inline-flex items-center gap-1">
                            <i class="ph ph-instagram-logo"></i> æŸ¥çœ‹è²¼æ–‡
                        </a>
                        <img v-else :src="item.imageURL" class="w-12 h-12 object-cover rounded border" alt="Item image">
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button @click="openShoppingModal(item)" class="text-gray-500 text-base hover:text-sky-600 transition"><i class="ph ph-pencil-simple"></i></button>
                    <button class="text-red-500 text-base" @click="removeShoppingItem(item.id)"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="shoppingList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">æ‚¨çš„è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„ï¼</li>
            </ul>
          </div>

          <div v-if="currentTab === 'è¨˜å¸³'">
            <h3 class="text-base font-bold mb-2">ğŸ’³ è¨˜å¸³</h3>
            <div class="space-y-2 mb-3">
                <div class="flex">
                    <input v-model="newExpense.name" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="æ¶ˆè²»åç¨± (ä¾‹å¦‚ï¼šé›…é¦™ç«é‹)">
                </div>
                <div class="flex gap-2">
                    <select v-model="newExpense.currency" class="w-24 p-2 rounded-lg border bg-white/70 text-base">
                        <option value="TWD">TWD</option>
                        <option value="HKD">HKD</option>
                        <option value="JPY">JPY</option>
                        <option value="USD">USD</option>
                    </select>
                    <input v-model.number="newExpense.amount" type="number" class="w-28 p-2 rounded-lg border bg-white/70 text-base" placeholder="é‡‘é¡">
                    <select v-model="newExpense.category" class="flex-1 p-2 rounded-lg border bg-white/70 text-base">
                        <option value="é£Ÿç‰©">é£Ÿç‰©</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <button @click="addExpense" class="w-full py-2 bg-sky-600 text-white rounded-lg">åŠ å…¥æ¶ˆè²»è¨˜éŒ„</button>
            </div>
            <div class="mb-3 p-3 rounded-lg bg-white/80 border flex justify-between items-center">
              <div class="text-sm text-gray-600">ç›®å‰ç¸½æ”¯å‡º (HKD)</div>
              <div class="font-bold text-lg">HKD {{ totalExpense }}</div>
            </div>
            <ul class="space-y-3">
              <li v-for="(e, i) in expenses" :key="e.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-start gap-3">
                  <i class="ph text-xl cursor-pointer" 
                     :class="e.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="toggleExpenseDone(e.id)"></i>
                  <div>
                    <div class="font-medium" :class="{'task-done': e.isDone}">{{ e.name }}</div>
                    <div class="text-xs text-gray-500">{{ e.category }} Â· {{ e.date }}</div>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="font-bold">{{ e.currency }} {{ e.amount }}</div>
                  <button @click="removeExpense(e.id)" class="text-red-500"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="expenses.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">æš«ç„¡è¨˜éŒ„</li>
            </ul>
          </div>

          <div v-if="currentTab === 'è³‡è¨Š'">
            <h3 class="text-base font-bold mb-2">â„¹ï¸ å¯¦ç”¨è³‡è¨Š</h3>
            <div class="flex justify-end mb-3">
                <button @click="openInfoModal(null)" class="bg-sky-600 text-white px-3 py-1 rounded-lg text-sm font-medium">+ æ–°å¢è³‡è¨Š</button>
            </div>
            <ul class="space-y-2">
              <li v-for="(it, idx) in infoList" :key="it.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-start gap-2 flex-1">
                  <i class="ph text-xl cursor-pointer mt-1 flex-shrink-0" 
                     :class="it.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="it.isDone = !it.isDone"></i>
                  <div class="flex-1">
                    <div class="font-medium" :class="{'task-done': it.isDone}">{{ it.title }}</div>
                    <div class="text-xs text-gray-500 break-words">{{ it.note }}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button @click="openInfoModal(it)" class="text-gray-500 text-base hover:text-sky-600 transition"><i class="ph ph-pencil-simple"></i></button>
                    <button class="text-red-500 text-sm" @click="removeInfo(it.id)"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="infoList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">æš«ç„¡è³‡è¨Šï¼Œè«‹æ–°å¢</li>
            </ul>
          </div>

        </div>
      </div>

      <div class="h-24 flex items-end justify-center pb-4">
        <div class="text-[10px] text-gray-400">Ver: {{ appVersion }}</div>
      </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 z-20 pb-safe px-4">
      <div class="iphone-dock flex justify-around items-center w-[90%] max-w-sm mx-auto p-2">
        <button @click="currentTab='è¡Œç¨‹'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='è¡Œç¨‹' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-map-pin"></i><span class="text-[10px] font-medium mt-0.5">è¡Œç¨‹</span></button>
        <button @click="currentTab='è¨˜å¸³'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='è¨˜å¸³' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-wallet"></i><span class="text-[10px] font-medium mt-0.5">è¨˜å¸³</span></button>
        <button @click="currentTab='è³¼ç‰©'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='è³¼ç‰©' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-shopping-bag"></i><span class="text-[10px] font-medium mt-0.5">è³¼ç‰©</span></button>
        <button @click="currentTab='è³‡è¨Š'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='è³‡è¨Š' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-info"></i><span class="text-[10px] font-medium mt-0.5">è³‡è¨Š</span></button>
      </div>
    </nav>
    
    <transition name="fade">
        <div v-if="flightModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeFlightModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newFlight.id ? 'ç·¨è¼¯èˆªç­' : 'æ–°å¢èˆªç­' }}</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-3">
                        <select v-model="newFlight.type" class="flex-1 p-2 rounded-lg border bg-white text-base">
                            <option value="outbound">å»ç¨‹ (HKG -> TPE)</option>
                            <option value="return">å›ç¨‹ (TPE -> HKG)</option>
                        </select>
                        <input v-model="newFlight.date" type="date" class="flex-1 p-2 rounded-lg border bg-white text-base">
                    </div>
                    <input v-model="newFlight.code" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="èˆªç­ä»£ç¢¼ (ä¾‹: CX400)">
                    <input v-model="newFlight.title" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="èˆªç­åç¨±/å‚™è¨»">
                    <div class="flex gap-3">
                        <input v-model="newFlight.fromCode" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="å‡ºç™¼ (HKG)">
                        <input v-model="newFlight.toCode" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="æŠµé” (TPE)">
                    </div>
                    <div class="flex gap-3">
                        <input v-model="newFlight.fromTerminal" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="å‡ºç™¼èˆªå»ˆ">
                        <input v-model="newFlight.toTerminal" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="æŠµé”èˆªå»ˆ">
                    </div>
                    <div class="flex gap-3">
                        <input v-model="newFlight.depTime" type="time" class="flex-1 p-2 rounded-lg border bg-white text-base">
                        <input v-model="newFlight.arrTime" type="time" class="flex-1 p-2 rounded-lg border bg-white text-base">
                    </div>
                    <textarea v-model="newFlight.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="2" placeholder="å‚™è¨»..."></textarea>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeFlightModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">å–æ¶ˆ</button>
                    <button @click="saveFlight" class="px-4 py-2 bg-sky-600 text-white rounded-lg">å„²å­˜</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="itineraryModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeItineraryModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newItineraryItem.id ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-3">
                        <input v-model="newItineraryItem.title" class="flex-1 p-2 rounded-lg border bg-white text-base" placeholder="æ¨™é¡Œ">
                        <input v-model="newItineraryItem.time" type="time" class="w-24 p-2 rounded-lg border bg-white text-base">
                    </div>
                    <input v-model="newItineraryItem.address" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Google Map åœ°å€ (é¸å¡«)">
                    <textarea v-model="newItineraryItem.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="3" placeholder="å‚™è¨»..."></textarea>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeItineraryModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">å–æ¶ˆ</button>
                    <button @click="saveItineraryItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg">å„²å­˜</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="shoppingModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeShoppingModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newShoppingItem.id ? 'ç·¨è¼¯è³¼ç‰©é …ç›®' : 'æ–°å¢è³¼ç‰©é …ç›®' }}</h3>
                <div class="space-y-3 text-sm">
                    <input v-model="newShoppingItem.name" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="é …ç›®åç¨±">
                    <input v-model="newShoppingItem.imageURL" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="åœ–ç‰‡ URL æˆ– Instagram é€£çµ">
                    <div class="flex items-center gap-3 mt-3">
                        <input type="checkbox" id="shopping-done" v-model="newShoppingItem.isDone" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded">
                        <label for="shopping-done" class="text-gray-900">å·²è³¼è²·</label>
                    </div>
                </div>
                 <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeShoppingModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">å–æ¶ˆ</button>
                    <button @click="saveShoppingItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg">å„²å­˜</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="infoModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeInfoModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newInfoItem.id ? 'ç·¨è¼¯å¯¦ç”¨è³‡è¨Š' : 'æ–°å¢å¯¦ç”¨è³‡è¨Š' }}</h3>
                <div class="space-y-3 text-sm">
                    <input v-model="newInfoItem.title" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="æ¨™é¡Œ">
                    <textarea v-model="newInfoItem.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="3" placeholder="å‚™è¨»å…§å®¹..."></textarea>
                    <div class="flex items-center gap-3 mt-3">
                        <input type="checkbox" id="info-done" v-model="newInfoItem.isDone" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded">
                        <label for="info-done" class="text-gray-900">å·²è™•ç†/ç¢ºèª</label>
                    </div>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeInfoModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">å–æ¶ˆ</button>
                    <button @click="saveInfoItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg">å„²å­˜</button>
                </div>
            </div>
        </div>
    </transition>

  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
    // ä¿®æ­£ï¼šç¢ºä¿åªæœ‰åœ¨ç‰©ä»¶æ²’æœ‰ id æ™‚æ‰ç”Ÿæˆ
    const initializeListWithIds = (list) => list.map(item => ({ ...item, id: item.id || generateId() })); 
    function isInstagramLink(url) {
        if (!url) return false;
        return /^(https?:\/\/(www\.)?instagram\.com\/(p|reel)\/)/i.test(url);
    }

    // --- SUPABASE SETUP ---
    // æ‚¨çš„æ–° Credentials (v251212-2.01)
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuQVVvKi'; // æ‚¨çš„ Key
    
    // åˆå§‹åŒ– Client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const TRIP_ID = 'shared_trip';

    createApp({
      setup(){
        const appVersion = 'v251212-2.01'; 
        const currentTab = ref('è¡Œå‰');
        
        // Sync Status UI
        const syncState = ref('synced'); // 'synced' | 'saving' | 'error' | 'loading'
        const syncStatusText = computed(() => {
            if(syncState.value === 'synced') return 'å·²åŒæ­¥';
            if(syncState.value === 'saving') return 'å„²å­˜ä¸­...';
            if(syncState.value === 'loading') return 'ä¸‹è¼‰ä¸­...';
            return 'åŒæ­¥å¤±æ•—';
        });

        const days = reactive([
          { week:'Mon', date:'15', label:'12/15 (ä¸€)', type: 'flight-out' },
          { week:'Tue', date:'16', label:'12/16 (äºŒ)', type: 'stay' },
          { week:'Wed', date:'17', label:'12/17 (ä¸‰)', type: 'stay' },
          { week:'Thu', date:'18', label:'12/18 (å››)', type: 'flight-return' }
        ]);
        const selectedDay = ref(0);

        const isFlightDay = computed(() => {
            const t = days[selectedDay.value].type;
            return t === 'flight-out' || t === 'flight-return';
        });

        const quickItinerary = reactive({ time: '', title: '' });

        // Initial Data Structure (ä¿ç•™åˆå§‹å€¼ï¼Œç¢ºä¿ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚æœ‰å…§å®¹)
        const initialItinerary = [
          [
            { title:'æŠµé”å°åŒ—ãƒ»å…¥ä½é…’åº—ã€ä¼‘æ¯', note:'è¥¿é–€ç”ºæ°¸å®‰æ£§', time:'', address:'å°åŒ—å¸‚è¬è¯å€ä¸­è¯è·¯ä¸€æ®µ52è™Ÿ' },
            { title:'è¥¿é–€ç”ºè¼•é¬†æ•£æ­¥', note:'æ‚ é–’è¡Œç¨‹', time:'18:00', address:'' },
            { title:'é›…é¦™çŸ³é ­ç«é‹ï¼ˆæ™šé¤ï¼‰', note:'å¿…åƒæ’éšŠåº—', time:'19:00', address:'å°åŒ—å¸‚è¬è¯å€æˆéƒ½è·¯152è™Ÿ' },
            { title:'å—æ©Ÿå ´å¤œå¸‚', note:'å®µå¤œ', time:'21:00', address:'å°åŒ—å¸‚ä¸­æ­£å€ä¸­è¯è·¯äºŒæ®µ307å··' },
            { title:'è¿”é…’åº—ä¼‘æ¯', note:'10:30 å‰ä¼‘æ¯', time:'23:00', address:'' }
          ],
          [
            { title:'åˆé¤ï¼šåƒæš‰éµè‚‰åº—', note:'ç¾é£Ÿ', time:'12:00', address:'108 å°ç£å°åŒ—å¸‚è¬è¯å€ä¸­è¯è·¯äºŒæ®µ420è™Ÿ' },
            { title:'Costco ä¸­å’Œåº—ï¼ˆçºŒæœƒï¼‹è²·æ‰‹ä¿¡ï¼‰', note:'è³¼ç‰©', time:'14:00', address:'æ–°åŒ—å¸‚ä¸­å’Œå€ä¸­å±±è·¯äºŒæ®µ347è™Ÿ' },
            { title:'æ™šé¤ï¼šé›æ¹¯æ¦®éºµé£Ÿé¤¨ï¼ˆ17:00 å¾Œï¼‰', note:'æ™šé¤', time:'17:30', address:'å°åŒ—å¸‚è¬è¯å€è¥¿æ˜Œè¡—202è™Ÿ' },
            { title:'è¯è¥¿è¡—å¤œå¸‚', note:'é€›å¤œå¸‚', time:'19:30', address:'å°åŒ—å¸‚è¬è¯å€è¯è¥¿è¡—' },
            { title:'èƒ–è€é—†èª æ„è‚‰ç²¥ï¼ˆå®µå¤œï¼‰', note:'å®µå¤œ', time:'22:00', address:'å°åŒ—å¸‚è¬è¯å€å»£å·è¡—253è™Ÿ' }
          ],
          [
            { title:'åˆé¤ï¼šæ¢å±±æ³Šå°ç± æ¹¯åŒ…', note:'ä¸­åˆ', time:'12:00', address:'å°åŒ—å¸‚è¬è¯å€å³¨çœ‰è¡—22è™Ÿ' },
            { title:'è¥¿é–€ç”ºè¡Œä¸‹ / Cafe ä¼‘æ¯', note:'æ‚ é–’åˆå¾Œ', time:'14:00', address:'' },
            { title:'å¯§å¤å¤œå¸‚', note:'æ™šé¤è‡ªç†', time:'18:30', address:'å°åŒ—å¸‚å¤§åŒå€å¯§å¤è·¯' },
            { title:'å›é…’åº—', note:'ä¼‘æ¯', time:'21:00', address:'' }
          ],
          [
            { title:'è¥¿é–€ç”ºè£œè²·æ‰‹ä¿¡', note:'è³¼ç‰©', time:'11:00', address:'' },
            { title:'é‡‘åœ’æ’éª¨ï¼ˆåˆé¤ï¼‰', note:'åˆé¤', time:'13:00', address:'å°åŒ—å¸‚è¬è¯å€æ¼¢ä¸­è¡—121-1è™Ÿ' },
            { title:'å‰å¾€æ©Ÿå ´ï¼ˆCX443ï¼‰', note:'æ­ä¹˜ CX443 å› HKG', time:'15:50', address:'å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´' }
          ]
        ];
        const itinerary = reactive(initialItinerary.map(dayItems => initializeListWithIds(dayItems).map(item => ({ ...item, address: item.address || '' }))));
        const sortedItinerary = computed(() => {
            const currentDayItinerary = itinerary[selectedDay.value];
            if (!currentDayItinerary || currentDayItinerary.length === 0) return [];
            return [...currentDayItinerary].sort((a, b) => {
                const timeA = a.time || '23:59';
                const timeB = b.time || '23:59';
                return timeA.localeCompare(timeB);
            });
        });

        // Map Module Logic
        const selectedMapLocation = ref(null);
        function showLocationOnMap(item) {
            if (item.address && item.address.trim() !== '') {
                selectedMapLocation.value = { title: item.title, address: item.address, id: item.id };
            } else {
                selectedMapLocation.value = null;
            }
        }
        // ä¿®æ­£åœ°åœ–é€£çµç”Ÿæˆé‚è¼¯
        function generateMapLink(address, type) {
            if (!address) return '#';
            const encodedAddress = encodeURIComponent(address);
            if (type === 'search') return `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            if (type === 'navigate') return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            return '#';
        }

        // Active Flight (computed)
        const flights = ref([
          { id: 'outbound', date:'2025-12-15', code:'CX400', depTime:'13:00', fromCode:'HKG', fromTerminal:'T1', toCode:'TPE', toTerminal:'T1', arrTime:'14:50', title:'ç”±é¦™æ¸¯é£›å¾€å°åŒ—', note:'èˆªç­å‰å¾€å°åŒ—', type: 'outbound' },
          { id: 'return', date:'2025-12-18', code:'CX443', depTime:'15:50', fromCode:'TPE', fromTerminal:'T1', toCode:'HKG', toTerminal:'T1', arrTime:'18:00', title:'ç”±å°åŒ—è¿”å›é¦™æ¸¯', note:'å›ç¨‹', type: 'return' }
        ]);
        const activeFlight = computed(() => {
          const dayType = days[selectedDay.value].type;
          if (dayType === 'flight-out') return flights.value.find(f => f.type === 'outbound');
          if (dayType === 'flight-return') return flights.value.find(f => f.type === 'return');
          return null;
        });
        const shouldShowFlightCard = computed(() => {
          const dayType = days[selectedDay.value].type;
          return (currentTab.value === 'è¡Œå‰' || currentTab.value === 'è¡Œç¨‹') && (dayType === 'flight-out' || dayType === 'flight-return');
        });

        // Modals Logic (ä¿æŒä¸è®Š)
        const itineraryModalOpen = ref(false);
        const newItineraryItem = reactive({ id: null, title: '', note: '', time: '', address: '', dayIndex: null });
        function resetItineraryModal() { Object.assign(newItineraryItem, { id: null, title: '', note: '', time: '', address: '', dayIndex: selectedDay.value });
        }
        function openItineraryModal(item = null) {
            resetItineraryModal();
            if (item) Object.assign(newItineraryItem, deepClone(item));
            newItineraryItem.dayIndex = selectedDay.value;
            itineraryModalOpen.value = true;
        }
        function closeItineraryModal() { itineraryModalOpen.value = false;
        }
        function saveItineraryItem() {
            if (!newItineraryItem.title.trim()) return;
            const dayItems = itinerary[newItineraryItem.dayIndex];
            const itemToSave = { 
                id: newItineraryItem.id || generateId(), 
                title: newItineraryItem.title.trim(), 
                note: newItineraryItem.note.trim(), 
                time: newItineraryItem.time.trim(),
                address: newItineraryItem.address.trim(),
            };
            const index = dayItems.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) dayItems.splice(index, 1, itemToSave);
            else dayItems.push(itemToSave);
            if (selectedMapLocation.value && selectedMapLocation.value.id === itemToSave.id) {
                 showLocationOnMap(itemToSave);
            }
            closeItineraryModal();
            saveAll();
        }
        function removeItineraryItem(idToRemove) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿ')) return;
            const dayItems = itinerary[selectedDay.value];
            const index = dayItems.findIndex(i => i.id === idToRemove);
            if (index !== -1) {
                dayItems.splice(index, 1);
                if (selectedMapLocation.value && selectedMapLocation.value.id === idToRemove) selectedMapLocation.value = null;
                saveAll();
            }
        }
        function addQuickItinerary(){
            if (!quickItinerary.title.trim()) return;
            const dayItems = itinerary[selectedDay.value];
            const itemToSave = {
                id: generateId(),
                title: quickItinerary.title.trim(),
                note: '',
                time: quickItinerary.time || '',
                address: ''
            };
            dayItems.push(itemToSave);
            quickItinerary.title = '';
            quickItinerary.time = '';
            saveAll();
        }

        const flightModalOpen = ref(false);
        const newFlight = reactive({ id: null, type: 'outbound', date: '', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
        function openFlightModal(flightId = null){
             Object.assign(newFlight, { id: null, type: 'outbound', date: days[selectedDay.value]?.date ? `2025-12-${days[selectedDay.value].date.padStart(2, '0')}` : '2025-12-15', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
             const dayType = days[selectedDay.value]?.type;
             if (dayType === 'flight-out') newFlight.type = 'outbound';
             else if (dayType === 'flight-return') newFlight.type = 'return';
             if(flightId){
                const flightToEdit = flights.value.find(f => f.id === flightId);
                if(flightToEdit){
                    Object.assign(newFlight, deepClone(flightToEdit));
                    newFlight.id = flightId;
                }
            }
            flightModalOpen.value = true;
        }
        function closeFlightModal(){ flightModalOpen.value = false;
        }
        function saveFlight(){
            if (!newFlight.code || !newFlight.depTime || !newFlight.type) return;
            const dateStr = new Date(newFlight.date).toISOString().split('T')[0];
            const flightToSave = { ...deepClone(newFlight), id: newFlight.type, date: dateStr };
            const index = flights.value.findIndex(f => f.id === newFlight.type);
            if (index !== -1) flights.value.splice(index, 1, flightToSave);
            else flights.value.push(flightToSave);
            const dayIndex = days.findIndex(d => d.date.padStart(2, '0') === new Date(dateStr).getDate().toString().padStart(2, '0'));
            if (dayIndex !== -1) days[dayIndex].type = newFlight.type;
            
            closeFlightModal();
            saveAll();
        }

        const shoppingModalOpen = ref(false);
        const newShoppingItem = reactive({ id: null, name: '', isDone: false, imageURL: '' });
        function openShoppingModal(item = null) {
            Object.assign(newShoppingItem, { id: null, name: '', isDone: false, imageURL: '' });
            if (item) Object.assign(newShoppingItem, deepClone(item));
            shoppingModalOpen.value = true;
        }
        function closeShoppingModal() { shoppingModalOpen.value = false;
        }
        function saveShoppingItem() {
            if (!newShoppingItem.name.trim()) return;
            const itemToSave = { ...deepClone(newShoppingItem), id: newShoppingItem.id || generateId() };
            const index = shoppingList.value.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) shoppingList.value.splice(index, 1, itemToSave);
            else shoppingList.value.push(itemToSave);
            closeShoppingModal();
            saveAll();
        }
        function removeShoppingItem(idToRemove) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è³¼ç‰©é …ç›®å—ï¼Ÿ')) return;
            const index = shoppingList.value.findIndex(i => i.id === idToRemove);
            if (index !== -1) { shoppingList.value.splice(index, 1); saveAll();
            }
        }

        const infoModalOpen = ref(false);
        const newInfoItem = reactive({ id: null, title: '', note: '', isDone: false });
        function openInfoModal(item = null) {
            Object.assign(newInfoItem, { id: null, title: '', note: '', isDone: false });
            if (item) Object.assign(newInfoItem, deepClone(item));
            infoModalOpen.value = true;
        }
        function closeInfoModal() { infoModalOpen.value = false;
        }
        function saveInfoItem() {
            if (!newInfoItem.title.trim()) return;
            const itemToSave = { ...deepClone(newInfoItem), id: newInfoItem.id || generateId() };
            const index = infoList.value.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) infoList.value.splice(index, 1, itemToSave);
            else infoList.value.push(itemToSave);
            closeInfoModal();
            saveAll();
        }
        function removeInfo(idToRemove) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è³‡è¨Šé …ç›®å—ï¼Ÿ')) return;
            const index = infoList.value.findIndex(i => i.id === idToRemove);
            if (index !== -1) { infoList.value.splice(index, 1); saveAll();
            }
        }

        // Lists
        const preTripNotes = ref(initializeListWithIds([
          { name:'å…Œæ›å°å¹£', isDone: true },
          { name:'ç¢ºèªä½å®¿é ç´„å–®', isDone: false },
          { name:'è³¼è²· SIM å¡', isDone: false },
          { name:'è­·ç…§å½±æœ¬å‚™ä»½', isDone: true }
        ]));
        const newPreNote = ref('');
        const shoppingList = ref(initializeListWithIds([
          { name:'é³³æ¢¨é…¥ (ä½³å¾·)', isDone: false, imageURL: '' },
          { name:'é¢è†œ (è—¥å¦åº—)', isDone: false, imageURL: '' },
          { name:'è‚‰ä¹¾', isDone: true, imageURL: '' }
        ]));
        const expenses = ref([
          { id: Date.now()+1, name:'é›…é¦™ç«é‹', amount: 300, category:'é£Ÿç‰©', date: '12/15', isDone:false, currency: 'TWD' },
          { id: Date.now()+2, name:'Taxi æ©Ÿå ´->é…’åº—', amount: 250, category:'äº¤é€š', date: '12/15', isDone:false, currency: 'TWD' }
        ]);
        const newExpense = reactive({ name:'', amount:null, currency:'TWD', category:'é£Ÿç‰©' });
        const infoList = ref(initializeListWithIds([
          { title:'è¥¿é–€ç”ºæ°¸å®‰æ£§ (é›»è©±)', note:'+886 2 2352 3090', isDone:false },
        ]));

        const totalExpense = computed(() => {
            const twdToHkdRate = Number(rate.value) || 0;
            return expenses.value.reduce((total, e) => {
                const amount = Number(e.amount) || 0;
                let convertedAmount = amount;
                if (e.currency === 'TWD' && twdToHkdRate > 0) {
                    convertedAmount = amount * twdToHkdRate;
                } else if (e.currency === 'HKD') {
                    convertedAmount = amount;
                } else {
                    // å°æ–¼å…¶ä»–å¹£ç¨® (JPY, USD)ï¼Œç”±æ–¼ç¼ºä¹å³æ™‚åŒ¯ç‡ï¼Œæš«æ™‚å¿½ç•¥æˆ–ä½¿ç”¨ 1:1 é ä¼°
                    // ç‚ºäº†ç©©å®šæ€§ï¼Œæˆ‘å€‘åªè¨ˆç®— TWD å’Œ HKD
                    return total;
                }
                return total + convertedAmount;
            }, 0).toFixed(2);
        });

        // Weather & Rate
        const weather = reactive({ temp:'--', desc:'è¼‰å…¥ä¸­...', rain:0, code:0 });
        const weatherIconClass = computed(()=>{
          const c = weather.code || 0;
          if (c>=95) return 'ph ph-cloud-lightning-rain';
          if (c>=80) return 'ph ph-cloud-lightning-rain';
          if (c>=50) return 'ph ph-cloud-rain';
          if (c>2) return 'ph ph-cloud';
          return 'ph ph-sun';
        });
        const rate = ref(null);
        const lastRateUpdate = ref(null);
        const formattedRate = computed(()=> rate.value !== null ? rate.value : '...');
        const lastRateUpdateLabel = computed(()=>{
          if (!lastRateUpdate.value) return 'â€”';
          return new Date(lastRateUpdate.value).toLocaleTimeString('zh-HK');
        });

        function selectDay(i){ selectedDay.value = i; selectedMapLocation.value = null; }
        function addPreNote(){ 
            if (!newPreNote.value.trim()) return; 
            preTripNotes.value.push({ id:generateId(), name:newPreNote.value.trim(), isDone:false }); 
            newPreNote.value=''; 
            saveAll(); 
        }
        function removePreNote(idToRemove){ 
            const index = preTripNotes.value.findIndex(n => n.id === idToRemove);
            if (index !== -1) { preTripNotes.value.splice(index,1); saveAll(); }
        }
        function addExpense(){
          if (!newExpense.name.trim() || !newExpense.amount) return;
          const d = new Date();
          const dateLabel = `${d.getMonth()+1}/${d.getDate()}`;
          expenses.value.unshift({ id: generateId(), name: newExpense.name.trim(), amount: Number(newExpense.amount), category: newExpense.category, date: dateLabel, isDone: false, currency: newExpense.currency });
          newExpense.name = ''; newExpense.amount = null; newExpense.currency = 'TWD'; newExpense.category = 'é£Ÿç‰©';
          saveAll();
        }
        function removeExpense(idToRemove){ 
            const index = expenses.value.findIndex(e => e.id === idToRemove);
            if (index !== -1) { expenses.value.splice(index,1); saveAll(); }
        }
        function toggleExpenseDone(idToToggle){ 
             const expense = expenses.value.find(e => e.id === idToToggle);
             if(expense) expense.isDone = !expense.isDone;
             saveAll(); 
        }

        function openAddModal(){
          if (currentTab.value === 'è¡Œå‰'){ 
             if (newPreNote.value) addPreNote();
             else { currentTab.value = 'è¡Œç¨‹'; }
          }
          else if (currentTab.value === 'è¡Œç¨‹'){ 
             if (isFlightDay.value) {
                 const flightId = activeFlight.value ? activeFlight.value.id : null; 
                 openFlightModal(flightId);
             } else {
                 openItineraryModal(null);
             }
          }
          else if (currentTab.value === 'è³¼ç‰©'){ openShoppingModal(null); }
          else if (currentTab.value === 'è¨˜å¸³'){ if (newExpense.name && newExpense.amount) addExpense(); }
          else if (currentTab.value === 'è³‡è¨Š'){ openInfoModal(null); }
        }

        async function fetchRate(){
          const API_URL = 'https://open.er-api.com/v6/latest/TWD';
          try {
            const res = await fetch(API_URL);
            if (!res.ok){ rate.value = null; return; }
            const data = await res.json();
            if (data && data.rates && data.rates.HKD){
              // ä¿®æ­£ï¼šç¢ºä¿é¡¯ç¤ºçš„åŒ¯ç‡æ˜¯ TWD æ›ç®—æˆ HKD (å³ 1 TWD = X HKD)
              rate.value = (1 / data.rates.TWD * data.rates.HKD).toFixed(3); 
              lastRateUpdate.value = new Date().toISOString();
            } else if (data && data.rates && data.rates.HKD) {
              rate.value = (data.rates.HKD).toFixed(3);
              lastRateUpdate.value = new Date().toISOString();
            }
          } catch(e){ console.warn('rate fail', e); rate.value = null; }
        }

        async function fetchWeather(){
          try {
            const lat = 25.0330, lon = 121.5654;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=precipitation_probability&timezone=Asia%2FTaipei`;
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.current_weather){
              weather.temp = Math.round(data.current_weather.temperature);
              weather.code = data.current_weather.weathercode || 0;
              weather.desc = describeWeather(weather.code);
              if (data.hourly && data.hourly.precipitation_probability){
                const nowTime = data.current_weather.time.slice(0, 13);
                const nowIdx = data.hourly.time.findIndex(t => t.startsWith(nowTime));
                const prob = (nowIdx >= 0) ? data.hourly.precipitation_probability[nowIdx] : (data.hourly.precipitation_probability[0] || 0);
                weather.rain = Math.round(prob);
              } else weather.rain = 0;
            }
          } catch(e){ console.warn('weather fail', e); weather.desc='ç„¡æ³•å–å¾—'; }
        }

        function describeWeather(code){
          if (code >= 95) return 'é›·æš´';
          if (code >= 80) return 'é™£é›¨';
          if (code >= 60) return 'æŒçºŒé™é›¨';
          if (code >= 50) return 'æ¯›æ¯›é›¨';
          if (code >= 40) return 'éœ§/å†°éœ§';
          if (code >= 30) return 'æ²™å¡µæš´';
          if (code >= 20) return 'å±€éƒ¨é™£é›¨';
          if (code > 2) return 'å¤šé›²';
          if (code === 2) return 'å±€éƒ¨å¤šé›²';
          return 'æ™´æœ—';
        }

        // --- CLOUD SYNC LOGIC (NO REALTIME) ---
        
        let debounceTimer = null;
        let isRemoteUpdate = false; 

        // 1. Save Data (Debounced Upsert)
        function saveAll(){
            if(isRemoteUpdate) return;
            
            syncState.value = 'saving';
            if (debounceTimer) clearTimeout(debounceTimer);

            debounceTimer = setTimeout(async () => {
                const payload = {
                    itinerary: JSON.parse(JSON.stringify(itinerary)),
                    preTripNotes: preTripNotes.value,
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    infoList: infoList.value,
                    flights: flights.value
                };
                
                try {
                    const { error } = await supabaseClient
                        .from('trip_data')
                        .upsert({ id: TRIP_ID, content: payload });

                    if (error) throw error;
                    syncState.value = 'synced';
                } catch (e) {
                    console.error('Save failed', e);
                    syncState.value = 'error';
                }
            }, 1000); 
        }

        // 2. Fetch Data (Pull)
        async function fetchCloudData(isAuto = true) {
            // å¦‚æœæ­£åœ¨å„²å­˜ï¼Œå…ˆä¸ä¸‹è¼‰ä»¥å…è¡çª
            if (syncState.value === 'saving' && isAuto) return; 
            
            if(!isAuto) syncState.value = 'loading'; 

            try {
                const { data, error } = await supabaseClient
                    .from('trip_data')
                    .select('content')
                    .eq('id', TRIP_ID)
                    .single();
                
                if (error) throw error;
                
                if (data && data.content && JSON.stringify(data.content) !== JSON.stringify(getAppPayload())) {
                    applyCloudData(data.content);
                    syncState.value = 'synced';
                } else {
                    syncState.value = 'synced'; // æ•¸æ“šä¸€è‡´ï¼Œç¶­æŒå·²åŒæ­¥ç‹€æ…‹
                }
            } catch (e) {
                console.error('Fetch fail', e);
                if(!isAuto) syncState.value = 'error';
            }
        }
        
        // ç²å–ç•¶å‰ App ç‹€æ…‹ Payload
        function getAppPayload() {
            return {
                itinerary: JSON.parse(JSON.stringify(itinerary)),
                preTripNotes: preTripNotes.value,
                shoppingList: shoppingList.value,
                expenses: expenses.value,
                infoList: infoList.value,
                flights: flights.value
            };
        }

        function applyCloudData(data) {
            if (!data) return;
            isRemoteUpdate = true; 
            
            // Itinerary
            if (data.itinerary && Array.isArray(data.itinerary)){
              for (let i=0;i<4;i++){
                const loadedItems = (data.itinerary[i] || []).map(item => ({...item, id: item.id || generateId(), address: item.address || '' }));
                itinerary[i].splice(0, itinerary[i].length, ...loadedItems);
              }
            }
            // Others
            if (data.preTripNotes) preTripNotes.value = initializeListWithIds(data.preTripNotes);
            if (data.shoppingList) shoppingList.value = initializeListWithIds(data.shoppingList.map(item => ({...item, imageURL: item.imageURL || '' })));
            if (data.flights) flights.value = data.flights;
            if (data.expenses) {
                expenses.value = data.expenses.map(e => ({...e, id: e.id || generateId(), currency: e.currency || 'TWD' }));
            }
            if (data.infoList) infoList.value = initializeListWithIds(data.infoList);
            
            setTimeout(() => { isRemoteUpdate = false; }, 300);
        }

        // æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•
        function forceReloadCloud() {
            fetchCloudData(false);
        }

        onMounted(()=>{
          // åˆå§‹åŒ–ä¸‹è¼‰
          fetchCloudData(false);

          fetchRate(); fetchWeather();
          setInterval(fetchRate, 10*60*1000);
          setInterval(fetchWeather, 10*60*1000);

          // 3. Polling (æ¯ 15 ç§’æª¢æŸ¥ä¸€æ¬¡)
          setInterval(() => {
              fetchCloudData(true);
          }, 15000);
        });

        // Watch for changes to trigger Save
        watch([itinerary, preTripNotes, shoppingList, expenses, infoList, flights], () => { 
          saveAll();
        }, { deep:true });

        return {
          appVersion, syncState, syncStatusText, forceReloadCloud,
          currentTab, days, selectedDay, selectDay, isFlightDay,
          preTripNotes, newPreNote, addPreNote, removePreNote,
          itinerary, sortedItinerary, itineraryModalOpen, newItineraryItem, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem,
          quickItinerary, addQuickItinerary,
          selectedMapLocation, showLocationOnMap, generateMapLink,
          shoppingList, shoppingModalOpen, newShoppingItem, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, isInstagramLink,
          expenses, newExpense, addExpense, removeExpense, toggleExpenseDone, totalExpense,
          infoList, infoModalOpen, newInfoItem, openInfoModal, closeInfoModal, saveInfoItem, removeInfo,
          activeFlight, shouldShowFlightCard, weather, weatherIconClass, rate, formattedRate, lastRateUpdateLabel,
          openAddModal, flightModalOpen, newFlight, openFlightModal, closeFlightModal, saveFlight, // removeFlight
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
