<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1.0,user-scalable=no" />
  <title>eMenu Taipei v2.02 — 雲端行程助手</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.86);
      --card-radius: 18px;
    }
    html,body,#app { height:100%; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-color:#0f172a;
      margin:0;
    }
    /* hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    
    /* Animation */
    .fade-enter-active, .fade-leave-active { transition: opacity .25s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease; }
    .slide-up-enter-from, .slide-up-leave-to { opacity: 0; transform: translateY(20px); }

    /* Glass Effect for Sticky Header/Footer */
    .glass {
      background-color: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal-backdrop {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.4); z-index: 40;
    }
    .modal-content {
        position: fixed; bottom: 0; left: 0; right: 0;
        background-color: white; border-top-left-radius: 20px;
        border-top-right-radius: 20px; z-index: 50;
        max-height: 90vh; overflow-y: auto;
    }
    /* Sync Status specific styles */
    .sync-status-icon {
        animation: pulse-sync 1.5s infinite;
    }
    .sync-status-synced {
        animation: none;
    }
    .sync-status-error {
        animation: shake 0.5s;
    }
    @keyframes pulse-sync {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
  </style>
</head>
<body class="bg-gray-900">
  <div id="app" class="flex flex-col h-full mx-auto max-w-md bg-gray-50 shadow-2xl relative">

    <header class="glass sticky top-0 z-30 p-4 border-b border-gray-200">
        <div class="flex justify-between items-center text-gray-800">
            <div class="flex items-center space-x-3 text-sm">
                <div class="flex items-center space-x-1" :title="'氣溫: ' + weather.temp + '°C, 降雨機率: ' + weather.rain + '%'">
                    <i :class="weatherIconClass" class="ph-bold text-lg"></i>
                    <span>{{ weather.desc }} ({{ weather.temp }}°)</span>
                </div>
                <div class="flex items-center space-x-1 text-xs text-gray-500" :title="'最後更新: ' + lastRateUpdateLabel">
                    <i class="ph ph-currency-dollar text-lg"></i>
                    <span>TWD 1:HKD {{ formattedRate }}</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-1 text-xs text-gray-500">
                <div class="flex items-center" 
                    :class="{'text-green-600': syncState === 'synced', 'text-amber-500': syncState === 'loading' || syncState === 'saving', 'text-red-500': syncState === 'error'}"
                    @click="forceReloadCloud"
                >
                    <i class="ph-bold text-lg sync-status-icon"
                        :class="{
                            'ph-check-circle sync-status-synced': syncState === 'synced',
                            'ph-arrows-clockwise': syncState === 'loading' || syncState === 'saving',
                            'ph-warning-circle sync-status-error': syncState === 'error'
                        }"></i>
                    <span>{{ syncStatusText }}</span>
                </div>
                <span class="ml-2">| {{ appVersion }}</span>
            </div>
        </div>
        
        <div class="mt-4 flex space-x-2 text-sm">
            <button v-for="tab in ['行前', '行程', '購物', '記帳', '資訊']" :key="tab"
                    @click="currentTab = tab"
                    :class="['px-3 py-1.5 rounded-full font-medium transition', currentTab === tab ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300']">
                {{ tab }}
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pt-2">
        <transition name="fade" mode="out-in">
            <div v-if="currentTab === '行前'" :key="'preTrip'">
                <h2 class="text-xl font-bold mb-3 text-gray-800">行前清單</h2>
                <div class="space-y-2 mb-4">
                    <div v-for="note in preTripNotes" :key="note.id" 
                         :class="['flex items-center p-3 rounded-xl transition', note.isDone ? 'bg-white border border-green-500 text-gray-500 line-through' : 'bg-white shadow-sm border border-gray-200']">
                        <input type="checkbox" v-model="note.isDone" class="form-checkbox h-5 w-5 text-green-600 rounded mr-3" @change="saveAll">
                        <span class="flex-1 text-base truncate">{{ note.name }}</span>
                        <button @click="removePreNote(note.id)" class="text-gray-400 hover:text-red-500 ml-2">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="flex mt-4 p-2 bg-white rounded-xl shadow border border-gray-200">
                    <input v-model="newPreNote" @keyup.enter="addPreNote" type="text" placeholder="新增待辦事項..." class="flex-1 px-2 py-1 focus:outline-none text-gray-700">
                    <button @click="addPreNote" :disabled="!newPreNote.trim()" class="ml-2 text-indigo-600 hover:text-indigo-800 disabled:text-gray-400">
                        <i class="ph ph-plus-circle text-2xl"></i>
                    </button>
                </div>

                <div v-if="shouldShowFlightCard && activeFlight && currentTab === '行前'" 
                    class="mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-md cursor-pointer"
                    @click="openFlightModal(activeFlight.id)">
                    <h3 class="font-bold text-indigo-700 mb-2 flex items-center">
                        <i :class="activeFlight.type === 'outbound' ? 'ph ph-plane-takeoff' : 'ph ph-plane-landing'" class="text-xl mr-2"></i>
                        今日航班提醒 ({{ activeFlight.type === 'outbound' ? '去程' : '回程' }})
                    </h3>
                    <div class="text-sm text-indigo-600 space-y-1">
                        <p class="font-medium">{{ activeFlight.code }} {{ activeFlight.title }}</p>
                        <p>{{ activeFlight.fromCode }} ({{ activeFlight.depTime }}) → {{ activeFlight.toCode }} ({{ activeFlight.arrTime }})</p>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === '行程'" :key="'itinerary'">
                <div class="sticky top-0 -mx-4 pt-2 pb-3 px-4 glass z-20 flex space-x-2 no-scrollbar overflow-x-auto border-b border-gray-200">
                    <button v-for="(day, index) in days" :key="index"
                            @click="selectDay(index)"
                            :class="['flex-shrink-0 w-16 h-16 rounded-xl transition duration-150 flex flex-col justify-center items-center', selectedDay === index ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200']">
                        <span class="text-xs font-medium">{{ day.week }}</span>
                        <span class="text-xl font-bold">{{ day.date }}</span>
                        <span class="text-[10px]">{{ day.label.split(' ')[0] }}</span>
                    </button>
                </div>
                
                <div v-if="shouldShowFlightCard && activeFlight" 
                    class="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-md cursor-pointer"
                    @click="openFlightModal(activeFlight.id)">
                    <h3 class="font-bold text-indigo-700 mb-2 flex items-center">
                        <i :class="activeFlight.type === 'outbound' ? 'ph ph-plane-takeoff' : 'ph ph-plane-landing'" class="text-xl mr-2"></i>
                        {{ days[selectedDay].label }} - {{ activeFlight.title }}
                    </h3>
                    <div class="text-sm text-indigo-600 space-y-1">
                        <p>{{ activeFlight.code }} | {{ activeFlight.date }}</p>
                        <p>{{ activeFlight.fromCode }}{{ activeFlight.fromTerminal ? ' (' + activeFlight.fromTerminal + ')' : '' }} ({{ activeFlight.depTime }}) → {{ activeFlight.toCode }}{{ activeFlight.toTerminal ? ' (' + activeFlight.toTerminal + ')' : '' }} ({{ activeFlight.arrTime }})</p>
                        <p class="text-xs text-indigo-500 mt-1">點擊修改航班資料</p>
                    </div>
                </div>
                
                <h2 v-else class="text-xl font-bold mt-4 mb-3 text-gray-800">{{ days[selectedDay].label }} 行程</h2>

                <div class="space-y-4 relative pb-4">
                    <div v-for="(item, index) in sortedItinerary" :key="item.id" 
                         class="flex transition group">
                        <div class="flex flex-col items-center w-16 mr-3">
                            <span class="text-sm font-bold text-gray-800">{{ item.time || '--:--' }}</span>
                            <div :class="['w-3 h-3 rounded-full mt-1 flex-shrink-0 transition', selectedMapLocation && selectedMapLocation.id === item.id ? 'bg-red-500 ring-2 ring-red-300' : 'bg-indigo-500']"></div>
                            <div v-if="index < sortedItinerary.length - 1" class="w-0.5 flex-1 bg-indigo-200 my-1"></div>
                        </div>
                        
                        <div @click="openItineraryModal(item)"
                             :class="['flex-1 p-3 rounded-xl bg-white shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition', selectedMapLocation && selectedMapLocation.id === item.id ? 'border-red-500 ring-1 ring-red-500' : '']">
                            <p class="font-semibold text-gray-800">{{ item.title }}</p>
                            <p v-if="item.note" class="text-xs text-gray-500 mt-0.5">{{ item.note }}</p>
                            <p v-if="item.address" class="text-xs text-indigo-500 mt-1 flex items-start">
                                <i class="ph ph-map-pin text-sm mr-1 mt-0.5 flex-shrink-0"></i>
                                <span class="truncate">{{ item.address }}</span>
                            </p>
                        </div>
                        
                        <div class="flex flex-col justify-center space-y-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button v-if="item.address" @click.stop="showLocationOnMap(item)" 
                                :title="'地圖: ' + item.title" 
                                :class="['p-2 rounded-full text-white transition', selectedMapLocation && selectedMapLocation.id === item.id ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600']">
                                <i class="ph ph-map-trifold text-xl"></i>
                            </button>
                            <button @click.stop="removeItineraryItem(item.id)" title="刪除" class="p-2 rounded-full bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600 transition">
                                <i class="ph ph-trash-simple text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-white rounded-xl shadow border border-gray-200 flex space-x-2">
                    <input v-model="quickItinerary.time" type="time" class="p-1 border border-gray-300 rounded text-sm text-gray-700 w-24">
                    <input v-model="quickItinerary.title" @keyup.enter="addQuickItinerary" type="text" placeholder="快速新增行程標題..." class="flex-1 px-2 py-1 focus:outline-none text-gray-700">
                    <button @click="addQuickItinerary" :disabled="!quickItinerary.title.trim()" class="ml-2 text-indigo-600 hover:text-indigo-800 disabled:text-gray-400">
                        <i class="ph ph-plus-circle text-2xl"></i>
                    </button>
                </div>
            </div>

            <div v-else-if="currentTab === '購物'" :key="'shopping'">
                <h2 class="text-xl font-bold mb-3 text-gray-800">購物清單</h2>
                 <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-500">{{ shoppingList.length }} 項商品待購</p>
                    <button @click="openShoppingModal(null)" class="text-indigo-600 font-medium text-sm flex items-center">
                        <i class="ph ph-plus-circle text-lg mr-1"></i> 新增商品
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div v-for="item in shoppingList" :key="item.id" 
                         :class="['flex items-center p-3 rounded-xl transition cursor-pointer group', item.isDone ? 'bg-white border border-green-500 text-gray-500 line-through' : 'bg-white shadow-sm border border-gray-200']">
                        <input type="checkbox" v-model="item.isDone" class="form-checkbox h-5 w-5 text-green-600 rounded mr-3" @change="saveAll">
                        <div class="flex-1 min-w-0" @click="openShoppingModal(item)">
                            <span class="text-base font-medium truncate">{{ item.name }}</span>
                             <div v-if="item.imageURL" class="text-xs text-indigo-500 mt-0.5 flex items-center truncate">
                                <i class="ph ph-link text-sm mr-1"></i>
                                <span>{{ isInstagramLink(item.imageURL) ? 'Instagram' : '圖片連結' }}</span>
                            </div>
                        </div>
                       
                        <button @click.stop="removeShoppingItem(item.id)" class="text-gray-400 hover:text-red-500 ml-3">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === '記帳'" :key="'expenses'">
                <h2 class="text-xl font-bold mb-3 text-gray-800">記帳與消費</h2>

                <div class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg mb-4">
                    <p class="text-sm font-medium">總消費 (約合港幣)</p>
                    <div class="flex items-end justify-between mt-1">
                        <span class="text-4xl font-extrabold">HK$ {{ totalExpense }}</span>
                        <p class="text-xs opacity-80">匯率: TWD 1:HKD {{ formattedRate || 'N/A' }}</p>
                    </div>
                </div>

                <div class="p-3 bg-white rounded-xl shadow border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2">新增支出</h3>
                    <div class="space-y-2">
                         <input v-model="newExpense.name" type="text" placeholder="消費項目描述..." class="w-full px-3 py-2 border rounded text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="flex space-x-2">
                             <select v-model="newExpense.currency" class="px-3 py-2 border rounded text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="TWD">TWD</option>
                                <option value="HKD">HKD</option>
                            </select>
                            <input v-model.number="newExpense.amount" type="number" placeholder="金額..." class="flex-1 px-3 py-2 border rounded text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                           
                            <select v-model="newExpense.category" class="px-3 py-2 border rounded text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                                <option>食物</option>
                                <option>交通</option>
                                <option>住宿</option>
                                <option>購物</option>
                                <option>雜項</option>
                            </select>
                        </div>
                    </div>
                    <button @click="addExpense" :disabled="!newExpense.name || !newExpense.amount" class="w-full mt-3 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition disabled:bg-indigo-300">
                        記錄支出
                    </button>
                </div>

                <div class="space-y-2">
                    <div v-for="expense in expenses" :key="expense.id" 
                         :class="['flex items-center p-3 rounded-xl transition group', expense.isDone ? 'bg-white border border-green-500 text-gray-500 line-through' : 'bg-white shadow-sm border border-gray-200']">
                        <input type="checkbox" v-model="expense.isDone" class="form-checkbox h-5 w-5 text-green-600 rounded mr-3" @change="toggleExpenseDone(expense.id)">
                        <div class="flex-1 min-w-0">
                             <p class="text-base font-medium truncate">{{ expense.name }}</p>
                             <p class="text-xs text-gray-500 mt-0.5">{{ expense.date }} · {{ expense.category }}</p>
                        </div>
                        <span class="font-bold text-lg mr-2 flex-shrink-0">{{ expense.currency }}{{ expense.amount }}</span>
                        <button @click="removeExpense(expense.id)" class="text-gray-400 hover:text-red-500 ml-2">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div v-else-if="currentTab === '資訊'" :key="'info'">
                <h2 class="text-xl font-bold mb-3 text-gray-800">重要資訊與筆記</h2>
                 <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-500">{{ infoList.length }} 項資訊</p>
                    <button @click="openInfoModal(null)" class="text-indigo-600 font-medium text-sm flex items-center">
                        <i class="ph ph-plus-circle text-lg mr-1"></i> 新增資訊
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div v-for="item in infoList" :key="item.id" 
                         :class="['flex items-center p-3 rounded-xl transition cursor-pointer group', item.isDone ? 'bg-white border border-green-500 text-gray-500 line-through' : 'bg-white shadow-sm border border-gray-200']"
                         @click="openInfoModal(item)">
                        <i class="ph ph-info text-2xl mr-3 text-indigo-500"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-medium truncate">{{ item.title }}</p>
                            <p class="text-xs text-gray-500 mt-0.5 truncate">{{ item.note }}</p>
                        </div>
                        <button @click.stop="removeInfo(item.id)" class="text-gray-400 hover:text-red-500 ml-3">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </transition>
        
        <transition name="slide-up">
            <div v-if="selectedMapLocation" 
                 class="fixed bottom-20 right-4 w-64 bg-white p-3 rounded-xl shadow-2xl border border-gray-200 z-40">
                <p class="text-xs font-semibold text-gray-700 truncate">{{ selectedMapLocation.title }}</p>
                <p class="text-xs text-gray-500 mt-1 truncate">{{ selectedMapLocation.address }}</p>
                <div class="mt-2 flex space-x-2">
                    <a :href="generateMapLink(selectedMapLocation.address, 'search')" target="_blank" class="flex-1 flex justify-center items-center py-1 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600">
                        <i class="ph ph-magnifying-glass mr-1"></i> 搜尋
                    </a>
                    <a :href="generateMapLink(selectedMapLocation.address, 'navigate')" target="_blank" class="flex-1 flex justify-center items-center py-1 bg-green-500 text-white text-xs rounded-lg hover:bg-green-600">
                        <i class="ph ph-compass-tool mr-1"></i> 導航
                    </a>
                </div>
            </div>
        </transition>
    </main>
    
    <div class="fixed bottom-20 right-4 z-40" :class="{'hidden': selectedMapLocation}">
        <button @click="openAddModal" class="w-14 h-14 rounded-full bg-indigo-600 text-white shadow-xl hover:bg-indigo-700 transition flex items-center justify-center">
            <i class="ph ph-plus-circle text-3xl"></i>
        </button>
    </div>

    <transition name="fade">
        <div v-if="itineraryModalOpen" class="modal-backdrop" @click="closeItineraryModal"></div>
    </transition>
    <transition name="slide-up">
        <div v-if="itineraryModalOpen" class="modal-content p-4 z-50">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ newItineraryItem.id ? '編輯行程項目' : '新增行程項目' }}</h3>
            <div class="space-y-4">
                <input v-model="newItineraryItem.title" type="text" placeholder="標題 (必填)..." class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                <div class="flex space-x-4">
                    <input v-model="newItineraryItem.time" type="time" placeholder="時間" class="w-1/3 px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <select v-model.number="newItineraryItem.dayIndex" class="w-2/3 px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                        <option v-for="(day, index) in days" :value="index" :key="index">{{ day.label }}</option>
                    </select>
                </div>
                <textarea v-model="newItineraryItem.note" placeholder="備註或簡單說明..." rows="2" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                <input v-model="newItineraryItem.address" type="text" placeholder="地址 (用於地圖導航)..." class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="closeItineraryModal" class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">取消</button>
                <button @click="saveItineraryItem" :disabled="!newItineraryItem.title.trim()" class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition disabled:bg-indigo-300">儲存</button>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="flightModalOpen" class="modal-backdrop" @click="closeFlightModal"></div>
    </transition>
    <transition name="slide-up">
        <div v-if="flightModalOpen" class="modal-content p-4 z-50">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ newFlight.id ? '編輯航班資料' : '新增航班資料' }}</h3>
            <div class="space-y-4">
                <select v-model="newFlight.type" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="outbound">去程航班</option>
                    <option value="return">回程航班</option>
                </select>
                <div class="flex space-x-2">
                    <input v-model="newFlight.date" type="date" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <input v-model="newFlight.code" type="text" placeholder="航班編號 (e.g. CX400)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input v-model="newFlight.fromCode" type="text" placeholder="出發地代碼 (e.g. HKG)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <input v-model="newFlight.toCode" type="text" placeholder="目的地代碼 (e.g. TPE)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input v-model="newFlight.depTime" type="time" placeholder="出發時間" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <input v-model="newFlight.arrTime" type="time" placeholder="抵達時間" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input v-model="newFlight.fromTerminal" type="text" placeholder="出發航廈 (可選)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                    <input v-model="newFlight.toTerminal" type="text" placeholder="抵達航廈 (可選)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <input v-model="newFlight.title" type="text" placeholder="航班標題 (可選)" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="closeFlightModal" class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">取消</button>
                <button @click="saveFlight" :disabled="!newFlight.code || !newFlight.date" class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition disabled:bg-indigo-300">儲存航班</button>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="shoppingModalOpen" class="modal-backdrop" @click="closeShoppingModal"></div>
    </transition>
    <transition name="slide-up">
        <div v-if="shoppingModalOpen" class="modal-content p-4 z-50">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ newShoppingItem.id ? '編輯購物項目' : '新增購物項目' }}</h3>
            <div class="space-y-4">
                <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱 (必填)..." class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                <input v-model="newShoppingItem.imageURL" type="text" placeholder="商品圖片/連結 (可選)..." class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                <div class="flex items-center space-x-3">
                    <input type="checkbox" v-model="newShoppingItem.isDone" id="shopping-done" class="form-checkbox h-5 w-5 text-green-600 rounded">
                    <label for="shopping-done" class="text-gray-700">已購買</label>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="closeShoppingModal" class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">取消</button>
                <button @click="saveShoppingItem" :disabled="!newShoppingItem.name.trim()" class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition disabled:bg-indigo-300">儲存</button>
            </div>
        </div>
    </transition>
    
    <transition name="fade">
        <div v-if="infoModalOpen" class="modal-backdrop" @click="closeInfoModal"></div>
    </transition>
    <transition name="slide-up">
        <div v-if="infoModalOpen" class="modal-content p-4 z-50">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ newInfoItem.id ? '編輯資訊項目' : '新增資訊項目' }}</h3>
            <div class="space-y-4">
                <input v-model="newInfoItem.title" type="text" placeholder="標題 (e.g. 酒店電話)..." class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                <textarea v-model="newInfoItem.note" placeholder="詳細內容..." rows="3" class="w-full px-4 py-3 border rounded-xl text-gray-700 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="closeInfoModal" class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">取消</button>
                <button @click="saveInfoItem" :disabled="!newInfoItem.title.trim()" class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition disabled:bg-indigo-300">儲存</button>
            </div>
        </div>
    </transition>

    <footer class="glass sticky bottom-0 z-30 p-4 border-t border-gray-200">
        <div class="flex justify-between items-center text-gray-500 text-xs">
            <span>eMenu Taipei 雲端行程助手</span>
            <span>Made with Vue & Supabase</span>
        </div>
    </footer>
  </div>
    
  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
    const initializeListWithIds = (list) => list.map(item => ({ ...item, id: item.id || generateId() })); 
    function isInstagramLink(url) {
        if (!url) return false;
        return /^(https?:\/\/(www\.)?instagram\.com\/(p|reel)\/)/i.test(url);
    }

    // --- SUPABASE SETUP (請確認 Key 資訊正確) ---
    // 您的 Supabase 專案 URL 和 Publishable Key
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuQVVvKi'; 
    
    // 初始化 Client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const TRIP_ID = 'shared_trip';

    createApp({
      setup(){
        const appVersion = 'v2.02-Final'; 
        const currentTab = ref('行前');
        
        // Sync Status UI
        const syncState = ref('loading'); // 啟動時即為 'loading'
        const syncStatusText = computed(() => {
            if(syncState.value === 'synced') return '已同步';
            if(syncState.value === 'saving') return '儲存中...';
            if(syncState.value === 'loading') return '下載中...';
            return '同步失敗';
        });

        const days = reactive([
          { week:'Mon', date:'15', label:'12/15 (一)', type: 'flight-out' },
          { week:'Tue', date:'16', label:'12/16 (二)', type: 'stay' },
          { week:'Wed', date:'17', label:'12/17 (三)', type: 'stay' },
          { week:'Thu', date:'18', label:'12/18 (四)', type: 'flight-return' }
        ]);
        const selectedDay = ref(0);

        const isFlightDay = computed(() => {
            const t = days[selectedDay.value].type;
            return t === 'flight-out' || t === 'flight-return';
        });

        const quickItinerary = reactive({ time: '', title: '' });

        // Initial Data Structure (從舊版本中提取的初始數據)
        const initialItinerary = [
          [
            { title:'抵達台北・入住酒店、休息', note:'西門町永安棧', time:'', address:'台北市萬華區中華路一段52號' },
            { title:'西門町輕鬆散步', note:'悠閒行程', time:'18:00', address:'' },
            { title:'雅香石頭火鍋（晚餐）', note:'必吃排隊店', time:'19:00', address:'台北市萬華區成都路152號' },
            { title:'南機場夜市', note:'宵夜', time:'21:00', address:'台北市中正區中華路二段307巷' },
            { title:'返酒店休息', note:'10:30 前休息', time:'23:00', address:'' }
          ],
          [
            { title:'午餐：千暉鵝肉店', note:'美食', time:'12:00', address:'108 台灣台北市萬華區中華路二段420號' },
            { title:'Costco 中和店（續會＋買手信）', note:'購物', time:'14:00', address:'新北市中和區中山路二段347號' },
            { title:'晚餐：雞湯榮麵食館（17:00 後）', note:'晚餐', time:'17:30', address:'台北市萬華區西昌街202號' },
            { title:'華西街夜市', note:'逛夜市', time:'19:30', address:'台北市萬華區華西街' },
            { title:'胖老闆誠意肉粥（宵夜）', note:'宵夜', time:'22:00', address:'台北市萬華區廣州街253號' }
          ],
          [
            { title:'午餐：梁山泊小籠湯包', note:'中午', time:'12:00', address:'台北市萬華區峨眉街22號' },
            { title:'西門町行下 / Cafe 休息', note:'悠閒午後', time:'14:00', address:'' },
            { title:'寧夏夜市', note:'晚餐自理', time:'18:30', address:'台北市大同區寧夏路' },
            { title:'回酒店', note:'休息', time:'21:00', address:'' }
          ],
          [
            { title:'西門町補買手信', note:'購物', time:'11:00', address:'' },
            { title:'金園排骨（午餐）', note:'午餐', time:'13:00', address:'台北市萬華區漢中街121-1號' },
            { title:'前往機場（CX443）', note:'搭乘 CX443 回 HKG', time:'15:50', address:'台灣桃園國際機場' }
          ]
        ];
        // 初始化 itinerary 結構，確保 address 存在
        const itinerary = reactive(initialItinerary.map(dayItems => initializeListWithIds(dayItems).map(item => ({ ...item, address: item.address || '' }))));
        const sortedItinerary = computed(() => {
            const currentDayItinerary = itinerary[selectedDay.value];
            if (!currentDayItinerary || currentDayItinerary.length === 0) return [];
            return [...currentDayItinerary].sort((a, b) => {
                const timeA = a.time || '23:59';
                const timeB = b.time || '23:59';
                return timeA.localeCompare(timeB);
            });
        });

        // Map Module Logic
        const selectedMapLocation = ref(null);
        function showLocationOnMap(item) {
            if (item.address && item.address.trim() !== '') {
                selectedMapLocation.value = { title: item.title, address: item.address, id: item.id };
            } else {
                selectedMapLocation.value = null;
            }
        }
        function generateMapLink(address, type) {
            if (!address) return '#';
            const encodedAddress = encodeURIComponent(address);
            // 由於直接使用 Google Maps URL 在某些環境可能被封鎖，這裡使用安全的佔位符
            if (type === 'search') return `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            if (type === 'navigate') return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            return '#';
        }

        // Active Flight
        const flights = ref([
          { id: 'outbound', date:'2025-12-15', code:'CX400', depTime:'13:00', fromCode:'HKG', fromTerminal:'T1', toCode:'TPE', toTerminal:'T1', arrTime:'14:50', title:'由香港飛往台北', note:'航班前往台北', type: 'outbound' },
          { id: 'return', date:'2025-12-18', code:'CX443', depTime:'15:50', fromCode:'TPE', fromTerminal:'T1', toCode:'HKG', toTerminal:'T1', arrTime:'18:00', title:'由台北返回香港', note:'回程', type: 'return' }
        ]);
        const activeFlight = computed(() => {
          const dayType = days[selectedDay.value].type;
          if (dayType === 'flight-out') return flights.value.find(f => f.type === 'outbound');
          if (dayType === 'flight-return') return flights.value.find(f => f.type === 'return');
          return null;
        });
        const shouldShowFlightCard = computed(() => {
          const dayType = days[selectedDay.value].type;
          return (currentTab.value === '行前' || currentTab.value === '行程') && (dayType === 'flight-out' || dayType === 'flight-return');
        });

        // Modals Logic
        const itineraryModalOpen = ref(false);
        const newItineraryItem = reactive({ id: null, title: '', note: '', time: '', address: '', dayIndex: null });
        function resetItineraryModal() { Object.assign(newItineraryItem, { id: null, title: '', note: '', time: '', address: '', dayIndex: selectedDay.value }); }
        function openItineraryModal(item = null) {
            resetItineraryModal();
            if (item) Object.assign(newItineraryItem, deepClone(item));
            newItineraryItem.dayIndex = selectedDay.value;
            itineraryModalOpen.value = true;
        }
        function closeItineraryModal() { itineraryModalOpen.value = false; }
        function saveItineraryItem() {
            if (!newItineraryItem.title.trim()) return;
            const dayItems = itinerary[newItineraryItem.dayIndex];
            const itemToSave = { 
                id: newItineraryItem.id || generateId(), 
                title: newItineraryItem.title.trim(), 
                note: newItineraryItem.note.trim(), 
                time: newItineraryItem.time.trim(),
                address: newItineraryItem.address.trim(),
            };
            const index = dayItems.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) dayItems.splice(index, 1, itemToSave);
            else dayItems.push(itemToSave);
            if (selectedMapLocation.value && selectedMapLocation.value.id === itemToSave.id) {
                 showLocationOnMap(itemToSave);
            }
            closeItineraryModal();
            saveAll();
        }
        function removeItineraryItem(idToRemove) {
            if (!confirm('確定刪除此行程項目嗎？')) return;
            const dayItems = itinerary[selectedDay.value];
            const index = dayItems.findIndex(i => i.id === idToRemove);
            if (index !== -1) {
                dayItems.splice(index, 1);
                if (selectedMapLocation.value && selectedMapLocation.value.id === idToRemove) selectedMapLocation.value = null;
                saveAll();
            }
        }
        function addQuickItinerary(){
            if (!quickItinerary.title.trim()) return;
            const dayItems = itinerary[selectedDay.value];
            const itemToSave = {
                id: generateId(),
                title: quickItinerary.title.trim(),
                note: '',
                time: quickItinerary.time || '',
                address: ''
            };
            dayItems.push(itemToSave);
            quickItinerary.title = '';
            quickItinerary.time = '';
            saveAll();
        }

        const flightModalOpen = ref(false);
        const newFlight = reactive({ id: null, type: 'outbound', date: '', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
        function openFlightModal(flightId = null){
             Object.assign(newFlight, { id: null, type: 'outbound', date: days[selectedDay.value]?.date ? `2025-12-${days[selectedDay.value].date.padStart(2, '0')}` : '2025-12-15', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
             const dayType = days[selectedDay.value]?.type;
             if (dayType === 'flight-out') newFlight.type = 'outbound';
             else if (dayType === 'flight-return') newFlight.type = 'return';
             if(flightId){
                const flightToEdit = flights.value.find(f => f.id === flightId);
                if(flightToEdit){
                    Object.assign(newFlight, deepClone(flightToEdit));
                    newFlight.id = flightId;
                }
            }
            flightModalOpen.value = true;
        }
        function closeFlightModal(){ flightModalOpen.value = false; }
        function saveFlight(){
            if (!newFlight.code || !newFlight.depTime || !newFlight.type) return;
            const dateStr = new Date(newFlight.date).toISOString().split('T')[0];
            const flightToSave = { ...deepClone(newFlight), id: newFlight.type, date: dateStr };
            const index = flights.value.findIndex(f => f.id === newFlight.type);
            if (index !== -1) flights.value.splice(index, 1, flightToSave);
            else flights.value.push(flightToSave);
            const dayIndex = days.findIndex(d => d.date.padStart(2, '0') === new Date(dateStr).getDate().toString().padStart(2, '0'));
            if (dayIndex !== -1) days[dayIndex].type = newFlight.type;
            
            closeFlightModal();
            saveAll();
        }

        const shoppingModalOpen = ref(false);
        const newShoppingItem = reactive({ id: null, name: '', isDone: false, imageURL: '' });
        function openShoppingModal(item = null) {
            Object.assign(newShoppingItem, { id: null, name: '', isDone: false, imageURL: '' });
            if (item) Object.assign(newShoppingItem, deepClone(item));
            shoppingModalOpen.value = true;
        }
        function closeShoppingModal() { shoppingModalOpen.value = false; }
        function saveShoppingItem() {
            if (!newShoppingItem.name.trim()) return;
            const itemToSave = { ...deepClone(newShoppingItem), id: newShoppingItem.id || generateId() };
            const index = shoppingList.value.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) shoppingList.value.splice(index, 1, itemToSave);
            else shoppingList.value.push(itemToSave);
            closeShoppingModal();
            saveAll();
        }
        function removeShoppingItem(idToRemove) {
            if (!confirm('確定刪除此購物項目嗎？')) return;
            const index = shoppingList.value.findIndex(i => i.id === idToRemove);
            if (index !== -1) { shoppingList.value.splice(index, 1); saveAll(); }
        }

        const infoModalOpen = ref(false);
        const newInfoItem = reactive({ id: null, title: '', note: '', isDone: false });
        function openInfoModal(item = null) {
            Object.assign(newInfoItem, { id: null, title: '', note: '', isDone: false });
            if (item) Object.assign(newInfoItem, deepClone(item));
            infoModalOpen.value = true;
        }
        function closeInfoModal() { infoModalOpen.value = false; }
        function saveInfoItem() {
            if (!newInfoItem.title.trim()) return;
            const itemToSave = { ...deepClone(newInfoItem), id: newInfoItem.id || generateId() };
            const index = infoList.value.findIndex(i => i.id === itemToSave.id);
            if (index !== -1) infoList.value.splice(index, 1, itemToSave);
            else infoList.value.push(itemToSave);
            closeInfoModal();
            saveAll();
        }
        function removeInfo(idToRemove) {
            if (!confirm('確定刪除此資訊項目嗎？')) return;
            const index = infoList.value.findIndex(i => i.id === idToRemove);
            if (index !== -1) { infoList.value.splice(index, 1); saveAll(); }
        }

        // Lists
        const preTripNotes = ref(initializeListWithIds([
          { name:'兌換台幣', isDone: true },
          { name:'確認住宿預約單', isDone: false },
          { name:'購買 SIM 卡', isDone: false },
          { name:'護照影本備份', isDone: true }
        ]));
        const newPreNote = ref('');
        const shoppingList = ref(initializeListWithIds([
          { name:'鳳梨酥 (佳德)', isDone: false, imageURL: '' },
          { name:'面膜 (藥妝店)', isDone: false, imageURL: '' },
          { name:'肉乾', isDone: true, imageURL: '' }
        ]));
        const expenses = ref([
          { id: Date.now()+1, name:'雅香火鍋', amount: 300, category:'食物', date: '12/15', isDone:false, currency: 'TWD' },
          { id: Date.now()+2, name:'Taxi 機場->酒店', amount: 250, category:'交通', date: '12/15', isDone:false, currency: 'TWD' }
        ]);
        const newExpense = reactive({ name:'', amount:null, currency:'TWD', category:'食物' });
        const infoList = ref(initializeListWithIds([
          { title:'西門町永安棧 (電話)', note:'+886 2 2352 3090', isDone:false },
        ]));

        const totalExpense = computed(() => {
            const twdToHkdRate = Number(rate.value) || 0;
            return expenses.value.reduce((total, e) => {
                const amount = Number(e.amount) || 0;
                let convertedAmount = amount;
                if (e.currency === 'TWD' && twdToHkdRate > 0) {
                    // TWD to HKD: amount * rate (TWD:HKD)
                    convertedAmount = amount * twdToHkdRate;
                } else if (e.currency === 'HKD') {
                    convertedAmount = amount;
                } else {
                    return total; // 如果匯率為 0 或非 TWD/HKD，跳過
                }
                return total + convertedAmount;
            }, 0).toFixed(2);
        });

        // Weather & Rate
        const weather = reactive({ temp:'--', desc:'載入中...', rain:0, code:0 });
        const weatherIconClass = computed(()=>{
          const c = weather.code || 0;
          if (c>=95) return 'ph ph-cloud-lightning-rain';
          if (c>=80) return 'ph ph-cloud-lightning-rain';
          if (c>=50) return 'ph ph-cloud-rain';
          if (c>2) return 'ph ph-cloud';
          return 'ph ph-sun';
        });
        const rate = ref(null);
        const lastRateUpdate = ref(null);
        const formattedRate = computed(()=> rate.value !== null ? rate.value : '...');
        const lastRateUpdateLabel = computed(()=>{
          if (!lastRateUpdate.value) return '—';
          return new Date(lastRateUpdate.value).toLocaleTimeString('zh-HK');
        });

        function selectDay(i){ selectedDay.value = i; selectedMapLocation.value = null; }
        function addPreNote(){ 
            if (!newPreNote.value.trim()) return; 
            preTripNotes.value.push({ id:generateId(), name:newPreNote.value.trim(), isDone:false }); 
            newPreNote.value=''; 
            saveAll(); 
        }
        function removePreNote(idToRemove){ 
            const index = preTripNotes.value.findIndex(n => n.id === idToRemove);
            if (index !== -1) { preTripNotes.value.splice(index,1); saveAll(); }
        }
        function addExpense(){
          if (!newExpense.name.trim() || !newExpense.amount) return;
          const d = new Date();
          const dateLabel = `${d.getMonth()+1}/${d.getDate()}`;
          expenses.value.unshift({ id: generateId(), name: newExpense.name.trim(), amount: Number(newExpense.amount), category: newExpense.category, date: dateLabel, isDone: false, currency: newExpense.currency });
          newExpense.name = ''; newExpense.amount = null; newExpense.currency = 'TWD'; newExpense.category = '食物';
          saveAll();
        }
        function removeExpense(idToRemove){ 
            const index = expenses.value.findIndex(e => e.id === idToRemove);
            if (index !== -1) { expenses.value.splice(index,1); saveAll(); }
        }
        function toggleExpenseDone(idToToggle){ 
             const expense = expenses.value.find(e => e.id === idToToggle);
             if(expense) expense.isDone = !expense.isDone;
             saveAll(); 
        }

        function openAddModal(){
          if (currentTab.value === '行前'){ 
             if (newPreNote.value) addPreNote();
             else { currentTab.value = '行程'; }
          }
          else if (currentTab.value === '行程'){ 
             if (isFlightDay.value) {
                 const flightId = activeFlight.value ? activeFlight.value.id : null; 
                 openFlightModal(flightId);
             } else {
                 openItineraryModal(null);
             }
          }
          else if (currentTab.value === '購物'){ openShoppingModal(null); }
          else if (currentTab.value === '記帳'){ if (newExpense.name && newExpense.amount) addExpense(); }
          else if (currentTab.value === '資訊'){ openInfoModal(null); }
        }

        async function fetchRate(){
          // 透過 TWD 取得 HKD 匯率 (Open-Exchange Rates API)
          const API_URL = 'https://open.er-api.com/v6/latest/TWD';
          try {
            const res = await fetch(API_URL);
            if (!res.ok){ rate.value = null; return; }
            const data = await res.json();
            if (data && data.rates && data.rates.HKD){
              // 計算 TWD 1:HKD 的匯率
              rate.value = (data.rates.HKD).toFixed(3); 
              lastRateUpdate.value = new Date().toISOString();
            } else {
              rate.value = null;
            }
          } catch(e){ console.warn('rate fail', e); rate.value = null; }
        }

        async function fetchWeather(){
          try {
            const lat = 25.0330, lon = 121.5654; // 台北市經緯度
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=precipitation_probability&timezone=Asia%2FTaipei`;
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.current_weather){
              weather.temp = Math.round(data.current_weather.temperature);
              weather.code = data.current_weather.weathercode || 0;
              weather.desc = describeWeather(weather.code);
              // 嘗試抓取當前時間的降雨機率
              if (data.hourly && data.hourly.precipitation_probability){
                const nowTime = data.current_weather.time.slice(0, 13);
                const nowIdx = data.hourly.time.findIndex(t => t.startsWith(nowTime));
                const prob = (nowIdx >= 0) ? data.hourly.precipitation_probability[nowIdx] : (data.hourly.precipitation_probability[0] || 0);
                weather.rain = Math.round(prob);
              } else weather.rain = 0;
            }
          } catch(e){ console.warn('weather fail', e); weather.desc='無法取得'; }
        }

        function describeWeather(code){
          if (code >= 95) return '雷暴';
          if (code >= 80) return '陣雨';
          if (code >= 60) return '持續降雨';
          if (code >= 50) return '毛毛雨';
          if (code >= 40) return '霧/冰霧';
          if (code >= 30) return '沙塵暴';
          if (code >= 20) return '局部陣雨';
          if (code > 2) return '多雲';
          if (code === 2) return '局部多雲';
          return '晴朗';
        }

        // --- CLOUD SYNC LOGIC (NO REALTIME) ---
        
        let debounceTimer = null;
        let isRemoteUpdate = false; 

        // 1. Save Data (Debounced Upsert)
        function saveAll(){
            if(isRemoteUpdate) return;
            
            syncState.value = 'saving';
            if (debounceTimer) clearTimeout(debounceTimer);

            debounceTimer = setTimeout(async () => {
                const payload = {
                    itinerary: JSON.parse(JSON.stringify(itinerary)),
                    preTripNotes: preTripNotes.value,
                    shoppingList: shoppingList.value,
                    expenses: expenses.value,
                    infoList: infoList.value,
                    flights: flights.value
                };
                
                try {
                    const { error } = await supabaseClient
                        .from('trip_data')
                        .upsert({ id: TRIP_ID, content: payload });

                    if (error) throw error;
                    syncState.value = 'synced';
                } catch (e) {
                    console.error('Save failed', e);
                    syncState.value = 'error';
                }
            }, 1000); 
        }

        // 2. Fetch Data (Pull)
        async function fetchCloudData(isAuto = true) {
            if (syncState.value === 'saving' && isAuto) return; 
            
            if(!isAuto) syncState.value = 'loading'; 

            try {
                const { data, error } = await supabaseClient
                    .from('trip_data')
                    .select('content, updated_at') 
                    .eq('id', TRIP_ID)
                    .single();
                
                if (error) throw error;
                
                if (data && data.content) {
                    applyCloudData(data.content);
                }
                
                syncState.value = 'synced'; 

            } catch (e) {
                console.error('Fetch fail', e);
                // 如果不是自動檢查，或者當前狀態不是正在儲存，就設定為錯誤
                if(!isAuto || syncState.value !== 'saving') syncState.value = 'error'; 
            }
        }
        
        // ⭐️ 關鍵優化區域：應用數據時更嚴格地檢查 JSON 鍵值
        function applyCloudData(data) {
            if (!data || typeof data !== 'object') return; 
            
            isRemoteUpdate = true; 
            
            try {
                // Itinerary: 確保是陣列且長度正確
                if (Array.isArray(data.itinerary) && data.itinerary.length === itinerary.length){
                    for (let i = 0; i < itinerary.length; i++) {
                        if (Array.isArray(data.itinerary[i])) {
                            // 安全地初始化每個行程項目
                            const loadedItems = (data.itinerary[i] || []).map(item => ({
                                ...item, 
                                id: item.id || generateId(), 
                                address: item.address || '' // 確保 address 欄位存在
                            }));
                            // 安全地替換數組內容 (reactive array splice)
                            itinerary[i].splice(0, itinerary[i].length, ...loadedItems); 
                        }
                    }
                }
                
                // Others (使用 || [] 確保即使數據庫是 null 也會得到空數組)
                preTripNotes.value = initializeListWithIds(data.preTripNotes || []);
                shoppingList.value = initializeListWithIds((data.shoppingList || []).map(item => ({
                    ...item, 
                    imageURL: item.imageURL || '' 
                })));
                flights.value = (data.flights || []).map(f => ({
                    ...f, 
                    fromTerminal: f.fromTerminal || '', 
                    toTerminal: f.toTerminal || ''
                }));
                expenses.value = (data.expenses || []).map(e => ({
                    ...e, 
                    id: e.id || generateId(), 
                    currency: e.currency || 'TWD' 
                }));
                infoList.value = initializeListWithIds(data.infoList || []);

            } catch(e) {
                console.error("Error applying cloud data locally:", e);
                syncState.value = 'error'; 
            }
            
            setTimeout(() => { isRemoteUpdate = false; }, 300);
        }

        // 手動刷新按鈕
        function forceReloadCloud() {
            fetchCloudData(false);
        }

        onMounted(()=>{
          // 初始化下載
          fetchCloudData(false);

          fetchRate(); fetchWeather();
          setInterval(fetchRate, 10*60*1000); // 10分鐘更新一次匯率
          setInterval(fetchWeather, 10*60*1000); // 10分鐘更新一次天氣

          // 3. Polling (每 15 秒檢查一次，自動同步)
          setInterval(() => {
              fetchCloudData(true);
          }, 15000);
        });

        // 修正後的 Watch for changes to trigger Save: 只監聽核心數據模型
        watch([
          preTripNotes, 
          shoppingList, 
          expenses, 
          infoList, 
          flights, 
          // 監聽行程數據，將其轉換為 JSON 字符串以觸發 deep watch
          () => itinerary.map(d => JSON.stringify(d)) 
        ], () => { 
          saveAll();
        }, { deep:true });

        return {
          appVersion, syncState, syncStatusText, forceReloadCloud,
          currentTab, days, selectedDay, selectDay, isFlightDay,
          preTripNotes, newPreNote, addPreNote, removePreNote,
          itinerary, sortedItinerary, itineraryModalOpen, newItineraryItem, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem,
          quickItinerary, addQuickItinerary,
          selectedMapLocation, showLocationOnMap, generateMapLink,
          shoppingList, shoppingModalOpen, newShoppingItem, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, isInstagramLink,
          expenses, newExpense, addExpense, removeExpense, toggleExpenseDone, totalExpense,
          infoList, infoModalOpen, newInfoItem, openInfoModal, closeInfoModal, saveInfoItem, removeInfo,
          activeFlight, shouldShowFlightCard, weather, weatherIconClass, rate, formattedRate, lastRateUpdateLabel,
          openAddModal, flightModalOpen, newFlight, openFlightModal, closeFlightModal, saveFlight, 
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
