<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v251219-5.0.1</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    body {
      background-color: var(--ios-bg);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      -webkit-font-smoothing: antialiased;
      color: #1c1c1e;
      overflow-x: hidden;
      /* Prevent pull-to-refresh on mobile */
      overscroll-behavior-y: none; 
    }

    /* iOS Glass Effect */
    .glass-panel {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      box-shadow: var(--glass-shadow);
    }

    /* Smooth Transitions */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

    /* Custom Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Calculator Grid */
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .calc-btn {
      height: 56px;
      border-radius: 50%; /* Circle or rounded rect */
      background: rgba(255,255,255,0.8);
      font-size: 1.5rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: background 0.1s;
      color: #333;
    }
    .calc-btn:active { background: #e5e5ea; }
    .calc-btn.primary { background: var(--ios-primary); color: white; }
    .calc-btn.wide { grid-column: span 2; border-radius: 35px; }

    /* Category Gradient Icon Wrapper */
    .cat-icon-wrap {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.4rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden selection:bg-blue-100">

  <div id="app" class="relative h-full flex flex-col">

    <header class="pt-[calc(var(--safe-top)+10px)] pb-2 px-5 flex-none z-20">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-gray-900">
            {{ currentTabTitle }}
          </h1>
          <p class="text-xs text-gray-400 font-medium tracking-wide mt-0.5">
            {{ appVersion }} <span v-if="syncState" :class="getStatusClass">{{ syncStatusText }}</span>
          </p>
        </div>
        
        <div v-if="weather" class="flex flex-col items-end">
           <div class="flex items-center gap-2 bg-white/50 px-3 py-1.5 rounded-full backdrop-blur-md shadow-sm border border-white/40">
              <i :class="weatherIconClass" class="text-xl text-blue-500"></i>
              <span class="text-lg font-semibold">{{ Math.round(weather.main.temp) }}°</span>
           </div>
        </div>
      </div>

      <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2 items-center">
        <button 
          v-for="(day, index) in days" 
          :key="index"
          @click="selectDay(day)"
          :class="['flex-none w-[4.5rem] h-16 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 border',
            selectedDay === day ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 border-transparent scale-105' : 'bg-white/60 text-gray-500 border-white/40']"
        >
          <span class="text-[10px] uppercase font-bold opacity-80">{{ day.label }}</span>
          <span class="text-xl font-bold mt-0.5">{{ day.dateStr }}</span>
        </button>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-32 px-5 relative w-full" id="main-scroll">
      
      <div v-if="currentTab === 'preparation'" class="space-y-6 animate-fade-in">
        <div class="glass-panel p-5 rounded-3xl">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="ph-fill ph-check-square text-blue-500"></i> 行前準備
            </h2>
            <button @click="openAddModal('preNote')" class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
              <i class="ph-bold ph-plus"></i>
            </button>
          </div>
          
          <div v-if="preTripNotes.length === 0" class="text-center py-8 text-gray-400">
             <i class="ph-duotone ph-clipboard-text text-4xl mb-2"></i>
             <p class="text-sm">尚無待辦事項</p>
          </div>

          <ul class="space-y-3">
             <li v-for="note in preTripNotes" :key="note.id" 
                 class="flex items-start gap-3 p-3 bg-white/50 rounded-xl transition-all active:scale-[0.98]">
                <button @click="togglePreNoteDone(note)" 
                   :class="['mt-0.5 w-5 h-5 rounded-full border flex items-center justify-center transition-colors', note.done ? 'bg-green-500 border-green-500' : 'border-gray-300 bg-white']">
                   <i v-if="note.done" class="ph-bold ph-check text-white text-xs"></i>
                </button>
                <div class="flex-1" @click="editPreNote(note)">
                   <p :class="['text-sm font-medium transition-all', note.done ? 'text-gray-400 line-through' : 'text-gray-800']">{{ note.text }}</p>
                </div>
                <button @click="removePreNote(note.id)" class="text-gray-300 hover:text-red-500 px-1">
                   <i class="ph-bold ph-trash"></i>
                </button>
             </li>
          </ul>
        </div>
      </div>

      <div v-if="currentTab === 'itinerary'" class="space-y-6">
        
        <div v-if="shouldShowFlightCard" class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-5 text-white shadow-xl shadow-blue-500/20 relative overflow-hidden group">
          <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-all"></div>
          
          <div class="flex justify-between items-start relative z-10">
             <div>
                <span class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded text-blue-50">FLIGHT</span>
                <div class="mt-3 flex items-center gap-4">
                   <div class="text-center">
                      <div class="text-3xl font-black">{{ activeFlight.depCode }}</div>
                      <div class="text-xs opacity-80">{{ activeFlight.depTime }}</div>
                   </div>
                   <div class="flex flex-col items-center">
                      <i class="ph-fill ph-airplane-in-flight text-2xl"></i>
                      <div class="h-[1px] w-12 bg-white/30 my-1"></div>
                      <div class="text-[10px] font-mono tracking-widest opacity-70">{{ activeFlight.flightNo }}</div>
                   </div>
                   <div class="text-center">
                      <div class="text-3xl font-black">{{ activeFlight.arrCode }}</div>
                      <div class="text-xs opacity-80">{{ activeFlight.arrTime }}</div>
                   </div>
                </div>
             </div>
             <button @click="openFlightModal" class="p-2 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur-md">
                <i class="ph-bold ph-pencil-simple text-white"></i>
             </button>
          </div>
        </div>

        <div>
           <div class="flex justify-between items-end mb-3">
              <h2 class="text-lg font-bold flex items-center gap-2">
                 <span class="w-1.5 h-5 bg-blue-500 rounded-full"></span> 
                 {{ selectedDay === 'all' ? '全部行程' : '當日行程' }}
              </h2>
              <button @click="openAddModal('itinerary')" class="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                 + 新增
              </button>
           </div>

           <div v-if="sortedItinerary.length === 0" class="flex flex-col items-center justify-center py-10 opacity-50">
              <i class="ph-duotone ph-map-trifold text-4xl mb-2"></i>
              <p class="text-sm">尚未安排行程</p>
           </div>

           <div class="space-y-4 relative pl-4 border-l-2 border-dashed border-gray-200 ml-2">
              <div v-for="item in sortedItinerary" :key="item.id" class="relative group">
                 <div class="absolute -left-[25px] top-4 w-4 h-4 bg-blue-500 rounded-full border-4 border-[#F2F2F7]"></div>
                 
                 <div class="glass-panel p-4 rounded-2xl active:scale-[0.98] transition-transform" @click="openItineraryModal(item)">
                    <div class="flex justify-between items-start">
                       <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                             <span class="font-mono font-bold text-blue-600 text-lg">{{ item.time }}</span>
                             <span class="text-xs px-1.5 py-0.5 bg-gray-100 rounded text-gray-500">{{ item.category || '活動' }}</span>
                          </div>
                          <h3 class="font-bold text-gray-800 text-lg leading-tight">{{ item.title }}</h3>
                          <p v-if="item.notes" class="text-sm text-gray-500 mt-1 line-clamp-2">{{ item.notes }}</p>
                       </div>
                       
                       <button v-if="item.location" @click.stop="showLocationOnMap(item.location)" class="ml-2 w-8 h-8 flex items-center justify-center bg-green-50 text-green-600 rounded-full">
                          <i class="ph-fill ph-map-pin"></i>
                       </button>
                    </div>
                 </div>
              </div>
           </div>
        </div>
      </div>

      <div v-if="currentTab === 'shopping'" class="space-y-4">
        <div class="glass-panel p-4 rounded-3xl">
           <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold flex items-center gap-2">
                 <i class="ph-fill ph-bag text-orange-500"></i> 購物清單
              </h2>
              <button @click="openAddModal('shopping')" class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-600">
                 <i class="ph-bold ph-plus"></i>
              </button>
           </div>
           
           <div class="grid grid-cols-1 gap-3">
              <div v-for="item in shoppingList" :key="item.id" class="flex items-center gap-3 p-3 bg-white/60 rounded-xl border border-white/50 shadow-sm">
                 <div class="w-12 h-12 rounded-lg bg-gray-100 flex-none overflow-hidden flex items-center justify-center cursor-pointer relative" @click="openImageViewer(item.image)">
                    <img v-if="item.image" :src="item.image" class="w-full h-full object-cover" />
                    <i v-else class="ph-bold ph-image text-gray-300 text-xl"></i>
                 </div>
                 
                 <div class="flex-1 min-w-0" @click="openShoppingModal(item)">
                    <h3 class="font-bold text-gray-800 truncate">{{ item.name }}</h3>
                    <div class="flex items-center gap-2 mt-0.5">
                       <span class="text-xs bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded">{{ item.brand || '未分類' }}</span>
                       <span v-if="item.price" class="text-xs font-mono text-gray-500">${{ item.price }}</span>
                    </div>
                 </div>

                 <div class="flex flex-col gap-2">
                    <button v-if="item.link" @click="window.open(item.link, '_blank')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-sm">
                       <i :class="isInstagramLink(item.link) ? 'ph-bold ph-instagram-logo' : 'ph-bold ph-link'"></i>
                    </button>
                    <input type="checkbox" v-model="item.bought" @change="saveShoppingItem(item)" class="w-6 h-6 rounded-full accent-green-500" />
                 </div>
              </div>
           </div>
        </div>
      </div>

      <div v-if="currentTab === 'expenses'" class="space-y-5">
        
        <div class="glass-panel p-5 rounded-3xl relative overflow-hidden">
           <div class="absolute top-0 right-0 w-32 h-32 bg-green-400/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
           
           <div class="absolute top-4 right-4 z-10">
               <button @click="openMemberModal" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-600 shadow-sm">
                   <i class="ph-fill ph-gear"></i>
               </button>
           </div>

           <div class="relative z-10">
              <p class="text-sm text-gray-500 font-medium">總支出 (TWD)</p>
              <h2 class="text-4xl font-black text-gray-900 mt-1 tracking-tight">${{ formatNumber(totalExpense) }}</h2>
              <div class="mt-4 flex gap-3 overflow-x-auto no-scrollbar pb-1">
                  <button @click="expenseFilter = 'all'" :class="['px-3 py-1.5 rounded-full text-xs font-bold transition-all', expenseFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-500']">全部</button>
                  <button v-for="cat in expenseCategories" :key="cat.id" @click="expenseFilter = cat.id"
                    :class="['px-3 py-1.5 rounded-full text-xs font-bold transition-all flex items-center gap-1', expenseFilter === cat.id ? 'bg-gray-800 text-white' : 'bg-white text-gray-500']">
                    {{ cat.name }}
                  </button>
              </div>
           </div>
        </div>

        <div class="bg-white/50 border border-white/60 rounded-2xl p-4 shadow-sm" v-if="settlementResult.length > 0">
            <h3 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wider">目前結算 (以 {{ members[0] || '?' }} 為中心)</h3>
            <div class="space-y-2">
                <div v-for="res in settlementResult" :key="res.name" class="flex justify-between items-center text-sm">
                    <div class="font-medium text-gray-700 flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">{{ res.name[0] }}</div>
                        {{ res.name }}
                    </div>
                    <span :class="res.amount >= 0 ? 'text-green-600 font-bold' : 'text-red-500 font-bold'">
                        {{ res.amount >= 0 ? '需收取' : '需支付' }} ${{ formatNumber(Math.abs(res.amount)) }}
                    </span>
                </div>
            </div>
        </div>

        <div class="pb-20">
           <div v-if="filteredExpenses.length === 0" class="text-center py-10 text-gray-400">
              <p>無該分類支出</p>
           </div>
           
           <div class="space-y-3">
              <div v-for="exp in filteredExpenses" :key="exp.id" 
                   @click="openExpenseModal(exp)"
                   class="bg-white rounded-2xl p-3 flex items-center gap-4 shadow-sm active:bg-gray-50 transition-colors">
                 
                 <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white shadow-md bg-gradient-to-br" 
                      :class="getCategoryColor(exp.category)">
                     <i :class="getCategoryIcon(exp.category)" class="ph-fill"></i>
                 </div>

                 <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-gray-900 truncate text-base">{{ exp.item }}</h3>
                        <span class="font-mono font-bold text-gray-900 text-lg">${{ formatNumber(exp.amount) }}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-gray-400">{{ formatDate(exp.date) }}</span>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                                {{ exp.payer || '我' }} 付款
                            </span>
                        </div>
                    </div>
                 </div>
              </div>
           </div>
        </div>

        <button @click="openAddModal('expense')" class="fixed bottom-24 right-5 w-14 h-14 bg-black text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-30 active:scale-90 transition-transform">
           <i class="ph-bold ph-plus"></i>
        </button>
      </div>

      <div v-if="currentTab === 'info'" class="space-y-4">
          <div class="glass-panel p-5 rounded-3xl">
             <div class="flex justify-between items-start">
                <div>
                   <p class="text-sm text-gray-500 font-bold">匯率參考</p>
                   <h2 class="text-3xl font-black text-gray-800 mt-1">{{ formattedRate }}</h2>
                   <p class="text-xs text-gray-400 mt-1">1 TWD ≈ {{ (1/formattedRate).toFixed(3) }} JPY</p>
                </div>
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600">
                   <i class="ph-bold ph-currency-yen"></i>
                </div>
             </div>
             <div class="mt-4 pt-4 border-t border-gray-200/50 flex justify-between items-center">
                 <span class="text-xs text-gray-400">{{ lastRateUpdateLabel }}</span>
                 <button @click="forceReloadCloud" class="text-xs font-bold text-blue-600">刷新</button>
             </div>
          </div>
          
          <div class="space-y-3">
             <div v-for="info in infoList" :key="info.id" class="glass-panel p-4 rounded-2xl" @click="openInfoModal(info)">
                <h3 class="font-bold text-gray-800">{{ info.title }}</h3>
                <p class="text-sm text-gray-500 mt-1 whitespace-pre-line">{{ info.content }}</p>
             </div>
             <button @click="openAddModal('info')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold text-sm">
                + 新增資訊
             </button>
          </div>
      </div>

    </main>

    <nav class="flex-none pb-[env(safe-area-inset-bottom)] bg-white/80 backdrop-blur-xl border-t border-gray-200/50 pt-2 px-2 z-30">
      <div class="flex justify-between items-end px-1"> <button @click="currentTab = 'preparation'" :class="['flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'preparation' ? 'text-blue-600 -translate-y-1' : 'text-gray-400']">
           <i :class="[currentTab === 'preparation' ? 'ph-fill' : 'ph-bold', 'ph-suitcase-rolling text-2xl']"></i>
           <span class="text-[10px] font-medium">準備</span>
        </button>

        <button @click="currentTab = 'itinerary'" :class="['flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'itinerary' ? 'text-blue-600 -translate-y-1' : 'text-gray-400']">
           <i :class="[currentTab === 'itinerary' ? 'ph-fill' : 'ph-map-trifold text-2xl']"></i>
           <span class="text-[10px] font-medium">行程</span>
        </button>
        
        <button @click="currentTab = 'shopping'" :class="['flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'shopping' ? 'text-orange-500 -translate-y-1' : 'text-gray-400']">
           <i :class="[currentTab === 'shopping' ? 'ph-fill' : 'ph-bag text-2xl']"></i>
           <span class="text-[10px] font-medium">購物</span>
        </button>
        
        <button @click="currentTab = 'expenses'" :class="['flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'expenses' ? 'text-green-600 -translate-y-1' : 'text-gray-400']">
           <i :class="[currentTab === 'expenses' ? 'ph-fill' : 'ph-calculator text-2xl']"></i>
           <span class="text-[10px] font-medium">記帳</span>
        </button>
        
        <button @click="currentTab = 'info'" :class="['flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'info' ? 'text-purple-600 -translate-y-1' : 'text-gray-400']">
           <i :class="[currentTab === 'info' ? 'ph-fill' : 'ph-info text-2xl']"></i>
           <span class="text-[10px] font-medium">資訊</span>
        </button>
      </div>
    </nav>

    <div v-if="expenseModalOpen" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
      <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeExpenseModal"></div>
      <div class="bg-[#F2F2F7] w-full max-w-md h-[92vh] sm:h-auto sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden flex flex-col relative z-10 animate-slide-up">
        
        <div class="px-5 py-4 flex justify-between items-center bg-white border-b border-gray-100">
           <button @click="closeExpenseModal" class="text-gray-500 text-sm font-medium">取消</button>
           <h3 class="font-bold text-gray-900">{{ newExpense.id ? '編輯支出' : '新增支出' }}</h3>
           <button @click="saveExpense" class="text-blue-600 text-sm font-bold">儲存</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4">
           
           <div class="bg-white p-4 rounded-2xl shadow-sm text-right flex flex-col justify-center h-24 border border-blue-500/30 ring-4 ring-blue-500/10">
              <span class="text-gray-400 text-xs font-bold uppercase mb-1">TWD Amount</span>
              <span class="text-4xl font-black text-gray-900 tracking-tight">{{ calculatorDisplay || '0' }}</span>
           </div>

           <input v-model="newExpense.item" type="text" placeholder="消費項目名稱 (如: 晚餐)" class="w-full p-4 rounded-xl bg-white text-lg font-bold placeholder:text-gray-300 focus:outline-none" />

           <div class="grid grid-cols-4 gap-3">
              <button v-for="cat in expenseCategories" :key="cat.id"
                 @click="newExpense.category = cat.id"
                 class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all"
                 :class="newExpense.category === cat.id ? 'bg-white shadow-md ring-2 ring-black/5' : 'opacity-60 grayscale hover:grayscale-0'"
              >
                 <div class="w-10 h-10 rounded-full text-white flex items-center justify-center text-lg bg-gradient-to-br" :class="cat.color">
                    <i :class="cat.icon" class="ph-fill"></i>
                 </div>
                 <span class="text-[10px] font-bold text-gray-600">{{ cat.name }}</span>
              </button>
           </div>

           <div class="bg-white rounded-xl p-3 space-y-3">
               <div class="flex items-center justify-between">
                   <span class="text-sm font-bold text-gray-500">誰付錢?</span>
                   <div class="flex gap-2 overflow-x-auto no-scrollbar justify-end">
                       <button v-for="m in members" :key="m"
                           @click="newExpense.payer = m"
                           :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border', 
                                    newExpense.payer === m ? 'bg-black text-white border-black' : 'bg-gray-50 text-gray-600 border-gray-200']">
                           {{ m }}
                       </button>
                   </div>
               </div>
               <hr class="border-gray-100">
               <div class="flex flex-col gap-2">
                   <span class="text-sm font-bold text-gray-500">誰分攤?</span>
                   <div class="flex flex-wrap gap-2">
                       <button v-for="m in members" :key="m"
                           @click="toggleParticipant(m)"
                           :class="['px-3 py-1.5 rounded-full text-xs font-bold border transition-colors', 
                                    newExpense.involved.includes(m) ? 'bg-green-100 text-green-700 border-green-200' : 'bg-gray-50 text-gray-400 border-gray-200']">
                           {{ m }}
                           <i v-if="newExpense.involved.includes(m)" class="ph-bold ph-check ml-1"></i>
                       </button>
                   </div>
               </div>
           </div>
           
           <button v-if="newExpense.id" @click="removeExpense(newExpense.id)" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-xl">刪除此筆</button>

        </div>

        <div class="bg-gray-100 p-4 pb-8 border-t border-gray-200">
            <div class="calc-grid">
                <button @click="clearCalc" class="calc-btn text-red-500">AC</button>
                <button @click="backspaceCalc" class="calc-btn"><i class="ph-bold ph-backspace"></i></button>
                <button @click="appendOp('/')" class="calc-btn bg-orange-100 text-orange-600"><i class="ph-bold ph-divide"></i></button>
                <button @click="appendOp('*')" class="calc-btn bg-orange-100 text-orange-600"><i class="ph-bold ph-x"></i></button>

                <button @click="appendNum('7')" class="calc-btn">7</button>
                <button @click="appendNum('8')" class="calc-btn">8</button>
                <button @click="appendNum('9')" class="calc-btn">9</button>
                <button @click="appendOp('-')" class="calc-btn bg-orange-100 text-orange-600"><i class="ph-bold ph-minus"></i></button>

                <button @click="appendNum('4')" class="calc-btn">4</button>
                <button @click="appendNum('5')" class="calc-btn">5</button>
                <button @click="appendNum('6')" class="calc-btn">6</button>
                <button @click="appendOp('+')" class="calc-btn bg-orange-100 text-orange-600"><i class="ph-bold ph-plus"></i></button>

                <button @click="appendNum('1')" class="calc-btn">1</button>
                <button @click="appendNum('2')" class="calc-btn">2</button>
                <button @click="appendNum('3')" class="calc-btn">3</button>
                <button @click="evalCalc" class="calc-btn bg-black text-white"><i class="ph-bold ph-equals"></i></button>

                <button @click="appendNum('0')" class="calc-btn wide">0</button>
                <button @click="appendNum('.')" class="calc-btn">.</button>
            </div>
        </div>
      </div>
    </div>

    <div v-if="memberModalOpen" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="memberModalOpen = false"></div>
        <div class="bg-white w-full max-w-xs rounded-2xl p-5 relative z-10 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">成員管理</h3>
            <p class="text-xs text-gray-400 mb-4 text-center">第一位成員預設為結算中樞</p>
            
            <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                <div v-for="(m, idx) in members" :key="idx" class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                    <span class="font-bold text-gray-800" :class="idx === 0 ? 'text-blue-600' : ''">
                        {{ m }} <span v-if="idx===0" class="text-[10px] bg-blue-100 px-1 rounded ml-1">中樞</span>
                    </span>
                    <button v-if="members.length > 1" @click="removeMember(idx)" class="text-red-400"><i class="ph-bold ph-minus-circle"></i></button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input v-model="newMemberName" placeholder="新成員名稱" class="flex-1 bg-gray-100 px-3 py-2 rounded-lg text-sm outline-none">
                <button @click="addMember" class="bg-black text-white px-4 py-2 rounded-lg text-sm font-bold">新增</button>
            </div>
            <button @click="memberModalOpen = false" class="w-full mt-4 py-3 bg-gray-100 rounded-xl font-bold text-sm">完成</button>
        </div>
    </div>

    <div v-if="preNoteModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closePreNoteModal"></div>
       <div class="bg-white w-full max-w-sm rounded-3xl p-5 relative z-10 shadow-2xl space-y-4">
          <h3 class="font-bold text-center">新增行前待辦</h3>
          <input v-model="newPreNote.text" class="w-full bg-gray-100 p-3 rounded-xl outline-none" placeholder="例如: 買Sim卡" autofocus />
          <div class="flex gap-3">
             <button @click="closePreNoteModal" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">取消</button>
             <button @click="savePreNoteEdit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">儲存</button>
          </div>
       </div>
    </div>

    <div v-if="itineraryModalOpen" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeItineraryModal"></div>
       <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 relative z-10 space-y-4 animate-slide-up">
          <h3 class="font-bold text-xl mb-4">{{ newItineraryItem.id ? '編輯行程' : '新增行程' }}</h3>
          <input v-model="newItineraryItem.title" placeholder="標題" class="w-full bg-gray-50 p-3 rounded-xl font-bold" />
          <div class="flex gap-2">
             <input v-model="newItineraryItem.time" type="time" class="bg-gray-50 p-3 rounded-xl font-mono" />
             <select v-model="newItineraryItem.category" class="bg-gray-50 p-3 rounded-xl flex-1">
                <option>景點</option><option>餐飲</option><option>交通</option><option>購物</option><option>住宿</option>
             </select>
          </div>
          <textarea v-model="newItineraryItem.notes" placeholder="備註" class="w-full bg-gray-50 p-3 rounded-xl h-20"></textarea>
          <input v-model="newItineraryItem.location" placeholder="Google Maps 連結或地址" class="w-full bg-gray-50 p-3 rounded-xl text-sm" />
          <div class="flex gap-3 mt-4">
             <button v-if="newItineraryItem.id" @click="removeItineraryItem(newItineraryItem.id)" class="text-red-500 p-3"><i class="ph-bold ph-trash"></i></button>
             <div class="flex-1 flex gap-3">
                <button @click="closeItineraryModal" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">取消</button>
                <button @click="saveItineraryItem" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">儲存</button>
             </div>
          </div>
       </div>
    </div>

    <div v-if="flightModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeFlightModal"></div>
       <div class="bg-white w-full max-w-sm rounded-3xl p-5 relative z-10 space-y-3">
          <h3 class="font-bold text-center">航班資訊</h3>
          <div class="grid grid-cols-2 gap-2">
             <input v-model="newFlight.depCode" placeholder="出發地 (TPE)" class="bg-gray-50 p-2 rounded text-center uppercase font-black" />
             <input v-model="newFlight.arrCode" placeholder="目的地 (KIX)" class="bg-gray-50 p-2 rounded text-center uppercase font-black" />
             <input v-model="newFlight.depTime" type="text" placeholder="起飛時間" class="bg-gray-50 p-2 rounded text-center" />
             <input v-model="newFlight.arrTime" type="text" placeholder="抵達時間" class="bg-gray-50 p-2 rounded text-center" />
          </div>
          <input v-model="newFlight.flightNo" placeholder="航班號碼" class="w-full bg-gray-50 p-2 rounded text-center" />
          <button @click="saveFlight" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-2">更新航班</button>
       </div>
    </div>

    <div v-if="shoppingModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeShoppingModal"></div>
       <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 space-y-3">
          <h3 class="font-bold">{{ newShoppingItem.id ? '編輯物品' : '新增物品' }}</h3>
          <input v-model="newShoppingItem.name" placeholder="品名" class="w-full bg-gray-50 p-3 rounded-xl font-bold" />
          <input v-model="newShoppingItem.brand" placeholder="品牌/分類" class="w-full bg-gray-50 p-3 rounded-xl" />
          <input v-model="newShoppingItem.price" type="number" placeholder="預算" class="w-full bg-gray-50 p-3 rounded-xl" />
          <input v-model="newShoppingItem.link" placeholder="網址" class="w-full bg-gray-50 p-3 rounded-xl text-sm" />
          
          <div class="mt-2">
             <label class="block text-xs font-bold text-gray-400 mb-1">圖片上傳</label>
             <input type="file" @change="handleFileUpload" class="text-sm text-gray-500" />
             <div v-if="isUploading" class="text-xs text-blue-500 mt-1">上傳中...</div>
             <img v-if="tempUploadPreview" :src="tempUploadPreview" class="h-20 rounded-lg mt-2 border" />
          </div>

          <div class="flex gap-3 mt-4">
              <button v-if="newShoppingItem.id" @click="removeShoppingItem(newShoppingItem.id)" class="text-red-500"><i class="ph-bold ph-trash"></i></button>
              <button @click="saveShoppingItem(null)" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">儲存</button>
          </div>
       </div>
    </div>

    <div v-if="infoModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeInfoModal"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 space-y-3">
           <input v-model="newInfoItem.title" placeholder="標題" class="w-full bg-gray-50 p-3 rounded-xl font-bold" />
           <textarea v-model="newInfoItem.content" placeholder="內容..." class="w-full bg-gray-50 p-3 rounded-xl h-32"></textarea>
           <div class="flex gap-3">
              <button v-if="newInfoItem.id" @click="removeInfo(newInfoItem.id)" class="text-red-500"><i class="ph-bold ph-trash"></i></button>
              <button @click="saveInfoItem" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold">儲存</button>
           </div>
        </div>
    </div>

    <div v-if="imageViewer.open" class="fixed inset-0 z-[60] bg-black flex items-center justify-center p-2" @click="imageViewer.open = false">
       <img :src="imageViewer.src" class="max-w-full max-h-full rounded shadow-2xl" />
    </div>

  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted, reactive } = Vue;
    const supabaseUrl = 'YOUR_SUPABASE_URL'; // Replace in real env if needed, keeping structure
    const supabaseKey = 'YOUR_SUPABASE_KEY'; 

    createApp({
      setup() {
        const appVersion = "v251219-5.0.1";
        
        // --- State ---
        const currentTab = ref('preparation'); // New default left-most tab
        const syncState = ref(false);
        const syncStatusText = ref('');
        const weather = ref(null);
        
        // Data Arrays
        const days = ref([
           { label: 'DAY 1', dateStr: '12/28', fullDate: '2023-12-28' },
           { label: 'DAY 2', dateStr: '12/29', fullDate: '2023-12-29' },
           { label: 'DAY 3', dateStr: '12/30', fullDate: '2023-12-30' },
           { label: 'DAY 4', dateStr: '12/31', fullDate: '2023-12-31' },
           { label: 'DAY 5', dateStr: '01/01', fullDate: '2024-01-01' },
           { label: 'DAY 6', dateStr: '01/02', fullDate: '2024-01-02' }
        ]);
        const selectedDay = ref(days.value[0]);
        const itinerary = ref([]); 
        const shoppingList = ref([]);
        const expenses = ref([]);
        const infoList = ref([]);
        const preTripNotes = ref([]);
        const flightData = ref({ depCode:'TPE', arrCode:'KIX', depTime:'09:00', arrTime:'12:30', flightNo:'JX820' });
        
        // Members & Settlement
        const members = ref(['我', 'B', 'C', 'D']); // Default members
        const memberModalOpen = ref(false);
        const newMemberName = ref('');

        // Expenses Categories (New iOS 26 Style)
        const expenseCategories = [
           { id: 'tickets', name: '門票', icon: 'ph-ticket', color: 'from-purple-500 to-indigo-500' },
           { id: 'transport', name: '交通', icon: 'ph-train', color: 'from-blue-400 to-cyan-400' },
           { id: 'shopping', name: '購物', icon: 'ph-bag', color: 'from-orange-400 to-red-400' },
           { id: 'dining', name: '餐飲', icon: 'ph-hamburger', color: 'from-yellow-400 to-orange-500' },
           { id: 'entertainment', name: '娛樂', icon: 'ph-confetti', color: 'from-pink-500 to-rose-500' },
           { id: 'accommodation', name: '住宿', icon: 'ph-bed', color: 'from-teal-400 to-emerald-500' },
           { id: 'service', name: '服務', icon: 'ph-hand-coins', color: 'from-gray-400 to-gray-600' },
           { id: 'other', name: '其他', icon: 'ph-dots-three-circle', color: 'from-slate-400 to-slate-500' }
        ];

        // Modals
        const preNoteModalOpen = ref(false);
        const itineraryModalOpen = ref(false);
        const shoppingModalOpen = ref(false);
        const expenseModalOpen = ref(false);
        const infoModalOpen = ref(false);
        const flightModalOpen = ref(false);

        // Temp Forms
        const newPreNote = reactive({ id: null, text: '', done: false });
        const newItineraryItem = reactive({ id:null, title:'', time:'', category:'景點', notes:'', location:'' });
        const newShoppingItem = reactive({ id:null, name:'', brand:'', price:'', link:'', bought: false, image: null });
        const newExpense = reactive({ id:null, item:'', amount:0, category:'dining', date: new Date().toISOString(), payer: '', involved: [] });
        const newInfoItem = reactive({ id:null, title:'', content:'' });
        const newFlight = reactive({ ...flightData.value });

        // Calculator Logic
        const calculatorDisplay = ref('0');

        // File Upload
        const isUploading = ref(false);
        const tempUploadPreview = ref(null);
        
        // Image Viewer
        const imageViewer = reactive({ open: false, src: '' });

        // Rate
        const jpyRate = ref(0.225);
        const lastRateUpdate = ref(Date.now());

        // --- Computed ---
        const currentTabTitle = computed(() => {
           const titles = { preparation: 'Travel Sync', itinerary: 'My Plan', shopping: 'Wishlist', expenses: 'Wallet', info: 'Guide' };
           return titles[currentTab.value];
        });

        const sortedItinerary = computed(() => {
           // Filter by day
           let items = itinerary.value;
           if (selectedDay.value !== 'all') {
               items = items.filter(i => i.dayLabel === selectedDay.value.label);
           }
           return items.sort((a,b) => a.time.localeCompare(b.time));
        });

        const activeFlight = computed(() => flightData.value);
        const shouldShowFlightCard = computed(() => selectedDay.value.label === 'DAY 1' || selectedDay.value.label === 'DAY 6'); // Simple logic

        const expenseFilter = ref('all');
        const filteredExpenses = computed(() => {
           if (expenseFilter.value === 'all') return expenses.value.sort((a,b) => new Date(b.date) - new Date(a.date));
           return expenses.value.filter(e => e.category === expenseFilter.value).sort((a,b) => new Date(b.date) - new Date(a.date));
        });

        const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + Number(cur.amount), 0));

        const weatherIconClass = computed(() => {
           if(!weather.value) return 'ph-cloud';
           const id = weather.value.weather[0].id;
           if(id < 300) return 'ph-cloud-lightning';
           if(id < 600) return 'ph-cloud-rain';
           if(id < 700) return 'ph-snowflake';
           if(id === 800) return 'ph-sun';
           return 'ph-cloud';
        });

        const formattedRate = computed(() => jpyRate.value.toFixed(4));
        const lastRateUpdateLabel = computed(() => new Date(lastRateUpdate.value).toLocaleTimeString());

        // Settlement Logic (Strictly based on prompt example)
        const settlementResult = computed(() => {
            const balances = {};
            members.value.forEach(m => balances[m] = 0);

            expenses.value.forEach(exp => {
                const cost = Number(exp.amount);
                const payer = exp.payer || members.value[0];
                const parts = exp.involved && exp.involved.length > 0 ? exp.involved : members.value;
                
                // Net logic: Payer +Cost, Everyone Involved -Split
                const split = cost / parts.length;
                
                // Payer gets credit for the full amount they paid out
                if (balances[payer] !== undefined) {
                    balances[payer] += cost;
                }
                
                // Each participant consumes their share (deducted from their net position)
                parts.forEach(p => {
                    if (balances[p] !== undefined) {
                        balances[p] -= split;
                    }
                });
            });

            // If Hub logic is requested, usually we just show the net list.
            // Positive = Receives money. Negative = Pays money.
            // Prompt Example check:
            // A pays 1000 for ABCD (250 each). A +1000, A-250, B-250... -> A net +750. Correct.
            
            return members.value.map(m => ({
                name: m,
                amount: Math.round(balances[m])
            })).filter(r => r.amount !== 0); // Hide 0s
        });

        // --- Methods ---

        function getStatusClass() { return 'text-green-500'; } // Dummy
        function formatNumber(num) { return Number(num).toLocaleString(); }
        function formatDate(d) { return new Date(d).toLocaleDateString(); }
        
        function selectDay(d) { selectedDay.value = d; }
        
        // Navigation Logic for Pre-trip
        // Preparation is now a tab, no longer just a modal, but data is same
        
        // Modals Open/Close
        const openAddModal = (type) => {
           if(type === 'preNote') { newPreNote.text = ''; newPreNote.id = null; preNoteModalOpen.value = true; }
           if(type === 'itinerary') { 
              Object.assign(newItineraryItem, { id:null, title:'', time:'10:00', category:'景點', notes:'', location:'' }); 
              itineraryModalOpen.value = true; 
           }
           if(type === 'shopping') { Object.assign(newShoppingItem, {id:null, name:'', brand:'', price:'', link:'', bought:false, image:null}); tempUploadPreview.value = null; shoppingModalOpen.value = true; }
           if(type === 'expense') { 
               // Init Expense
               const defaultPayer = expenses.value.length > 0 ? expenses.value[0].payer : members.value[0];
               Object.assign(newExpense, { id:null, item:'', amount:0, category:'dining', date: new Date().toISOString(), payer: defaultPayer, involved: [...members.value] });
               calculatorDisplay.value = '0'; // Reset Calc
               expenseModalOpen.value = true; 
           }
           if(type === 'info') { Object.assign(newInfoItem, {id:null, title:'', content:''}); infoModalOpen.value = true; }
        };

        // PreNote
        function togglePreNoteDone(n) { n.done = !n.done; saveAll(); }
        function editPreNote(n) { Object.assign(newPreNote, n); preNoteModalOpen.value = true; }
        function removePreNote(id) { preTripNotes.value = preTripNotes.value.filter(n => n.id !== id); saveAll(); }
        function savePreNoteEdit() {
           if(!newPreNote.text) return;
           if(newPreNote.id) {
              const idx = preTripNotes.value.findIndex(n => n.id === newPreNote.id);
              if(idx !== -1) preTripNotes.value[idx] = { ...newPreNote };
           } else {
              preTripNotes.value.push({ ...newPreNote, id: Date.now(), done: false });
           }
           saveAll();
           closePreNoteModal();
        }
        function closePreNoteModal() { preNoteModalOpen.value = false; }

        // Itinerary
        function openItineraryModal(item) { Object.assign(newItineraryItem, item); itineraryModalOpen.value = true; }
        function closeItineraryModal() { itineraryModalOpen.value = false; }
        function saveItineraryItem() {
           if(!newItineraryItem.title) return;
           if(newItineraryItem.id) {
              const idx = itinerary.value.findIndex(i => i.id === newItineraryItem.id);
              itinerary.value[idx] = { ...newItineraryItem, dayLabel: selectedDay.value.label }; // keep day
           } else {
              itinerary.value.push({ ...newItineraryItem, id: Date.now(), dayLabel: selectedDay.value.label });
           }
           saveAll(); closeItineraryModal();
        }
        function removeItineraryItem(id) { itinerary.value = itinerary.value.filter(i => i.id !== id); saveAll(); closeItineraryModal(); }
        function showLocationOnMap(loc) { window.open(loc.startsWith('http') ? loc : `https://maps.google.com/?q=${loc}`, '_blank'); }

        // Flight
        function openFlightModal() { Object.assign(newFlight, flightData.value); flightModalOpen.value = true; }
        function closeFlightModal() { flightModalOpen.value = false; }
        function saveFlight() { flightData.value = { ...newFlight }; saveAll(); closeFlightModal(); }

        // Shopping
        function openShoppingModal(item) { Object.assign(newShoppingItem, item); tempUploadPreview.value = item.image; shoppingModalOpen.value = true; }
        function closeShoppingModal() { shoppingModalOpen.value = false; }
        function saveShoppingItem(item) {
           if(item) { saveAll(); return; } // checkbox update
           if(!newShoppingItem.name) return;
           newShoppingItem.image = tempUploadPreview.value;
           if(newShoppingItem.id) {
               const idx = shoppingList.value.findIndex(i => i.id === newShoppingItem.id);
               shoppingList.value[idx] = { ...newShoppingItem };
           } else {
               shoppingList.value.push({ ...newShoppingItem, id: Date.now() });
           }
           saveAll(); closeShoppingModal();
        }
        function removeShoppingItem(id) { shoppingList.value = shoppingList.value.filter(i => i.id !== id); saveAll(); closeShoppingModal(); }
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            isUploading.value = true;
            const reader = new FileReader();
            reader.onload = (evt) => {
                tempUploadPreview.value = evt.target.result;
                isUploading.value = false;
            };
            reader.readAsDataURL(file);
        }
        function openImageViewer(src) { if(src) { imageViewer.src = src; imageViewer.open = true; } }
        function isInstagramLink(l) { return l && l.includes('instagram'); }

        // Expenses & Members
        function openExpenseModal(exp) { 
            Object.assign(newExpense, exp); 
            // Ensure legacy data has payer/involved
            if(!newExpense.payer) newExpense.payer = members.value[0];
            if(!newExpense.involved) newExpense.involved = [...members.value];
            calculatorDisplay.value = String(newExpense.amount);
            expenseModalOpen.value = true; 
        }
        function closeExpenseModal() { expenseModalOpen.value = false; }
        function saveExpense() {
            if(!newExpense.item) return;
            newExpense.amount = parseFloat(calculatorDisplay.value) || 0; // Take from calculator
            if(newExpense.id) {
                const idx = expenses.value.findIndex(e => e.id === newExpense.id);
                expenses.value[idx] = { ...newExpense };
            } else {
                expenses.value.unshift({ ...newExpense, id: Date.now() });
            }
            saveAll(); closeExpenseModal();
        }
        function removeExpense(id) { expenses.value = expenses.value.filter(e => e.id !== id); saveAll(); closeExpenseModal(); }
        
        function getCategoryIcon(id) { const c = expenseCategories.find(x => x.id === id); return c ? c.icon : 'ph-tag'; }
        function getCategoryColor(id) { const c = expenseCategories.find(x => x.id === id); return c ? c.color : 'from-gray-400 to-gray-600'; }

        // Member Management
        function openMemberModal() { memberModalOpen.value = true; }
        function addMember() { if(newMemberName.value){ members.value.push(newMemberName.value); newMemberName.value=''; saveAll(); } }
        function removeMember(idx) { members.value.splice(idx, 1); saveAll(); }
        function toggleParticipant(m) {
            if(newExpense.involved.includes(m)) {
                // Prevent removing the last person
                if(newExpense.involved.length > 1)
                    newExpense.involved = newExpense.involved.filter(x => x !== m);
            } else {
                newExpense.involved.push(m);
            }
        }

        // Calculator Logic
        function appendNum(char) {
            if(calculatorDisplay.value === '0' && char !== '.') calculatorDisplay.value = '';
            calculatorDisplay.value += char;
        }
        function appendOp(op) {
            const lastChar = calculatorDisplay.value.slice(-1);
            if(['+','-','*','/'].includes(lastChar)) return;
            calculatorDisplay.value += op;
        }
        function clearCalc() { calculatorDisplay.value = '0'; }
        function backspaceCalc() {
            calculatorDisplay.value = calculatorDisplay.value.slice(0, -1);
            if(calculatorDisplay.value === '') calculatorDisplay.value = '0';
        }
        function evalCalc() {
            try {
                // Safe eval for calc
                // eslint-disable-next-line no-eval
                const res = eval(calculatorDisplay.value);
                calculatorDisplay.value = String(parseFloat(res.toFixed(2))); // rounding
            } catch(e) {
                calculatorDisplay.value = 'Error';
                setTimeout(() => calculatorDisplay.value = '0', 1000);
            }
        }

        // Info
        function openInfoModal(item) { Object.assign(newInfoItem, item); infoModalOpen.value = true; }
        function closeInfoModal() { infoModalOpen.value = false; }
        function saveInfoItem() {
           if(!newInfoItem.title) return;
           if(newInfoItem.id) {
               const idx = infoList.value.findIndex(i => i.id === newInfoItem.id);
               infoList.value[idx] = { ...newInfoItem };
           } else {
               infoList.value.push({ ...newInfoItem, id: Date.now() });
           }
           saveAll(); closeInfoModal();
        }
        function removeInfo(id) { infoList.value = infoList.value.filter(i => i.id !== id); saveAll(); closeInfoModal(); }
        function forceReloadCloud() { 
            // Mock reload rate
            jpyRate.value = 0.22 + Math.random() * 0.01; 
            lastRateUpdate.value = Date.now();
        }

        // Persistence
        function saveAll() {
           const data = {
              itinerary: itinerary.value,
              shoppingList: shoppingList.value,
              expenses: expenses.value,
              infoList: infoList.value,
              preTripNotes: preTripNotes.value,
              flightData: flightData.value,
              members: members.value
           };
           localStorage.setItem('travelSyncData_v5', JSON.stringify(data));
        }

        function loadAll() {
           const saved = localStorage.getItem('travelSyncData_v5');
           if(saved) {
              const d = JSON.parse(saved);
              if(d.itinerary) itinerary.value = d.itinerary;
              if(d.shoppingList) shoppingList.value = d.shoppingList;
              if(d.expenses) expenses.value = d.expenses;
              if(d.infoList) infoList.value = d.infoList;
              if(d.preTripNotes) preTripNotes.value = d.preTripNotes;
              if(d.flightData) flightData.value = d.flightData;
              if(d.members) members.value = d.members;
           }
        }

        onMounted(() => {
           loadAll();
           // Mock Weather
           weather.value = { weather: [{id: 800}], main: { temp: 18 } };
        });

        watch([itinerary, shoppingList, expenses, infoList, preTripNotes, flightData, members], () => saveAll(), { deep: true });

        return {
           appVersion, syncState, syncStatusText, forceReloadCloud,
           currentTab, currentTabTitle, days, selectDay, selectedDay, isFlightDay: shouldShowFlightCard,
           weather, weatherIconClass, formattedRate, lastRateUpdateLabel,
           activeFlight, shouldShowFlightCard, getStatusClass,
           
           // Preparation
           preTripNotes, newPreNote, openAddModal, removePreNote, editPreNote, togglePreNoteDone, preNoteModalOpen, closePreNoteModal, savePreNoteEdit,

           // Itinerary
           sortedItinerary, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem, itineraryModalOpen, newItineraryItem, showLocationOnMap,

           // Shopping
           shoppingList, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, shoppingModalOpen, newShoppingItem, isInstagramLink,
           handleFileUpload, uploadStatus: null, tempUploadPreview, isUploading,
           imageViewer, openImageViewer,

           // Expenses
           expenses, totalExpense, filteredExpenses, expenseFilter, openExpenseModal, closeExpenseModal, saveExpense, removeExpense, expenseModalOpen, newExpense,
           expenseCategories, getCategoryIcon, getCategoryColor,
           settlementResult, members, memberModalOpen, openMemberModal, closeMemberModal: ()=>memberModalOpen.value=false, addMember, removeMember, newMemberName, toggleParticipant,
           // Calculator
           calculatorDisplay, appendNum, appendOp, clearCalc, backspaceCalc, evalCalc,

           // Info
           infoList, openInfoModal, closeInfoModal, saveInfoItem, removeInfo, infoModalOpen, newInfoItem,
           
           // Flight
           flightModalOpen, newFlight, openFlightModal, closeFlightModal, saveFlight,
           
           formatNumber, formatDate
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
