<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>eMenu Taipei â€” è¡Œç¨‹åŠ©æ‰‹</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.86);
      --card-radius: 18px;
    }
    html,body,#app { height:100%; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-color:#0f172a;
      margin:0;
    }
    /* hide scrollbar on WebKit */
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    /* small fade animation */
    .fade-enter-active, .fade-leave-active { transition: opacity .25s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    /* safe bottom padding for phones */
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    
    /* è‡ªè¨‚é¡åˆ¥ï¼šç”¨æ–¼å·²å®Œæˆçš„æ·±ç°è‰²æ–‡å­—èˆ‡åˆªé™¤ç·š */
    .task-done {
        text-decoration: line-through;
        color: #6b7280; /* Tailwind gray-500 */
    }

    /* ğŸ¯ èª¿æ•´ Dock æ¨£å¼ä»¥æ¨¡æ“¬ iPhone Dock ï¼ˆæ›´å¤§ã€åŠé€æ˜ï¼‰*/
    .iphone-dock {
        background: rgba(255,255,255,0.68);
        backdrop-filter: blur(10px);
        border-radius: 28px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.12);
        padding: 0.6rem 1.2rem;
        border: 1px solid rgba(255,255,255,0.35);
    }

    .iphone-dock button i { font-size: 1.25rem; }

    /* å¡ç‰‡ç´°ç¯€ */
    .glass-card { border-radius: var(--card-radius); background: rgba(255,255,255,0.88); border: 1px solid rgba(255,255,255,0.35);
    padding: 0.75rem; box-shadow: 0 8px 24px rgba(2,6,23,0.06); }

  </style>
</head>

<body>
  <div id="app" class="relative min-h-screen flex flex-col">

    <div class="absolute inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover opacity-100" alt="Taipei Background">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-100/75 via-slate-100/55 to-slate-200/85"></div>
    </div>

    <main class="relative z-10 flex-1 overflow-y-auto no-scrollbar pb-safe pt-6 px-4">

      <div class="flex items-center justify-between mb-4">
       
        <div>
          <h1 class="text-2xl font-bold text-gray-800">eMenu Taipei <span class="ml-1 text-sm">ğŸ‡¹ğŸ‡¼</span></h1>
          <p class="text-xs text-gray-500 mt-1">å°åŒ— 12/15 â€” 12/18</p>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-bold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-md border border-emerald-200 inline-block">å³æ™‚åŒ¯ç‡</div>
          <div class="text-xs font-bold text-gray-600 mt-1">
            1 TWD â‰ˆ 
            <span class="text-emerald-600 text-sm">{{ formattedRate }}</span> HKD
            <div class="text-[10px] text-gray-400">æ›´æ–°ï¼š{{ lastRateUpdateLabel }}</div>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
          <button @click="currentTab = 'è¡Œå‰'" 
                  class="flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center text-xs font-semibold transition-transform"
                  :class="currentTab === 'è¡Œå‰' ?
                  'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 border border-white/40 text-gray-600'">
             è¡Œå‰
          </button>
          
          <button @click="currentTab = 'åœ°åœ–'" 
                  class="flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center text-xs font-semibold transition-transform"
                  :class="currentTab === 'åœ°åœ–' ?
                  'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 border border-white/40 text-gray-600'">
             åœ°åœ–
          </button>

          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = 'è¡Œç¨‹'"
                  class="flex-shrink-0 w-20 h-12 rounded-xl flex flex-col items-center justify-center transition-transform"
                  :class="selectedDay === i && currentTab === 'è¡Œç¨‹' ?
                  'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 text-gray-600 border border-white/40'">
            <span class="text-[11px]">{{ d.week }}</span>
            <span class="text-sm font-bold">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div class="space-y-4 mb-4">
        <div class="glass-card">
    
          <div class="flex items-center justify-between">
            <div class="flex items-baseline gap-3">
              <div class="text-3xl font-bold text-gray-800">{{ weather.temp }}Â°</div>
              <div class="text-xs text-gray-600">
                <div class="font-medium">{{ weather.desc }}</div>
                <div class="text-[12px] text-gray-500">é™é›¨æ©Ÿç‡ {{ weather.rain }}%</div>
 
              </div>
            </div>
            <div class="text-2xl text-sky-500">
              <i :class="weatherIconClass"></i>
            </div>
          </div>
        </div>

        <transition name="fade">
       
          <div v-if="shouldShowFlightCard" 
                 class="rounded-2xl p-4 text-white shadow-lg" 
                 style="background: linear-gradient(135deg,#60a5fa 0%,#2dd4bf 100%);">
              <div class="flex justify-between items-center mb-3">
                <div class="text-xs font-bold bg-white/20 px-2 py-1 rounded">FLIGHT</div>
            
     
                <div class="text-xs text-right">
                    <div class="font-mono font-semibold text-lg">{{ activeFlight.depTime }}</div>
                    <div class="text-xs opacity-80 mt-1">Arr.
                    {{ activeFlight.arrTime }}</div>
                </div>

              </div>

              <div class="flex items-center justify-between">
                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">from</div>
            
                  <div class="text-3xl font-bold tracking-widest">{{ activeFlight.fromCode }}</div>
                  <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.fromTerminal }}</div>
                </div>

                <div class="flex-1 px-4 text-center">
                  <i class="ph ph-airplane-tilt text-2xl"></i>
        
                    <div class="h-0.5 bg-white/30 my-3"></div>
                  <div class="text-xs opacity-75">{{ activeFlight.note }}</div>
                </div>

                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">to</div>
          
                    <div class="text-3xl font-bold tracking-widest">{{ activeFlight.toCode }}</div>
                   <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.toTerminal }}</div>
                </div>
              </div>

              <div class="mt-4 flex justify-between items-center">
             
                    <div class="text-sm">{{ activeFlight.code }} â€” {{ activeFlight.title }}</div>
                <div class="bg-white text-sky-600 px-3 py-1 rounded-full text-xs font-bold">å·²ç¢ºèª</div>
              </div>
            </div>
        </transition>
      </div>

      <div class="flex justify-end mb-3">
        <button @click="openAddModal" class="bg-sky-600 
        text-white px-4 py-2 rounded-lg shadow">+ æ–°å¢</button>
      </div>

      <div class="rounded-2xl p-3 bg-white/85 border border-white/30 backdrop-blur shadow">

        <div>

          <div v-if="currentTab === 'è¡Œå‰'">
       
            <h3 class="text-base font-bold mb-2">âœ… è¡Œå‰æº–å‚™æ¸…å–®</h3>
            <ul class="space-y-2">
              <li v-for="(note, i) in preTripNotes" :key="i" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <i class="ph text-xl cursor-pointer" 
           
                  :class="note.isDone ?
                  'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="note.isDone = !note.isDone">
                  </i>
                  <span class="font-medium" :class="{'task-done': note.isDone, 'text-gray-900': !note.isDone}">{{ note.name }}</span>
                </div>
             
                <button class="text-red-500 text-base" @click="removePreNote(i)"><i class="ph ph-trash"></i></button>
              </li>
              <li v-if="preTripNotes.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">
                è«‹æ–°å¢è¡Œå‰æº–å‚™äº‹é …ï¼
              </li>
            </ul>

            
            <div class="mt-3">
              <label class="text-xs text-gray-600">æ–°å¢æº–å‚™äº‹é …</label>
              <div class="flex gap-2 mt-1">
                <input v-model="newPreNote" @keyup.enter="addPreNote" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="ä¾‹å¦‚ï¼šå…Œæ›å°å¹£ã€è³¼è²· SIM å¡">
                <button @click="addPreNote" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
              </div>
     
            </div>
          </div>

          <div v-if="currentTab === 'åœ°åœ–'">
            <h3 class="text-base font-bold mb-2">ğŸ“ åœ°åœ–èˆ‡å°èˆª</h3>
            <div class="p-4 rounded-xl bg-sky-100 border-sky-200 border-2 text-sky-800 mb-4">
                <i class="ph ph-warning-circle text-lg mr-1"></i>
                <span class="text-sm font-medium">æ³¨æ„ï¼šç›®å‰åƒ…é¡¯ç¤ºç•¶æ—¥ç¬¬ä¸€å€‹æœ‰åœ°å€çš„è¡Œç¨‹ã€‚</span>
            </div>

            <div v-if="activeMapItem" class="glass-card p-4">
                <h4 class="text-lg font-bold mb-2 text-gray-800">{{ activeMapItem.title }}</h4>
                <p class="text-sm text-gray-500 mb-4">{{ activeMapItem.address }}</p>

                <div class="flex justify-center gap-4">
                    <a :href="activeMapItem.gMapUrl" target="_blank" 
                       class="flex-1 max-w-[200px] bg-white border border-gray-300 text-gray-700 py-3 rounded-lg text-center font-medium transition hover:bg-gray-50">
                        <i class="ph ph-map-trifold mr-1"></i>
                        åœ¨ Google åœ°åœ–ä¸­æ‰“é–‹
                    </a>
                    <a :href="activeMapItem.gMapNavUrl" target="_blank" 
                       class="flex-1 max-w-[200px] bg-emerald-500 text-white py-3 rounded-lg text-center font-bold transition hover:bg-emerald-600">
                        <i class="ph ph-steering-wheel mr-1"></i>
                        é–‹å§‹å°èˆª
                    </a>
                </div>
            </div>
            <div v-else class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">
                ä»Šæ—¥è¡Œç¨‹ä¸­æ²’æœ‰å¯é¡¯ç¤ºåœ°å€çš„é …ç›®ã€‚
            </div>
          </div>
          <div v-if="currentTab === 'è¡Œç¨‹'">
            <h3 class="text-base font-bold mb-2">ä»Šæ—¥è¡Œç¨‹ â€” {{ days[selectedDay].label }}</h3>
            <ul class="space-y-2">
              <li v-for="(it, idx) in itinerary[selectedDay]" :key="idx" 
      
                class="p-3 rounded-lg bg-white/80 border border-white/30 flex justify-between items-center">
                <div class="flex-1">
                  <div class="font-medium">{{ it.title }}</div>
                  <div class="text-xs text-gray-500">{{ it.note }}</div>
                </div>
     
                <div class="flex items-center gap-2">
                    <div class="text-sm text-gray-500 mr-2">{{ it.time || '' }}</div>
                    <button @click="removeItineraryItem(idx)" class="text-red-500 text-base hover:text-red-600 transition">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            
              </li>
            </ul>

            <div class="mt-3">
              <label class="text-xs text-gray-600">åŠ å…¥è¡Œç¨‹</label>
              <div class="flex gap-2 mt-1">
                <input v-model="newItemText" @keyup.enter="addItineraryItem" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="è¼¸å…¥è¡Œç¨‹é …ç›®">
                
                <button @click="addItineraryItem" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
              </div>
            </div>
          </div>

          <div v-if="currentTab === 'ç¾é£Ÿ'">
            <h3 class="text-base font-bold mb-2">ç¾é£Ÿæ¸…å–®</h3>
            <ul class="space-y-2">
      
                <li v-for="(f,i) in foodList" :key="i" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="font-medium">{{ f }}</div>
                <button class="text-red-500 text-sm" @click="removeFood(i)">åˆªé™¤</button>
              </li>
            </ul>

            <div class="mt-3 flex gap-2">
  
                <input v-model="newFood" @keyup.enter="addFood" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="æ–°å¢ç¾é£Ÿ">
              <button @click="addFood" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
            </div>
          </div>

          <div v-if="currentTab === 'æ™¯é»'">
            <h3 class="text-base 
            font-bold mb-2">æ™¯é»æ”¶è—</h3>
            <ul class="space-y-2">
              <li v-for="(s,i) in spots" :key="i" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="font-medium">{{ s }}</div>
                <button class="text-red-500 text-sm" @click="removeSpot(i)">åˆªé™¤</button>
              </li>
         
            </ul>

            <div class="mt-3 flex gap-2">
              <input v-model="newSpot" @keyup.enter="addSpot" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="æ–°å¢æ™¯é»">
              <button @click="addSpot" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
            </div>
          </div>

          <div v-if="currentTab === 'äº¤é€š'">
            <h3 class="text-base font-bold mb-2">äº¤é€šç­†è¨˜</h3>
            <div class="text-sm text-gray-600">ä»¥è¨ˆç¨‹è»Šç‚ºä¸»ï¼›å‡ºç™¼å‰ 10:30 å‰éœ€ä¼‘æ¯ã€‚</div>
            <div class="mt-3 space-y-2">
              <div class="p-3 rounded-lg bg-white/80 border">é è¨ˆäº¤é€šï¼šè¨ˆç¨‹è»Š / ç´„ 30â€“45 åˆ†é˜è‡³æ©Ÿå ´</div>
              <div class="p-3 rounded-lg bg-white/80 border">æ©Ÿå ´åˆ°é”å»ºè­°ï¼šæå‰ 2 å°æ™‚æŠµé”</div>
       
            </div>
          </div>

          <div v-if="currentTab === 'è³¼ç‰©'">
            <h3 class="text-base font-bold mb-2">ğŸ›’ è³¼ç‰©æ¸…å–®</h3>
            <ul class="space-y-2">
              <li v-for="(item, i) in shoppingList" :key="i" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
     
                <div class="flex items-center gap-2">
                  <i class="ph text-xl cursor-pointer" 
                     :class="item.isDone ?
                     'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="item.isDone = !item.isDone">
                  </i>
                  <span class="font-medium" :class="{'task-done': item.isDone, 'text-gray-900': !item.isDone}">{{ item.name }}</span>
                </div>
             
                <button class="text-red-500 text-sm" @click="removeShoppingItem(i)">åˆªé™¤</button>
              </li>
              <li v-if="shoppingList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">
                æ‚¨çš„è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„ï¼
              </li>
            </ul>

            <div class="mt-3">
 
              <label class="text-xs text-gray-600">æ–°å¢è³¼ç‰©é …ç›®</label>
              <div class="flex gap-2 mt-1">
                <input v-model="newShoppingItem" @keyup.enter="addShoppingItem" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="è¼¸å…¥é …ç›®åç¨± (ä¾‹å¦‚ï¼šé³³æ¢¨é…¥)">
                <button @click="addShoppingItem" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
              </div>
        
            </div>
          </div>

          <div v-if="currentTab === 'è¨˜å¸³'">
            <h3 class="text-base font-bold mb-2">ğŸ’³ è¨˜å¸³ï¼ˆå¡ç‰‡å¼ï¼‰</h3>

            <div class="flex gap-2 mb-3">
              <input v-model="newExpense.name" 
              class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="æ¶ˆè²»åç¨± (ä¾‹å¦‚ï¼šé›…é¦™ç«é‹)">
              <input v-model.number="newExpense.amount" type="number" class="w-28 p-2 rounded-lg border bg-white/70" placeholder="é‡‘é¡ HKD">
              <select v-model="newExpense.category" class="w-32 p-2 rounded-lg border bg-white/70">
                <option value="é£Ÿç‰©">é£Ÿç‰©</option>
                <option value="äº¤é€š">äº¤é€š</option>
                <option 
                value="è³¼ç‰©">è³¼ç‰©</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <button @click="addExpense" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
            </div>

            <div class="mb-3 p-3 rounded-lg bg-white/80 border flex justify-between items-center">
    
              <div class="text-sm text-gray-600">ç›®å‰ç¸½æ”¯å‡º (HKD)</div>
              <div class="font-bold text-lg">HKD {{ totalExpense }}</div>
            </div>

            <ul class="space-y-3">
              <li v-for="(e, i) in expenses" :key="e.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
   
                <div class="flex items-start gap-3">
                  <i class="ph text-xl cursor-pointer" 
                     :class="e.isDone ?
                     'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="toggleExpenseDone(i)"></i>
                  <div>
                    <div class="font-medium" :class="{'task-done': e.isDone}">{{ e.name }}</div>
                    <div class="text-xs text-gray-500">{{ e.category }} Â· {{ e.date }}</div>
   
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="font-bold">HKD {{ e.amount }}</div>
                  <button @click="removeExpense(i)" class="text-red-500"><i class="ph ph-trash"></i></button>
      
                </div>
              </li>
              <li v-if="expenses.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">æš«ç„¡è¨˜éŒ„</li>
            </ul>
          </div>

          <div v-if="currentTab === 'è³‡è¨Š'">
     
            <h3 class="text-base font-bold mb-2">â„¹ï¸ å¯¦ç”¨è³‡è¨Š</h3>

            <div class="flex gap-2 mb-3">
              <input v-model="newInfoTitle" class="flex-1 p-2 rounded-lg border bg-white/70" placeholder="æ¨™é¡Œ (ä¾‹å¦‚ï¼šé£¯åº—é›»è©±)">
              <button @click="addInfoWithNote" class="px-4 bg-sky-600 text-white rounded-lg">åŠ å…¥</button>
            </div>

    
            <ul class="space-y-2">
              <li v-for="(it, idx) in infoList" :key="idx" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <i class="ph text-xl cursor-pointer" 
                     :class="it.isDone ?
                     'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="it.isDone = !it.isDone"></i>
                  <div>
                    <div class="font-medium" :class="{'task-done': it.isDone}">{{ it.title }}</div>
                    <div class="text-xs text-gray-500">{{ it.note }}</div>
     
                  </div>
                </div>
                <button class="text-red-500 text-sm" @click="removeInfo(idx)"><i class="ph ph-trash"></i></button>
              </li>
              <li v-if="infoList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">æš«ç„¡è³‡è¨Šï¼Œè«‹æ–°å¢</li>
            
            </ul>
          </div>

        </div>
      </div>

      <div class="h-24"></div>
    </main>

    <nav class="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-20">
      <div class="iphone-dock flex gap-6 items-center">
        <button @click="currentTab='è¡Œç¨‹'" :class="currentTab==='è¡Œç¨‹' ?
        'text-sky-600' : 'text-gray-500'" title="è¡Œç¨‹"><i class="ph ph-map-pin"></i></button>
        <button @click="currentTab='åœ°åœ–'" :class="currentTab==='åœ°åœ–' ?
        'text-sky-600' : 'text-gray-500'" title="åœ°åœ–"><i class="ph ph-map-trifold"></i></button> <button @click="currentTab='è¨˜å¸³'" :class="currentTab==='è¨˜å¸³' ?
        'text-sky-600' : 'text-gray-500'" title="è¨˜å¸³"><i class="ph ph-wallet"></i></button>
        <button @click="currentTab='è³¼ç‰©'" :class="currentTab==='è³¼ç‰©' ?
        'text-sky-600' : 'text-gray-500'" title="è³¼ç‰©"><i class="ph ph-shopping-bag"></i></button>
        <button @click="currentTab='è³‡è¨Š'" :class="currentTab==='è³‡è¨Š' ?
        'text-sky-600' : 'text-gray-500'" title="è³‡è¨Š"><i class="ph ph-info"></i></button>
      </div>
    </nav>

  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    createApp({
      setup(){
        // tabs kept for top chips logic
        const currentTab = ref('è¡Œå‰');

        // days
        const days = reactive([
          { week:'Mon', 
          date:'15', label:'12/15 (ä¸€)', type: 'flight-out' },
          { week:'Tue', date:'16', label:'12/16 (äºŒ)', type: 'stay' },
          { week:'Wed', date:'17', label:'12/17 (ä¸‰)', type: 'stay' },
          { week:'Thu', date:'18', label:'12/18 (å››)', type: 'flight-return' }
        ]);
        const selectedDay = ref(0);

        // itinerary (æ–°å¢åœ°å€æ¬„ä½)
        const itinerary = reactive([
     
          [
            { title:'æŠµé”å°åŒ—ãƒ»å…¥ä½é…’åº—ã€ä¼‘æ¯', note:'è¥¿é–€ç”ºæ°¸å®‰æ£§', time:'â€”', address:'' },
            { title:'è¥¿é–€ç”ºè¼•é¬†æ•£æ­¥', note:'æ‚ é–’è¡Œç¨‹', time:'18:00', address:'' },
            { title:'é›…é¦™çŸ³é ­ç«é‹ï¼ˆæ™šé¤ï¼‰', note:'å¿…åƒæ’éšŠåº—', time:'19:00', address:'108 å°ç£å°åŒ—å¸‚è¬è¯å€ä¸­è¯è·¯äºŒæ®µ502è™Ÿ' },
            { title:'å—æ©Ÿå ´å¤œå¸‚', note:'å®µå¤œ', time:'21:00', address:'100 å°ç£å°åŒ—å¸‚ä¸­æ­£å€ä¸­è¯è·¯äºŒæ®µ307å··' },
            { title:'è¿”é…’åº—ä¼‘æ¯', note:'10:30 å‰ä¼‘æ¯', time:'23:00', address:'' }
          ],
    
          [
            { title:'åˆé¤ï¼šåƒæš‰éµè‚‰åº—', note:'ç¾é£Ÿ', time:'12:00', address:'108 å°ç£å°åŒ—å¸‚è¬è¯å€ä¸­è¯è·¯äºŒæ®µ420è™Ÿ' },
            { title:'Costco ä¸­å’Œåº—ï¼ˆçºŒæœƒï¼‹è²·æ‰‹ä¿¡ï¼‰', note:'è³¼ç‰©', time:'14:00', address:'' },
            { title:'æ™šé¤ï¼šé›æ¹¯æ¦®éºµé£Ÿé¤¨ï¼ˆ17:00 å¾Œï¼‰', note:'æ™šé¤', time:'17:30', address:'' },
            { title:'è¯è¥¿è¡—å¤œå¸‚', note:'é€›å¤œå¸‚', time:'19:30', address:'' },
            { title:'èƒ–è€é—†èª æ„è‚‰ç²¥ï¼ˆå®µå¤œï¼‰', note:'å®µå¤œ', time:'22:00', address:'' }
          ],
  
          [
            { title:'åˆé¤ï¼šæ¢å±±æ³Šå°ç± æ¹¯åŒ…', note:'ä¸­åˆ', time:'12:00', address:'' },
            { title:'è¥¿é–€ç”ºè¡Œä¸‹ / Cafe ä¼‘æ¯', note:'æ‚ é–’åˆå¾Œ', time:'14:00', address:'' },
            { title:'å¯§å¤å¤œå¸‚', note:'æ™šé¤è‡ªç†', time:'18:30', address:'' },
            { title:'å›é…’åº—', note:'ä¼‘æ¯', time:'21:00', address:'' }
          ],
          [
     
            { title:'è¥¿é–€ç”ºè£œè²·æ‰‹ä¿¡', note:'è³¼ç‰©', time:'11:00', address:'' },
            { title:'é‡‘åœ’æ’éª¨ï¼ˆåˆé¤ï¼‰', note:'åˆé¤', time:'13:00', address:'' },
            { title:'å‰å¾€æ©Ÿå ´ï¼ˆCX443ï¼‰', note:'æ­ä¹˜ CX443 å› HKG', time:'15:50', address:'' }
          ]
        ]);
        
        // map: è¨ˆç®—ç•¶æ—¥ç¬¬ä¸€å€‹æœ‰åœ°å€çš„è¡Œç¨‹
        const activeMapItem = computed(() => {
            const currentItinerary = itinerary[selectedDay.value];
            const firstItemWithAddress = currentItinerary.find(item => (item.address || '').trim() !== '');

            if (!firstItemWithAddress) return null;

            // Google Maps URL ç·¨ç¢¼
            const encodedAddress = encodeURIComponent(firstItemWithAddress.address);
            const title = firstItemWithAddress.title;

            // ç¢ºä¿ Google Maps é€£çµæ ¼å¼æ­£ç¢º
            // https://www.google.com/maps/search/?api=1&query=${encodedAddress} and https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}
            // ç”±æ–¼é€™ä¸æ˜¯æ¨™æº–çš„ Google Maps é€£çµæ ¼å¼ï¼Œæˆ‘å°‡å…¶èª¿æ•´ç‚ºæ¨™æº–çš„ Google Maps æœå°‹åŠå°èˆªé€£çµï¼Œä»¥ç¢ºä¿åŠŸèƒ½å¯ç”¨ã€‚
            // ä½¿ç”¨ &q= ä¾†æœå°‹åœ°å€ï¼Œä½¿ç”¨ &daddr= ä¾†å°èˆªï¼ˆèµ·é»ç‚ºä½¿ç”¨è€…ç•¶å‰ä½ç½®ï¼Œç›®æ¨™ç‚ºåœ°å€ï¼‰
            return {
                title: title,
                address: firstItemWithAddress.address,
                // æ‰“é–‹ Google åœ°åœ– (æœå°‹åœ°å€)
                gMapUrl: `https://maps.google.com/maps?q=${encodedAddress}`,
                // é–‹å§‹å°èˆª (è¨­å®šç›®æ¨™åœ°å€ï¼Œä¸¦é–‹å•Ÿå°èˆªæ¨¡å¼)
                gMapNavUrl: `https://maps.google.com/maps?daddr=${encodedAddress}&dir_action=navigate`
            };
        });

        // flights
        const flights = [
          { id: 'outbound', date:'2025-12-15', code:'CX400', depTime:'13:00', fromCode:'HKG', fromTerminal:'T1', toCode:'TPE', toTerminal:'T1', arrTime:'14:50', title:'ç”±é¦™æ¸¯é£›å¾€å°åŒ—', note:'èˆªç­å‰å¾€å°åŒ—' },
          { id: 'return', date:'2025-12-18', code:'CX443', depTime:'15:50', fromCode:'TPE', fromTerminal:'T1', toCode:'HKG', toTerminal:'T1', arrTime:'18:00', title:'ç”±å°åŒ—è¿”å›é¦™æ¸¯', note:'å›ç¨‹' }
        ];
        const activeFlight = computed(() => {
          const dayType = days[selectedDay.value].type;
          if (dayType === 'flight-out') return flights[0];
          if (dayType === 'flight-return') return flights[1];
          return null;
        });
        const shouldShowFlightCard = computed(() => {
          const dayType = days[selectedDay.value].type;
          // æ–°å¢åœ°åœ–é é¢ä¹Ÿé¡¯ç¤º Flight Card é‚è¼¯ï¼Œå¦‚æœéœ€è¦çš„è©± (ä¿ç•™åŸæ¨£)
          return (currentTab.value === 'è¡Œå‰' || currentTab.value === 'è¡Œç¨‹') && (dayType === 'flight-out' || dayType === 'flight-return');
        });
        
        // lists
        const preTripNotes = ref([
          { name:'å…Œæ›å°å¹£', isDone: true },
          { name:'ç¢ºèªä½å®¿é ç´„å–®', isDone: false },
          { name:'è³¼è²· SIM å¡', isDone: false },
          { name:'è­·ç…§å½±æœ¬å‚™ä»½', isDone: true }
        ]);
        const newPreNote = ref('');

        const foodList = ref(['åƒæš‰éµè‚‰åº—','é›…é¦™çŸ³é ­ç«é‹','æ¢å±±æ³Šå°ç± æ¹¯åŒ…']);
        const newFood = ref('');

        const spots = ref(['è±¡å±±','å£«æ—å¤œå¸‚']);
        const newSpot = ref('');
        const shoppingList = ref([
          { name:'é³³æ¢¨é…¥ (ä½³å¾·)', isDone: false },
          { name:'é¢è†œ (è—¥å¦åº—)', isDone: false },
          { name:'è‚‰ä¹¾', isDone: true }
        ]);
        const newShoppingItem = ref('');

        // è¨˜å¸³ (B å¡ç‰‡å¼)
        const expenses = ref([
          { id: Date.now()+1, name:'é›…é¦™ç«é‹', amount: 300, category:'é£Ÿç‰©', date: '12/15', isDone:false },
          { id: Date.now()+2, name:'Taxi æ©Ÿå ´->é…’åº—', amount: 250, category:'äº¤é€š', date: '12/15', isDone:false }
        ]);
        const newExpense = reactive({ name:'', amount:null, category:'é£Ÿç‰©' });

        const totalExpense = computed(() => {
          return expenses.value.reduce((s,e)=>s + (Number(e.amount)||0), 0);
        });
        
        // è³‡è¨Šé ï¼ˆäº’å‹•åƒè¡Œå‰/è³¼ç‰©ï¼‰ï¼šæ¨™é¡Œ + å‚™è¨» (åŠ å…¥å¾Œå½ˆ prompt å¡«å‚™è¨»)
        const infoList = ref([
          { title:'è¥¿é–€ç”ºæ°¸å®‰æ£§ (é›»è©±)', note:'+886 2 2352 3090', isDone:false },
        ]);
        const newInfoTitle = ref('');

        // weather & rate
        const weather = reactive({ temp:'--', desc:'è¼‰å…¥ä¸­...', rain:0, code:0 });
        const weatherIconClass = computed(()=>{
          const c = weather.code || 0;
          if (c>=95) return 'ph ph-cloud-lightning-rain';
          if (c>=80) return 'ph ph-cloud-lightning-rain';
          if (c>=50) return 'ph ph-cloud-rain';
          if (c>2) return 'ph ph-cloud';
          return 'ph ph-sun';
        });
        const rate = ref(null);
        const lastRateUpdate = ref(null);
        const formattedRate = computed(()=> rate.value !== null ? rate.value : '...');
        const lastRateUpdateLabel = computed(()=>{
          if (!lastRateUpdate.value) return 'â€”';
          return new Date(lastRateUpdate.value).toLocaleTimeString('zh-HK');
        });
        
        // functions for lists
        function selectDay(i){ selectedDay.value = i;
        }
        function addPreNote(){ if (!newPreNote.value.trim()) return; preTripNotes.value.push({ name:newPreNote.value.trim(), isDone:false }); newPreNote.value='';
        }
        function removePreNote(i){ preTripNotes.value.splice(i,1);
        }

        function addItineraryItem(){ 
            if (!newItemText.value.trim()) return; 
            itinerary[selectedDay.value].push({ title:newItemText.value.trim(), note:'', time:'', address:'' }); // æ–°å¢ address æ¬„ä½
            newItemText.value='';
        }
        function removeItineraryItem(idx){ itinerary[selectedDay.value].splice(idx,1);
        }

        const newItemText = ref('');

        function addFood(){ if (!newFood.value.trim()) return; foodList.value.push(newFood.value.trim()); newFood.value='';
        }
        function removeFood(i){ foodList.value.splice(i,1);
        }

        function addSpot(){ if (!newSpot.value.trim()) return; spots.value.push(newSpot.value.trim()); newSpot.value='';
        }
        function removeSpot(i){ spots.value.splice(i,1);
        }

        function addShoppingItem(){ if (!newShoppingItem.value.trim()) return; shoppingList.value.push({ name:newShoppingItem.value.trim(), isDone:false }); newShoppingItem.value='';
        }
        function removeShoppingItem(i){ shoppingList.value.splice(i,1);
        }

        // expenses
        function addExpense(){
          if (!newExpense.name.trim() || !newExpense.amount) return;
          const d = new Date();
          const dateLabel = `${d.getMonth()+1}/${d.getDate()}`;
          expenses.value.unshift({
            id: Date.now(),
            name: newExpense.name.trim(),
            amount: Number(newExpense.amount),
            category: newExpense.category,
            date: dateLabel,
            isDone: false
          });
          newExpense.name = '';
          newExpense.amount = null;
          newExpense.category = 'é£Ÿç‰©';
        }
        function removeExpense(i){ expenses.value.splice(i,1);
        }
        function toggleExpenseDone(i){ expenses.value[i].isDone = !expenses.value[i].isDone;
        }

        // info list: add title then prompt for note
        function addInfoWithNote(){
          const title = (newInfoTitle.value||'').trim();
          if (!title) return;
          // ä½¿ç”¨ prompt æ¨¡æ“¬ modal è¦æ±‚å‚™è¨»ï¼ˆç°¡å–®å¯é ï¼‰
          const note = prompt('è«‹è¼¸å…¥å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šé›»è©±ã€åœ°å€ã€é è¨‚ç·¨è™Ÿï¼‰', '');
          infoList.value.unshift({ title, note: note || '', isDone:false });
          newInfoTitle.value = '';
        }
        function removeInfo(i){ infoList.value.splice(i,1);
        }

        // openAdd: smart behaviourâ€”æŠŠè¼¸å…¥åŠ å…¥å°æ‡‰æ¬„ä½ï¼ˆkeep old behaviorï¼‰
        function openAddModal(){
          if (currentTab.value === 'è¡Œå‰'){ if (newPreNote.value) addPreNote();
          }
          else if (currentTab.value === 'è¡Œç¨‹'){ if (newItemText.value) addItineraryItem();
          }
          else if (currentTab.value === 'ç¾é£Ÿ'){ if (newFood.value) addFood();
          }
          else if (currentTab.value === 'æ™¯é»'){ if (newSpot.value) addSpot();
          }
          else if (currentTab.value === 'è³¼ç‰©'){ if (newShoppingItem.value) addShoppingItem();
          }
          else if (currentTab.value === 'è¨˜å¸³'){ if (newExpense.name && newExpense.amount) addExpense();
          }
          else if (currentTab.value === 'è³‡è¨Š'){ if (newInfoTitle.value) addInfoWithNote();
          }
          else { currentTab.value = 'è¡Œç¨‹';
          }
        }

        // fetch rate & weather
        async function fetchRate(){
          const API_URL = 'https://open.er-api.com/v6/latest/TWD';
          try {
            const res = await fetch(API_URL);
            if (!res.ok){ rate.value = null; return; }
            const data = await res.json();
            if (data && data.rates && data.rates.HKD){
              rate.value = (data.rates.HKD).toFixed(3);
              lastRateUpdate.value = new Date().toISOString();
            }
          } catch(e){ console.warn('rate fail', e);
          rate.value = null; }
        }

        async function fetchWeather(){
          try {
            const lat = 25.0330, lon = 121.5654;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=precipitation_probability&timezone=Asia%2FTaipei`;
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.current_weather){
              weather.temp = Math.round(data.current_weather.temperature);
              weather.code = data.current_weather.weathercode || 0;
              weather.desc = describeWeather(weather.code);
              if (data.hourly && data.hourly.precipitation_probability){
                const nowTime = data.current_weather.time.slice(0, 13);
                const nowIdx = data.hourly.time.findIndex(t => t.startsWith(nowTime));
                const prob = (nowIdx >= 0) ? data.hourly.precipitation_probability[nowIdx] : (data.hourly.precipitation_probability[0] || 0);
                weather.rain = Math.round(prob);
              } else weather.rain = 0;
            }
          } catch(e){ console.warn('weather fail', e);
          weather.desc='ç„¡æ³•å–å¾—'; }
        }

        function describeWeather(code){
          if (code >= 95) return 'é›·æš´';
          if (code >= 80) return 'é™£é›¨';
          if (code >= 60) return 'æŒçºŒé™é›¨';
          if (code >= 50) return 'æ¯›æ¯›é›¨';
          if (code >= 40) return 'éœ§/å†°éœ§';
          if (code >= 30) return 'æ²™å¡µæš´';
          if (code >= 20) return 'å±€éƒ¨é™£é›¨';
          if (code > 2) return 'å¤šé›²';
          if (code === 2) return 'å±€éƒ¨å¤šé›²';
          return 'æ™´æœ—';
        }

        // localStorage persistence
        const STORAGE_KEY = 'emenu-taipei-data-v2';
        function saveAll(){
          const payload = {
            currentTab: currentTab.value,
            selectedDay: selectedDay.value,
            itinerary: JSON.parse(JSON.stringify(itinerary)),
            preTripNotes: preTripNotes.value,
            foodList: foodList.value,
            spots: spots.value,
        
            shoppingList: shoppingList.value,
            expenses: expenses.value,
            infoList: infoList.value,
            rate: rate.value,
            weather: JSON.parse(JSON.stringify(weather))
          };
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }
          catch(e){ console.warn('save fail', e);
          }
        }

        function loadAll(){
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const p = JSON.parse(raw);
            if (p.currentTab) currentTab.value = p.currentTab;
            if (typeof p.selectedDay === 'number') selectedDay.value = p.selectedDay;
            if (p.itinerary && Array.isArray(p.itinerary)){
              for (let i=0;i<4;i++){
                // è¼‰å…¥è¡Œç¨‹æ™‚ç¢ºä¿æœ‰ address æ¬„ä½
                const loadedItems = p.itinerary[i] || [];
                const itemsWithAddress = loadedItems.map(item => ({...item, address: item.address || ''}));
                itinerary[i].splice(0, itinerary[i].length, ...itemsWithAddress);
              }
            }
            if (p.preTripNotes) preTripNotes.value = p.preTripNotes;
            if (p.foodList) foodList.value = p.foodList;
            if (p.spots) spots.value = p.spots;
            if (p.shoppingList) shoppingList.value = p.shoppingList;
            if (p.expenses) expenses.value = p.expenses;
            if (p.infoList) infoList.value = p.infoList;
            if (p.rate) rate.value = p.rate;
            if (p.weather) {
              weather.temp = p.weather.temp ||
              weather.temp;
              weather.desc = p.weather.desc || weather.desc;
              weather.rain = p.weather.rain || weather.rain;
              weather.code = p.weather.code || weather.code;
            }
          } catch(e){ console.warn('load fail', e);
          }
        }

        onMounted(()=>{
          loadAll();
          fetchRate(); fetchWeather();
          setInterval(fetchRate, 10*60*1000);
          setInterval(fetchWeather, 10*60*1000);
        });
        watch([currentTab, selectedDay, () => itinerary.map(d=>d.length), preTripNotes, foodList, spots, shoppingList, expenses, infoList, rate, () => weather.temp], () => {
          saveAll();
        }, { deep:true });
        
        // expose
        return {
          currentTab, days, selectedDay, selectDay,
          // lists
          preTripNotes, newPreNote, addPreNote, removePreNote,
          itinerary, newItemText, addItineraryItem, removeItineraryItem,
          foodList, newFood, addFood, removeFood,
          spots, newSpot, addSpot, removeSpot,
          shoppingList, newShoppingItem, addShoppingItem, removeShoppingItem,
 
          // expenses
          expenses, newExpense, addExpense, removeExpense, toggleExpenseDone, totalExpense,
          // info
          infoList, newInfoTitle, addInfoWithNote, removeInfo,
          // flight/weather/rate
          activeFlight, shouldShowFlightCard, weather, weatherIconClass, rate, formattedRate, lastRateUpdateLabel,
          // map (ä¿®æ”¹)
          activeMapItem,
          openAddModal
        };
        }
    }).mount('#app');
  </script>
</body>
</html>
