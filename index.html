<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1.0,user-scalable=no" />
  <title>eMenu Taipei v2.11 ‚Äî Èõ≤Á´ØÁâà</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.86);
      --card-radius: 18px;
    }
    html,body,#app { height:100%; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-color:#0f172a;
      margin:0;
    }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    .fade-enter-active, .fade-leave-active { transition: opacity .25s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    .task-done { text-decoration: line-through; color: #9ca3af; }

    .iphone-dock {
        background: rgba(255,255,255,0.68);
        backdrop-filter: blur(10px);
        border-radius: 28px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.12);
        padding: 0.75rem 1.875rem;
        border: 1px solid rgba(255,255,255,0.35);
    }
    .glass-card { 
        border-radius: var(--card-radius);
        background: rgba(255,255,255,0.88);
        border: 1px solid rgba(255,255,255,0.35);
        padding: 0.75rem; 
        box-shadow: 0 8px 24px rgba(2,6,23,0.06);
    }
    .expense-card {
        /* New Custom Background: #081C54 (70%) */
        background: linear-gradient(135deg, rgba(8, 28, 84, 0.7) 0%, rgba(8, 28, 84, 0.75) 100%);
        backdrop-filter: blur(8px);
        color: white;
        border-radius: 24px;
        padding: 1.25rem;
        box-shadow: 0 10px 30px -10px rgba(8, 28, 84, 0.4);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    @media screen and (max-width: 768px) {
        input, select, textarea { font-size: 16px !important; }
    }
    .sync-status { transition: all 0.3s ease; }
    .sync-saving { color: #f59e0b; }
    .sync-synced { color: #10b981; }
    .sync-error { color: #ef4444; }
    .sync-loading { color: #3b82f6; }
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div id="app" class="relative min-h-screen flex flex-col">

    <div class="absolute inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover opacity-100" alt="Taipei Background">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-100/75 via-slate-100/55 to-slate-200/85"></div>
    </div>

    <main class="relative z-10 flex-1 overflow-y-auto no-scrollbar pb-safe pt-6 px-4">

      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">eMenu Taipei <span class="ml-1 text-sm">üáπüáº</span></h1>
          <div class="mt-1">
            <p class="text-xs text-gray-500">Âè∞Âåó 12/15 ‚Äî 12/18</p>
            <div class="flex items-center gap-2 mt-0.5">
                <p class="text-xs text-gray-500 opacity-50">{{ appVersion }}</p>
                <div class="flex items-center gap-2">
            
                    <div class="flex items-center gap-1 bg-white/60 px-2 py-0.5 rounded-full border border-gray-200">
                        <div class="w-2 h-2 rounded-full" 
                            :class="{
                                'bg-emerald-500': syncState === 'synced', 
                                'bg-yellow-500 animate-pulse': syncState === 'saving', 
                                'bg-blue-500 animate-pulse': syncState === 'loading',
                                'bg-red-500': syncState === 'error'
                            }"></div>
                        <span class="text-[10px] font-medium sync-status whitespace-nowrap" 
                            :class="{
                                'sync-synced': syncState === 'synced', 
                                'sync-saving': syncState === 'saving', 
                                'sync-loading': syncState === 'loading',
                                'sync-error': syncState === 'error'
                            }">
                           {{ syncStatusText }}
                        </span>
                    </div>
                    <button @click="forceReloadCloud" class="bg-white/60 p-1 rounded-full border border-gray-200 text-gray-500 active:bg-gray-200" title="Á´ãÂç≥ÂêåÊ≠•">
                        <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
                    </button>
                </div>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-bold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-md border border-emerald-200 inline-block">Âç≥ÊôÇÂåØÁéá</div>
          <div class="text-xs font-bold text-gray-600 mt-1">
             <div class="whitespace-nowrap">
                1 TWD ‚âà <span class="text-emerald-600 text-sm">{{ formattedRate }}</span> HKD
             </div>
            <div class="text-[10px] text-gray-400">Êõ¥Êñ∞Ôºö{{ lastRateUpdateLabel }}</div>
          </div>
        </div>
      </div>

      <div class="mb-5">
        <div class="flex justify-between gap-2 overflow-x-auto no-scrollbar pb-2">
          <button @click="currentTab = 'Ë°åÂâç'" 
               class="flex-shrink-0 w-[20%] min-w-[72px] h-20 rounded-xl flex flex-col items-center justify-center text-xs font-semibold transition-transform"
                  :class="currentTab === 'Ë°åÂâç' ? 'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 border border-white/40 text-gray-600'">
             <i class="ph ph-list text-xl mb-1"></i>
             <span>Ë°åÂâç</span>
          </button>
          
          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = 'Ë°åÁ®ã'"
                  class="flex-shrink-0 w-[22%] min-w-[72px] h-20 rounded-xl flex flex-col items-center justify-center transition-transform"
                  :class="selectedDay === i && currentTab === 'Ë°åÁ®ã' ? 'bg-gradient-to-br from-sky-200 to-teal-100 scale-105 shadow-md text-gray-900 border border-sky-200' : 'bg-white/80 text-gray-600 border border-white/40'">
            <span class="text-[10px] font-semibold text-sky-600/90 mb-0.5">Day {{ i + 1 }}</span>
            <span class="text-[12px] font-medium">{{ d.week }}</span>
            <span class="text-base font-bold mt-0.5">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="['Ë°åÂâç', 'Ë°åÁ®ã'].includes(currentTab)" class="space-y-4 mb-4">
        <div class="glass-card">
          <div class="flex items-center mb-2">
             <i class="ph ph-map-pin-simple-area text-sm text-gray-500 mr-1"></i>
             <span class="text-xs font-bold text-gray-600">Âè∞ÂåóÂ∏Ç</span>
          </div>
          <div class="flex h-24">
            <div class="flex-1 flex items-center justify-start">
                <div class="text-[64px] font-bold text-gray-800 leading-none">{{ weather.temp }}¬∞</div>
            </div>
            <div class="flex-shrink-0 w-24 flex items-center justify-center">
                <i :class="weatherIconClass" class="text-[64px] text-sky-500 leading-none"></i>
            </div>
            <div class="flex-shrink-0 w-32 flex flex-col justify-center items-end text-right">
                <div class="text-base text-gray-600 font-bold mb-1">{{ weather.desc }}</div>
                <div class="text-xs text-gray-500">ÈôçÈõ®Ê©üÁéá {{ weather.rain }}%</div>
            </div>
          </div>
        </div>

        <transition name="fade">
          <div v-if="shouldShowFlightCard" 
               class="rounded-2xl p-4 text-white shadow-lg relative overflow-hidden" 
               style="background: linear-gradient(135deg,#60a5fa 0%,#2dd4bf 100%);">
              <div class="flex justify-between items-center mb-3 relative z-10">
                <div class="text-xs font-bold bg-white/20 px-2 py-1 rounded">FLIGHT</div>
                <div class="text-xs text-right">
                    <div class="font-mono font-semibold text-lg">{{ activeFlight.depTime }}</div>
                    <div class="text-xs opacity-80 mt-1">Arr. {{ activeFlight.arrTime }}</div>
                </div>
              </div>
              <div class="flex items-center justify-between relative z-10">
                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">from</div>
                  <div class="text-3xl font-bold tracking-widest">{{ activeFlight.fromCode }}</div>
                  <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.fromTerminal }}</div>
                </div>
                <div class="flex-1 px-4 text-center">
                  <i class="ph ph-airplane-tilt text-2xl"></i>
                  <div class="h-0.5 bg-white/30 my-3"></div>
                  <div class="text-xs opacity-75">{{ activeFlight.note }}</div>
                </div>
                <div class="flex flex-col items-center">
                  <div class="text-[11px] opacity-80">to</div>
                  <div class="text-3xl font-bold tracking-widest">{{ activeFlight.toCode }}</div>
                  <div class="text-sm font-semibold opacity-80 text-white/90 mt-1">{{ activeFlight.toTerminal }}</div>
                </div>
              </div>
              <div class="mt-4 flex justify-between items-center relative z-10">
                <div class="text-sm">{{ activeFlight.code }} ‚Äî {{ activeFlight.title }}</div>
                <div class="bg-white text-sky-600 px-3 py-1 rounded-full text-xs font-bold">Â∑≤Á¢∫Ë™ç</div>
              </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="selectedMapLocation" class="glass-card !p-4 bg-white/95 border-2 border-sky-200 relative">
                <button @click="selectedMapLocation = null" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                    <i class="ph ph-x text-lg"></i>
                </button>
                <div class="mb-4 pr-6">
                     <div class="flex items-center gap-2 mb-1">
                         <i class="ph ph-map-pin-fill text-red-500 text-xl"></i>
                         <h4 class="text-lg font-bold text-gray-800">{{ selectedMapLocation.title }}</h4>
                    </div>
                 <p class="text-sm text-gray-500 pl-7">{{ selectedMapLocation.address }}</p>
                </div>
                <div class="flex justify-center gap-3">
                    <a :href="generateMapLink(selectedMapLocation.address, 'search')" target="_blank"
                       class="flex-1 max-w-[200px] py-3 px-2 flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 rounded-xl font-bold shadow-sm active:scale-95 transition text-sm">
                        <i class="ph ph-map-trifold text-lg text-blue-500"></i> Google Âú∞Âúñ
                    </a>
                    <a :href="generateMapLink(selectedMapLocation.address, 'navigate')" target="_blank"
                       class="flex-1 max-w-[200px] py-3 px-2 flex items-center justify-center gap-2 bg-emerald-500 text-white rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition text-sm">
                        <i class="ph ph-navigation-arrow text-lg"></i> ÈñãÂßãÂ∞éËà™
                     </a>
                </div>
            </div>
        </transition>
      </div>

      <div v-if="currentTab !== 'Ë°åÂâç' && currentTab !== 'Ë®òÂ∏≥'" class="flex justify-end mb-3">
        <button @click="openAddModal" class="bg-sky-600 text-white px-4 py-2 rounded-lg shadow active:scale-95 transition flex items-center gap-1">
           <i class="ph ph-plus-circle text-lg"></i>
            <span v-if="isFlightDay && currentTab === 'Ë°åÁ®ã'">Êñ∞Â¢ûËà™Áè≠</span>
            <span v-else>Êñ∞Â¢û</span>
        </button>
      </div>

      <div class="rounded-2xl p-3 bg-white/85 border border-white/30 backdrop-blur shadow" :class="{'!bg-transparent !border-0 !shadow-none !p-0': currentTab === 'Ë®òÂ∏≥'}">
        <div>

          <div v-if="currentTab === 'Ë°åÂâç'">
            <h3 class="text-base font-bold mb-2">‚úÖ Ë°åÂâçÊ∫ñÂÇôÊ∏ÖÂñÆ</h3>
            <ul class="space-y-2">
              <li v-for="(note, i) in preTripNotes" :key="note.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <i class="ph text-xl cursor-pointer" 
                     :class="note.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="togglePreNoteDone(note.id)">
                  </i>
                  <span class="font-medium" :class="{'task-done': note.isDone, 'text-gray-900': !note.isDone}">{{ note.name }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <button @click.stop="editPreNote(note)" class="text-gray-400 text-base hover:text-sky-600 transition p-1" title="Á∑®ËºØ"><i class="ph ph-pencil-simple"></i></button>
                  <button @click.stop="removePreNote(note.id)" class="text-red-500 text-base" title="Âà™Èô§"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="preTripNotes.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">Ë´ãÊñ∞Â¢ûË°åÂâçÊ∫ñÂÇô‰∫ãÈ†ÖÔºÅ</li>
            </ul>
            <div class="mt-3">
              <label class="text-xs text-gray-600">Êñ∞Â¢ûÊ∫ñÂÇô‰∫ãÈ†Ö</label>
              <div class="flex gap-2 mt-1">
                <input v-model="newPreNote" @keyup.enter="addPreNote" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="‰æãÂ¶ÇÔºöÂÖåÊèõÂè∞Âπ£">
                <button @click="addPreNote" class="px-4 bg-sky-600 text-white rounded-lg">Âä†ÂÖ•</button>
              </div>
            </div>
          </div>

          <div v-if="currentTab === 'Ë°åÁ®ã'">
            <h3 class="text-base font-bold mb-2">‰ªäÊó•Ë°åÁ®ã ‚Äî {{ days[selectedDay].label }}</h3>
            <ul class="space-y-2">
              <li v-for="(it, idx) in sortedItinerary" :key="it.id" 
                  @click="showLocationOnMap(it)"
                  :class="{'cursor-pointer hover:bg-sky-50 transition border-l-4 border-l-sky-400 pl-3': (it.address || '').trim() !== '', 'border-l-transparent': (it.address || '').trim() === ''}"
                  class="p-3 rounded-lg bg-white/80 border border-white/30 flex justify-between items-center relative overflow-hidden">
                <div class="flex-1">
                  <div class="font-medium text-gray-800">{{ it.title }}</div>
                  <div class="text-xs text-gray-500">{{ it.note }}</div>
                  <div v-if="(it.address || '').trim() !== ''" class="text-[10px] text-sky-500 mt-1 flex items-center">
                      <i class="ph ph-map-pin-line mr-1"></i> ÈªûÊìäÂ∞éËà™
                  </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="text-sm font-bold text-gray-700 mr-2">{{ it.time || '--:--' }}</div>
                    <button @click.stop="openItineraryModal(it)" class="text-gray-400 text-lg hover:text-sky-600 transition p-1"><i class="ph ph-pencil-simple"></i></button>
                    <button @click.stop="removeItineraryItem(it.id)" class="text-gray-400 text-lg hover:text-red-500 transition p-1"><i class="ph ph-trash"></i></button>
                </div>
              </li>
            </ul>
            <p v-if="sortedItinerary.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">‰ªäÊó•Êö´ÁÑ°Ë°åÁ®ã</p>
            <div v-if="isFlightDay" class="mt-4 pt-3 border-t border-gray-200/50">
               <label class="text-xs text-gray-600 font-bold mb-1 block">‚ûï Âø´ÈÄüÊñ∞Â¢ûË°åÁ®ã</label>
               <div class="flex gap-2">
                   <input v-model="quickItinerary.time" type="time" class="w-20 p-2 rounded-lg border bg-white/70 text-base text-center">
                   <input v-model="quickItinerary.title" @keyup.enter="addQuickItinerary" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="Ë°åÁ®ãÂêçÁ®±...">
                   <button @click="addQuickItinerary" class="px-3 bg-sky-600 text-white rounded-lg whitespace-nowrap">Âä†ÂÖ•</button>
               </div>
            </div>
          </div>

          <div v-if="currentTab === 'Ë≥ºÁâ©'">
            <h3 class="text-base font-bold mb-2">üõí Ë≥ºÁâ©Ê∏ÖÂñÆ</h3>
            <ul class="space-y-2">
              <li v-for="(item, i) in shoppingList" :key="item.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-start">
                <div class="flex items-start gap-3 flex-1">
                  <i class="ph text-xl cursor-pointer mt-1 flex-shrink-0" 
                     :class="item.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="item.isDone = !item.isDone">
                  </i>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium" :class="{'task-done': item.isDone, 'text-gray-900': !item.isDone}">{{ item.name }}</div>
                    <div v-if="item.imageURL" class="mt-2">
                        <a v-if="isInstagramLink(item.imageURL)" :href="item.imageURL" target="_blank" 
                           class="text-xs font-semibold text-pink-600 bg-pink-100 px-2 py-1 rounded inline-flex items-center gap-1">
                           <i class="ph ph-instagram-logo"></i> Êü•ÁúãË≤ºÊñá
                        </a>
                        <div v-else class="relative group cursor-pointer w-16 h-16" @click="openImageViewer(item.imageURL)">
                             <img :src="item.imageURL" class="w-full h-full object-cover rounded-lg border border-gray-200 shadow-sm" alt="Thumbnail">
                             <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 rounded-lg transition"></div>
                        </div>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                    <button @click="openShoppingModal(item)" class="text-gray-500 text-base hover:text-sky-600 transition"><i class="ph ph-pencil-simple"></i></button>
                    <button class="text-red-500 text-base" @click="removeShoppingItem(item.id)"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="shoppingList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">ÊÇ®ÁöÑË≥ºÁâ©Ê∏ÖÂñÆÊòØÁ©∫ÁöÑÔºÅ</li>
            </ul>
          </div>

          <div v-if="currentTab === 'Ë®òÂ∏≥'">
            
             <div class="expense-card mb-4 relative">
                <button @click="openExpenseModal(null)" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-2 rounded-full backdrop-blur-sm transition">
                    <i class="ph ph-plus text-xl font-bold"></i>
                </button>

                <div class="text-center mb-6">
                    <div class="text-blue-100/80 text-xs font-medium tracking-wide mb-1">Á∏ΩÊîØÂá∫ (HKD)</div>
                    <div class="text-4xl font-bold mb-1">${{ totalExpense.hkd }}</div>
                    <div class="text-blue-200/80 text-sm">TWD {{ totalExpense.twd }}</div>
                </div>
                
                 <div class="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
                    <div class="text-center border-r border-white/20">
                        <div class="text-blue-100/80 text-[10px] mb-0.5"><i class="ph ph-credit-card mr-1"></i>‰ø°Áî®Âç°</div>
                        <div class="text-lg font-bold">${{ totalExpense.creditHkd }}</div>
                        <div class="text-blue-200/80 text-[10px]">TWD {{ totalExpense.creditTwd }}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-blue-100/80 text-[10px] mb-0.5"><i class="ph ph-coins mr-1"></i>ÁèæÈáë</div>
                        <div class="text-lg font-bold">${{ totalExpense.cashHkd }}</div>
                        <div class="text-blue-200/80 text-[10px]">TWD {{ totalExpense.cashTwd }}</div>
                    </div>
                </div>
             </div>

            <div class="bg-white/50 p-1 rounded-xl flex mb-3 backdrop-blur-sm">
                <button v-for="f in ['all', 'credit', 'cash']" :key="f"
                    @click="expenseFilter = f"
                    class="flex-1 py-1.5 text-xs font-medium rounded-lg transition-all"
                    :class="expenseFilter === f ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'">
                    {{ f === 'all' ? 'ÂÖ®ÈÉ®' : (f === 'credit' ? '‰ø°Áî®Âç°' : 'ÁèæÈáë') }}
                </button>
            </div>

            <div class="rounded-2xl p-3 bg-white/85 border border-white/30 backdrop-blur shadow">
                <ul class="space-y-3">
                <li v-for="(e, i) in filteredExpenses" :key="e.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-center">
                    <div class="flex items-start gap-3">
                        <div class="mt-1 text-gray-400">
                             <i class="ph text-xl" :class="e.paymentMethod === 'credit_card' ? 'ph-credit-card' : 'ph-coins'"></i>
                        </div>
                    <div>
                        <div class="font-medium text-gray-800">{{ e.name }}</div>
                        <div class="text-xs text-gray-500">{{ e.category }} ¬∑ {{ e.date }}</div>
                    </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-right mr-1">
                             <div class="font-bold text-gray-800">{{ e.currency }} {{ e.amount }}</div>
                        </div>
                        <button @click="openExpenseModal(e)" class="text-gray-400 hover:text-sky-600 p-1"><i class="ph ph-pencil-simple"></i></button>
                        <button @click="removeExpense(e.id)" class="text-red-400 hover:text-red-600 p-1"><i class="ph ph-trash"></i></button>
                    </div>
                </li>
                <li v-if="filteredExpenses.length === 0" class="p-4 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">
                    Êö´ÁÑ°{{ expenseFilter === 'all' ? '' : (expenseFilter === 'credit' ? '‰ø°Áî®Âç°' : 'ÁèæÈáë') }}Ë®òÈåÑ
                </li>
                </ul>
            </div>
          </div>

          <div v-if="currentTab === 'Ë≥áË®ä'">
            <h3 class="text-base font-bold mb-2">‚ÑπÔ∏è ÂØ¶Áî®Ë≥áË®ä</h3>
            <ul class="space-y-2">
              <li v-for="(it, idx) in infoList" :key="it.id" class="p-3 rounded-lg bg-white/80 border flex justify-between items-start">
                <div class="flex items-start gap-2 flex-1">
                  <i class="ph text-xl cursor-pointer mt-1 flex-shrink-0" 
                     :class="it.isDone ? 'ph-check-circle-fill text-emerald-500' : 'ph-circle text-gray-400'" 
                     @click="it.isDone = !it.isDone"></i>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium" :class="{'task-done': it.isDone}">{{ it.title }}</div>
                    <div class="text-xs text-gray-500 break-words whitespace-pre-wrap">{{ it.note }}</div>
                    <div v-if="it.imageURL" class="mt-2">
                        <a v-if="isInstagramLink(it.imageURL)" :href="it.imageURL" target="_blank" 
                           class="text-xs font-semibold text-pink-600 bg-pink-100 px-2 py-1 rounded inline-flex items-center gap-1">
                           <i class="ph ph-instagram-logo"></i> Êü•ÁúãË≤ºÊñá
                        </a>
                        <div v-else class="relative group cursor-pointer w-20 h-20" @click="openImageViewer(it.imageURL)">
                             <img :src="it.imageURL" class="w-full h-full object-cover rounded-lg border border-gray-200 shadow-sm" alt="Thumbnail">
                             <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 rounded-lg transition"></div>
                        </div>
                    </div>
                   </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                    <button @click="openInfoModal(it)" class="text-gray-500 text-base hover:text-sky-600 transition"><i class="ph ph-pencil-simple"></i></button>
                    <button class="text-red-500 text-sm" @click="removeInfo(it.id)"><i class="ph ph-trash"></i></button>
                </div>
              </li>
              <li v-if="infoList.length === 0" class="p-3 text-sm text-gray-500 text-center border-dashed border-2 rounded-lg">Êö´ÁÑ°Ë≥áË®äÔºåË´ãÊñ∞Â¢û</li>
            </ul>
          </div>

        </div>
      </div>

      <div class="h-24 flex items-end justify-center pb-4">
         <div class="text-[10px] text-gray-400">Ver: {{ appVersion }}</div>
      </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 z-20 pb-safe px-4">
      <div class="iphone-dock flex justify-around items-center w-[90%] max-w-sm mx-auto p-2">
        <button @click="currentTab='Ë°åÁ®ã'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='Ë°åÁ®ã' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-map-pin"></i><span class="text-[10px] font-medium mt-0.5">Ë°åÁ®ã</span></button>
        <button @click="currentTab='Ë®òÂ∏≥'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='Ë®òÂ∏≥' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-wallet"></i><span class="text-[10px] font-medium mt-0.5">Ë®òÂ∏≥</span></button>
        <button @click="currentTab='Ë≥ºÁâ©'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='Ë≥ºÁâ©' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-shopping-bag"></i><span class="text-[10px] font-medium mt-0.5">Ë≥ºÁâ©</span></button>
        <button @click="currentTab='Ë≥áË®ä'" class="flex flex-col items-center justify-center py-1" :class="currentTab==='Ë≥áË®ä' ? 'text-sky-600' : 'text-gray-500'"><i class="ph ph-info"></i><span class="text-[10px] font-medium mt-0.5">Ë≥áË®ä</span></button>
      </div>
    </nav>
    
    <transition name="fade">
        <div v-if="imageViewer.open" class="fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center p-4" @click="imageViewer.open = false">
            <button class="absolute top-6 right-6 text-white/80 hover:text-white p-2">
                <i class="ph ph-x-circle text-4xl"></i>
            </button>
            <img :src="imageViewer.url" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl" @click.stop>
        </div>
    </transition>

    <transition name="fade">
      <div v-if="preNoteModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closePreNoteModal">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
          <h3 class="text-xl font-bold mb-4">{{ editingPreNote.id ? 'Á∑®ËºØÊ∫ñÂÇô‰∫ãÈ†Ö' : 'Êñ∞Â¢ûÊ∫ñÂÇô‰∫ãÈ†Ö' }}</h3>
          <div class="space-y-3 text-sm">
            <input v-model="editingPreNote.name" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="‰∫ãÈ†ÖÂêçÁ®±">
            <div class="flex items-center gap-3 mt-3">
              <input type="checkbox" id="pre-note-done" v-model="editingPreNote.isDone" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded">
              <label for="pre-note-done" class="text-gray-900">Â∑≤ÂÆåÊàê</label>
             </div>
          </div>
          <div class="mt-5 flex justify-end gap-3">
            <button @click="closePreNoteModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
            <button @click="savePreNoteEdit" class="px-4 py-2 bg-sky-600 text-white rounded-lg">ÂÑ≤Â≠ò</button>
          </div>
        </div>
      </div>
    </transition>

    <transition name="fade">
        <div v-if="flightModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeFlightModal">
             <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newFlight.id ? 'Á∑®ËºØËà™Áè≠' : 'Êñ∞Â¢ûËà™Áè≠' }}</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-3">
                        <select v-model="newFlight.type" class="flex-1 p-2 rounded-lg border bg-white text-base">
                            <option value="outbound">ÂéªÁ®ã (HKG -> TPE)</option>
                            <option value="return">ÂõûÁ®ã (TPE -> HKG)</option>
                        </select>
                        <input v-model="newFlight.date" type="date" class="flex-1 p-2 rounded-lg border bg-white text-base">
                     </div>
                    <input v-model="newFlight.code" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Ëà™Áè≠‰ª£Á¢º (‰æã: CX400)">
                    <input v-model="newFlight.title" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Ëà™Áè≠ÂêçÁ®±/ÂÇôË®ª">
                    <div class="flex gap-3">
                         <input v-model="newFlight.fromCode" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="Âá∫Áôº (HKG)">
                        <input v-model="newFlight.toCode" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="ÊäµÈÅî (TPE)">
                    </div>
                     <div class="flex gap-3">
                        <input v-model="newFlight.fromTerminal" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="Âá∫ÁôºËà™Âªà">
                        <input v-model="newFlight.toTerminal" class="flex-1 min-w-0 p-2 rounded-lg border bg-white text-base" placeholder="ÊäµÈÅîËà™Âªà">
                    </div>
                     <div class="flex gap-3">
                        <input v-model="newFlight.depTime" type="time" class="flex-1 p-2 rounded-lg border bg-white text-base">
                        <input v-model="newFlight.arrTime" type="time" class="flex-1 p-2 rounded-lg border bg-white text-base">
                    </div>
                     <textarea v-model="newFlight.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="2" placeholder="ÂÇôË®ª..."></textarea>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeFlightModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
                     <button @click="saveFlight" class="px-4 py-2 bg-sky-600 text-white rounded-lg">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="itineraryModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeItineraryModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                 <h3 class="text-xl font-bold mb-4">{{ newItineraryItem.id ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-3 mb-1">
                        <select v-model="newItineraryItem.dayIndex" class="w-full p-2 rounded-lg border bg-white text-base font-medium text-gray-700">
                             <option v-for="(d, i) in days" :key="i" :value="i">
                                 12/{{ d.date }} ({{ d.week }}) ‚Äî {{ d.label }}
                             </option>
                         </select>
                    </div>

                    <div class="flex gap-3">
                        <input v-model="newItineraryItem.title" class="flex-1 p-2 rounded-lg border bg-white text-base" placeholder="Ê®ôÈ°å">
                        <input v-model="newItineraryItem.time" type="time" class="w-24 p-2 rounded-lg border bg-white text-base">
                    </div>
                    <input v-model="newItineraryItem.address" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Google Map Âú∞ÂùÄ (ÈÅ∏Â°´)">
                    <textarea v-model="newItineraryItem.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="3" placeholder="ÂÇôË®ª..."></textarea>
                 </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeItineraryModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
                    <button @click="saveItineraryItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg">ÂÑ≤Â≠ò</button>
                </div>
             </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="shoppingModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeShoppingModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newShoppingItem.id ? 'Á∑®ËºØË≥ºÁâ©È†ÖÁõÆ' : 'Êñ∞Â¢ûË≥ºÁâ©È†ÖÁõÆ' }}</h3>
                <div class="space-y-4 text-sm">
                    <input v-model="newShoppingItem.name" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="È†ÖÁõÆÂêçÁ®± (‰æãÂ¶ÇÔºöÈ≥≥Ê¢®ÈÖ•)">
                    
                    <div class="border-t pt-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ÂúñÁâáÊàñÈÄ£Áµê</label>
                        <input v-model="newShoppingItem.imageURL" class="w-full p-2 rounded-lg border bg-white text-base mb-2" placeholder="Ë≤º‰∏ä URL Êàñ IG ÈÄ£Áµê">
                        <div class="flex items-center gap-2">
                             <div class="text-xs text-gray-400">ÊàñÊòØ</div>
                             <label class="flex-1 bg-gray-100 border border-gray-300 text-gray-700 py-2 px-3 rounded-lg cursor-pointer text-center active:bg-gray-200">
                                <i class="ph ph-upload-simple"></i> ‰∏äÂÇ≥ÂúñÁâá
                                <input type="file" accept="image/*" class="hidden" @change="(e) => handleFileUpload(e, 'shopping')">
                             </label>
                        </div>
                        <div v-if="uploadStatus.shopping" class="text-xs text-blue-500 mt-1 animate-pulse">
                            {{ uploadStatus.shopping }}
                        </div>
                         <div v-if="tempUploadPreview.shopping" class="mt-2 relative inline-block">
                             <img :src="tempUploadPreview.shopping" class="h-16 w-16 object-cover rounded border">
                             <div class="absolute -top-1 -right-1 bg-green-500 text-white rounded-full p-0.5"><i class="ph ph-check text-xs"></i></div>
                         </div>
                     </div>

                    <div class="flex items-center gap-3 mt-1">
                        <input type="checkbox" id="shopping-done" v-model="newShoppingItem.isDone" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded">
                        <label for="shopping-done" class="text-gray-900">Â∑≤Ë≥ºË≤∑</label>
                     </div>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeShoppingModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
                    <button @click="saveShoppingItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg" :disabled="isUploading">
                        {{ isUploading ? '‰∏äÂÇ≥‰∏≠...' : 'ÂÑ≤Â≠ò' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="expenseModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeExpenseModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newExpense.id ? 'Á∑®ËºØÊ∂àË≤ªË®òÈåÑ' : 'Êñ∞Â¢ûÊ∂àË≤ªË®òÈåÑ' }}</h3>
                <div class="space-y-4 text-sm">
                    <input v-model="newExpense.name" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Ê∂àË≤ªÂêçÁ®± (‰æãÂ¶ÇÔºöÈõÖÈ¶ôÁÅ´Èçã)">
                    
                    <div class="flex gap-2">
                        <select v-model="newExpense.currency" class="w-24 p-2 rounded-lg border bg-white/70 text-base">
                            <option value="TWD">TWD</option>
                            <option value="HKD">HKD</option>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                        </select>
                        <input v-model.number="newExpense.amount" type="number" class="flex-1 p-2 rounded-lg border bg-white/70 text-base" placeholder="ÈáëÈ°ç">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <select v-model="newExpense.category" class="w-full p-2 rounded-lg border bg-white/70 text-base">
                            <option value="È§êÈ£≤">È§êÈ£≤</option>
                            <option value="‰∫§ÈÄö">‰∫§ÈÄö</option>
                            <option value="Ë≥ºÁâ©">Ë≥ºÁâ©</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                        <select v-model="newExpense.paymentMethod" class="w-full p-2 rounded-lg border bg-white/70 text-base">
                            <option value="cash">ÁèæÈáë</option>
                            <option value="credit_card">‰ø°Áî®Âç°</option>
                        </select>
                    </div>

                    <div class="flex flex-col">
                        <label class="text-xs text-gray-500 font-bold mb-1">Êó•Êúü</label>
                        <input v-model="newExpense.date" type="date" class="w-full p-2 rounded-lg border bg-white/70 text-base">
                    </div>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeExpenseModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
                    <button @click="saveExpense" class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                        {{ newExpense.id ? 'ÂÑ≤Â≠ò' : 'Âä†ÂÖ•' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="infoModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="closeInfoModal">
            <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">{{ newInfoItem.id ? 'Á∑®ËºØÂØ¶Áî®Ë≥áË®ä' : 'Êñ∞Â¢ûÂØ¶Áî®Ë≥áË®ä' }}</h3>
                <div class="space-y-4 text-sm">
                    <input v-model="newInfoItem.title" class="w-full p-2 rounded-lg border bg-white text-base" placeholder="Ê®ôÈ°å">
                    <textarea v-model="newInfoItem.note" class="w-full p-2 rounded-lg border bg-white text-base" rows="3" placeholder="ÂÇôË®ªÂÖßÂÆπ..."></textarea>
                    
                    <div class="border-t pt-3">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ÈôÑ‰ª∂ÂúñÁâáÊàñÈÄ£Áµê</label>
                        <input v-model="newInfoItem.imageURL" class="w-full p-2 rounded-lg border bg-white text-base mb-2" placeholder="Ë≤º‰∏ä URL Êàñ IG ÈÄ£Áµê">
                        <div class="flex items-center gap-2">
                             <div class="text-xs text-gray-400">ÊàñÊòØ</div>
                             <label class="flex-1 bg-gray-100 border border-gray-300 text-gray-700 py-2 px-3 rounded-lg cursor-pointer text-center active:bg-gray-200">
                                <i class="ph ph-upload-simple"></i> ‰∏äÂÇ≥ÂúñÁâá
                                <input type="file" accept="image/*" class="hidden" @change="(e) => handleFileUpload(e, 'info')">
                             </label>
                        </div>
                        <div v-if="uploadStatus.info" class="text-xs text-blue-500 mt-1 animate-pulse">
                            {{ uploadStatus.info }}
                        </div>
                         <div v-if="tempUploadPreview.info" class="mt-2 relative inline-block">
                             <img :src="tempUploadPreview.info" class="h-16 w-16 object-cover rounded border">
                             <div class="absolute -top-1 -right-1 bg-green-500 text-white rounded-full p-0.5"><i class="ph ph-check text-xs"></i></div>
                         </div>
                    </div>

                    <div class="flex items-center gap-3 mt-1">
                        <input type="checkbox" id="info-done" v-model="newInfoItem.isDone" class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded">
                        <label for="info-done" class="text-gray-900">Â∑≤ËôïÁêÜ/Á¢∫Ë™ç</label>
                    </div>
                </div>
                <div class="mt-5 flex justify-end gap-3">
                    <button @click="closeInfoModal" class="px-4 py-2 text-gray-600 rounded-lg border bg-gray-100">ÂèñÊ∂à</button>
                    <button @click="saveInfoItem" class="px-4 py-2 bg-sky-600 text-white rounded-lg" :disabled="isUploading">
                         {{ isUploading ? '‰∏äÂÇ≥‰∏≠...' : 'ÂÑ≤Â≠ò' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>


  </div> 

  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
    const initializeListWithIds = (list) => list.map(item => ({ ...item, id: item.id || generateId() }));
    function isInstagramLink(url) {
      if (!url) return false;
      return /^(https?:\/\/(www\.)?instagram\.com\/(p|reel)\/)/i.test(url);
    }

    // --- SUPABASE SETUP ---
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- UTILITIES ---
    function describeWeather(code) {
      if (code >= 95) return 'Èõ∑Èô£Èõ®';
      if (code >= 80) return 'Èô£Èõ®';
      if (code >= 60) return 'Â∞èÈõ®';
      if (code >= 50) return 'ÊØõÊØõÈõ®';
      if (code >= 40) return 'ÊúâÈúß';
      if (code >= 30) return 'Èô∞Â§©';
      if (code >= 20) return 'Â±ÄÈÉ®Â§öÈõ≤';
      if (code >= 10) return 'Êô¥ÊôÇÂ§öÈõ≤';
      return 'Êô¥Â§©';
    }


    createApp({
      setup() {
        const appVersion = ref('v251213-2.11'); // **UPDATED VERSION**
        const currentTab = ref('Ë°åÁ®ã');
        const selectedDay = ref(0); 

        // Sync Status
        const syncState = ref('synced'); // 'synced', 'saving', 'loading', 'error'
        const syncStatusText = computed(() => {
          switch (syncState.value) {
            case 'synced': return 'Â∑≤ÂêåÊ≠•';
            case 'saving': return 'ÂêåÊ≠•‰∏≠';
            case 'loading': return '‰∏ãËºâ‰∏≠';
            case 'error': return 'ÂêåÊ≠•Â§±Êïó';
            default: return 'Êú™Áü•';
          }
        });

        // Date/Day Info - UPDATED labels to remove city/suburb description
        const days = reactive([
          { date: '15', week: '‰∏Ä', label: 'ÊäµÈÅî (Day 1)', type: 'flight-out' },
          { date: '16', week: '‰∫å', label: 'Day 2', type: 'normal' },
          { date: '17', week: '‰∏â', label: 'Day 3', type: 'normal' },
          { date: '18', week: 'Âõõ', label: 'ÂõûÁ®ã (Day 4)', type: 'flight-return' },
        ]);
        const isFlightDay = computed(() => ['flight-out', 'flight-return'].includes(days[selectedDay.value]?.type));

        // Itinerary
        const initialItinerary = [
          [
            { title: 'Ëà™Áè≠ÊäµÈÅî (CX400)', note: 'TPE 14:45 ÊäµÈÅî', time: '14:45', address: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥' },
            { title: 'Ê©üÂ†¥ - ÈÖíÂ∫ó', note: 'Â∑¥Â£´/Êç∑ÈÅã/Ë®àÁ®ãËªä', time: '15:30', address: '' },
            { title: 'Check In Ê∞∏ÂÆâÊ£ß', note: 'Ë•øÈñÄÁî∫', time: '16:30', address: 'Êñ∞ÂåóÂ∏Ç‰∏≠ÂíåÂçÄ‰∏≠Â±±Ë∑Ø‰∫åÊÆµ347Ëôü' },
            { title: 'ÊôöÈ§êÔºöÈõûÊπØÊ¶ÆÈ∫µÈ£üÈ§®Ôºà17:00 ÂæåÔºâ', note: 'ÊôöÈ§ê', time: '17:30', address: 'Âè∞ÂåóÂ∏ÇËê¨ËèØÂçÄË•øÊòåË°ó202Ëôü' },
            { title: 'ËèØË•øË°óÂ§úÂ∏Ç', note: 'ÈÄõÂ§úÂ∏Ç', time: '19:30', address: 'Âè∞ÂåóÂ∏ÇËê¨ËèØÂçÄËèØË•øË°ó' },
            { title: 'ËÉñËÄÅÈóÜË™†ÊÑèËÇâÁ≤•ÔºàÂÆµÂ§úÔºâ', note: 'ÂÆµÂ§ú', time: '22:00', address: 'Âè∞ÂåóÂ∏ÇËê¨ËèØÂçÄÂª£Â∑ûË°ó253Ëôü' }
          ],
          [
            { title: 'ÂçàÈ§êÔºöÊ¢ÅÂ±±Ê≥äÂ∞èÁ±†ÊπØÂåÖ', note: '‰∏≠Âçà', time: '12:00', address: 'Âè∞ÂåóÂ∏ÇËê¨ËèØÂçÄÂ≥®ÁúâË°ó22Ëôü' },
            { title: 'Ë•øÈñÄÁî∫Ë°å‰∏ã / Cafe ‰ºëÊÅØ', note: 'ÊÇ†ÈñíÂçàÂæå', time: '14:00', address: '' },
            { title: 'ÂØßÂ§èÂ§úÂ∏Ç', note: 'ÊôöÈ§êËá™ÁêÜ', time: '18:30', address: 'Âè∞ÂåóÂ∏ÇÂ§ßÂêåÂçÄÂØßÂ§èË∑Ø' },
            { title: 'ÂõûÈÖíÂ∫ó', note: '‰ºëÊÅØ', time: '21:00', address: '' }
          ],
          [
            { title: 'Ë•øÈñÄÁî∫Ë£úË≤∑Êâã‰ø°', note: 'Ë≥ºÁâ©', time: '11:00', address: '' },
            { title: 'ÈáëÂúíÊéíÈ™®ÔºàÂçàÈ§êÔºâ', note: 'ÂçàÈ§ê', time: '13:00', address: 'Âè∞ÂåóÂ∏ÇËê¨ËèØÂçÄÊº¢‰∏≠Ë°ó121-1Ëôü' },
            { title: 'ÂâçÂæÄÊ©üÂ†¥ÔºàCX443Ôºâ', note: 'Êê≠‰πò CX443 Âõû HKG', time: '15:50', address: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥' }
          ],
          [
            { title: 'ÂõûÈ¶ôÊ∏Ø', note: 'Êê≠‰πò CX443 Âõû HKG', time: '15:50', address: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÂúãÈöõ' },
          ]
        ];
        const itinerary = reactive(initialItinerary.map(dayItems => initializeListWithIds(dayItems).map(item => ({ ...item, address: item.address || '' }))));
        const sortedItinerary = computed(() => {
          const currentDayItinerary = itinerary[selectedDay.value];
          if (!currentDayItinerary || currentDayItinerary.length === 0) return [];
          return [...currentDayItinerary].sort((a, b) => {
            const timeA = a.time || '23:59';
            const timeB = b.time || '23:59';
            return timeA.localeCompare(timeB);
          });
        });
        // Map logic
        const selectedMapLocation = ref(null);
        function showLocationOnMap(item) {
          if (item.address && item.address.trim() !== '') {
            selectedMapLocation.value = { title: item.title, address: item.address, id: item.id };
          } else {
            selectedMapLocation.value = null;
          }
        }
        function generateMapLink(address, type) {
          if (!address) return '#';
          const encodedAddress = encodeURIComponent(address);
          if (type === 'search') return `https://www.google.com/maps/search/?api=1&query=$${encodedAddress}`;
          if (type === 'navigate') return `https://www.google.com/maps/dir/?api=1&destination=$${encodedAddress}`;
          return '#';
        }

        // Flights
        const flights = ref([
          { id: 'outbound', type: 'outbound', date: '2025-12-15', code: 'CX400', depTime: '12:45', arrTime: '14:45', fromCode: 'HKG', fromTerminal: 'T1', toCode: 'TPE', toTerminal: 'T2', title: 'Cathay Pacific', note: 'Á∂ìÊøüËâô (Â∑≤ÂäÉ‰Ωç)', isConfirmed: true },
          { id: 'return', type: 'return', date: '2025-12-18', code: 'CX443', depTime: '17:00', arrTime: '18:55', fromCode: 'TPE', fromTerminal: 'T2', toCode: 'HKG', toTerminal: 'T1', title: 'Cathay Pacific', note: 'Á∂ìÊøüËâô', isConfirmed: false },
        ]);
        const activeFlight = computed(() => {
          const dayType = days[selectedDay.value]?.type;
          if (dayType === 'flight-out') return flights.value.find(f => f.type === 'outbound');
          if (dayType === 'flight-return') return flights.value.find(f => f.type === 'return');
          return null;
        });
        const shouldShowFlightCard = computed(() => activeFlight.value !== null && ['Ë°åÂâç', 'Ë°åÁ®ã'].includes(currentTab.value));
        
        // --- FILE UPLOAD LOGIC ---
        const isUploading = ref(false);
        const uploadStatus = reactive({ shopping: '', info: '' });
        const tempUploadPreview = reactive({ shopping: null, info: null });
        const pendingUploadFiles = { shopping: null, info: null };

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Set preview immediately
            tempUploadPreview[type] = URL.createObjectURL(file);
            pendingUploadFiles[type] = file;
            uploadStatus[type] = 'Ê∫ñÂÇô‰∏äÂÇ≥...';
        }

        async function uploadFileToSupabase(file) {
            if (!file) return null;
            const fileName = `${Date.now()}_${Math.floor(Math.random()*1000)}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
            
            try {
                const { data, error } = await supabaseClient
                    .storage
                    .from('uploads')
                    .upload(fileName, file);
                if (error) throw error;
                
                const { data: publicData } = supabaseClient
                    .storage
                    .from('uploads')
                    .getPublicUrl(fileName);
                return publicData.publicUrl;
            } catch (e) {
                console.error('Upload failed:', e);
                alert('‰∏äÂÇ≥Â§±Êïó: ' + e.message);
                return null;
            }
        }

        // --- IMAGE VIEWER ---
        const imageViewer = reactive({ open: false, url: '' });
        function openImageViewer(url) {
            if (!url) return;
            if (isInstagramLink(url)) {
                window.open(url, '_blank');
            } else {
                imageViewer.url = url;
                imageViewer.open = true;
            }
        }

        // Modals & New Item Data
        const itineraryModalOpen = ref(false);
        const newItineraryItem = reactive({ id: null, title: '', note: '', time: '', address: '', dayIndex: 0, originalDayIndex: null });
        const quickItinerary = reactive({ title: '', time: '' });

        const shoppingList = ref(initializeListWithIds([
          { name: 'È≥≥Ê¢®ÈÖ• (‰Ω≥Âæ∑)', isDone: false, imageURL: '' },
          { name: 'Â§™ÈôΩÈ§Ö (ÈòøÊòéÂ∏´)', isDone: false, imageURL: '' },
          { name: 'ËÇâ‰πæ', isDone: true, imageURL: '' }
        ]));
        const shoppingModalOpen = ref(false);
        const newShoppingItem = reactive({ id: null, name: '', imageURL: '', isDone: false });
        
        const expenses = ref([
          { id: Date.now()+1, name:'ÈõÖÈ¶ôÁÅ´Èçã', amount: 300, category:'È§êÈ£≤', date: '12/15', isDone:false, currency: 'TWD', paymentMethod: 'cash' },
          { id: Date.now()+2, name:'Taxi Ê©üÂ†¥->ÈÖíÂ∫ó', amount: 250, category:'‰∫§ÈÄö', date: '12/15', isDone:false, currency: 'TWD', paymentMethod: 'credit_card' }
        ]);
        const expenseModalOpen = ref(false);
        const expenseFilter = ref('all'); // 'all', 'credit', 'cash'
        const newExpense = reactive({ id: null, name:'', amount:null, currency:'TWD', category:'È§êÈ£≤', paymentMethod: 'cash', date: '' });
        const infoList = ref(initializeListWithIds([
          { title:'Ë•øÈñÄÁî∫Ê∞∏ÂÆâÊ£ß (ÈõªË©±)', note:'+886 2 2352 3090', isDone:false, imageURL: '' },
        ]));
        
        // Expense Computed Logic
        const totalExpense = computed(() => {
          const twdToHkdRate = Number(rate.value) || 0.25; // Default fallback if rate fails
          // Helper to convert any amount to HKD
          const toHKD = (amount, currency) => {
              if (currency === 'HKD') return amount;
              if (currency === 'TWD') return amount * twdToHkdRate;
              if (currency === 'JPY') return amount * 0.052; // Approx
              if (currency === 'USD') return amount * 7.8;
              return amount;
          };

          let totalHkd = 0;
          let creditHkd = 0;
          let cashHkd = 0;

          expenses.value.forEach(e => {
             const val = toHKD(Number(e.amount) || 0, e.currency);
             totalHkd += val;
             if(e.paymentMethod === 'credit_card') creditHkd += val;
             else cashHkd += val;
          });

          // Convert back to TWD for display (approx)
          const toTWD = (hkdVal) => (hkdVal / twdToHkdRate).toFixed(0);
          return {
              hkd: totalHkd.toFixed(0),
              twd: toTWD(totalHkd),
              creditHkd: creditHkd.toFixed(0),
              creditTwd: toTWD(creditHkd),
              cashHkd: cashHkd.toFixed(0),
              cashTwd: toTWD(cashHkd)
          };
        });

        const filteredExpenses = computed(() => {
            if (expenseFilter.value === 'all') return expenses.value;
            if (expenseFilter.value === 'credit') return expenses.value.filter(e => e.paymentMethod === 'credit_card');
            return expenses.value.filter(e => e.paymentMethod !== 'credit_card'); // Default to cash
        });
        
        // Weather & Rate
        const weather = reactive({ temp:'--', desc:'ËºâÂÖ•‰∏≠...', rain:0, code:0 });
        const weatherIconClass = computed(()=>{
          const c = weather.code || 0;
          if (c>=95) return 'ph ph-cloud-lightning-rain';
          if (c>=80) return 'ph ph-cloud-lightning-rain';
          if (c>=50) return 'ph ph-cloud-rain';
          if (c>2) return 'ph ph-cloud';
          return 'ph ph-sun';
        });
        const rate = ref(null);
        const lastRateUpdate = ref(null);
        const formattedRate = computed(()=> rate.value !== null ? rate.value : '...');
        const lastRateUpdateLabel = computed(()=>{
          if (!lastRateUpdate.value) return '‚Äî';
          return new Date(lastRateUpdate.value).toLocaleTimeString('zh-HK');
        });
        function selectDay(i){
          selectedDay.value = i;
          selectedMapLocation.value = null;
        }

        // --- ACTIONS ---

        // Itinerary (UPDATED logic for Date Moving)
        function openItineraryModal(item = null) {
          // Reset modal state
          Object.assign(newItineraryItem, { 
              id: null, 
              title: '', 
              note: '', 
              time: '', 
              address: '', 
              dayIndex: selectedDay.value, 
              originalDayIndex: null 
          });
          if (item) {
              Object.assign(newItineraryItem, deepClone(item));
              newItineraryItem.dayIndex = selectedDay.value; 
              newItineraryItem.originalDayIndex = selectedDay.value;
          }
          itineraryModalOpen.value = true;
        }
        function closeItineraryModal() {
          itineraryModalOpen.value = false;
        }
        
        function saveItineraryItem() {
          if (!newItineraryItem.title.trim()) return;
          const itemToSave = {
            id: newItineraryItem.id || generateId(),
            title: newItineraryItem.title.trim(),
            note: newItineraryItem.note.trim(),
            time: newItineraryItem.time.trim(),
            address: newItineraryItem.address.trim(),
          };
          const targetDayIdx = newItineraryItem.dayIndex;
          const originalDayIdx = newItineraryItem.originalDayIndex;

          // Case 1: Editing an existing item
          if (newItineraryItem.id) {
              // If day changed: Remove from old, Add to new
              if (originalDayIdx !== null && originalDayIdx !== targetDayIdx) {
                   const oldList = itinerary[originalDayIdx];
                   const oldIndex = oldList.findIndex(i => i.id === itemToSave.id);
                   if (oldIndex !== -1) oldList.splice(oldIndex, 1);
                   
                   itinerary[targetDayIdx].push(itemToSave);
              } else {
                  // Same day, just update
                   const list = itinerary[targetDayIdx];
                   const index = list.findIndex(i => i.id === itemToSave.id);
                   if (index !== -1) list.splice(index, 1, itemToSave);
              }
          } 
          // Case 2: Creating a new item
          else {
              itinerary[targetDayIdx].push(itemToSave);
          }

          if (selectedMapLocation.value && selectedMapLocation.value.id === itemToSave.id) {
            showLocationOnMap(itemToSave);
          }
          closeItineraryModal();
          saveAll();
        }

        function removeItineraryItem(idToRemove) {
          if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÈ†ÖÁõÆÂóéÔºü')) return;
          const dayItems = itinerary[selectedDay.value];
          const index = dayItems.findIndex(i => i.id === idToRemove);
          if (index !== -1) {
            dayItems.splice(index, 1);
            if (selectedMapLocation.value && selectedMapLocation.value.id === idToRemove) selectedMapLocation.value = null;
            saveAll();
          }
        }
        function addQuickItinerary(){
          if (!quickItinerary.title.trim()) return;
          const dayItems = itinerary[selectedDay.value];
          const itemToSave = {
            id: generateId(),
            title: quickItinerary.title.trim(),
            note: '',
            time: quickItinerary.time || '',
            address: ''
          };
          dayItems.push(itemToSave);
          quickItinerary.title = '';
          quickItinerary.time = '';
          saveAll();
        }

        // Flights
        const flightModalOpen = ref(false);
        const newFlight = reactive({ id: null, type: 'outbound', date: '', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
        function openFlightModal(flightId = null){
          Object.assign(newFlight, { id: null, type: 'outbound', date: days[selectedDay.value]?.date ? `2025-12-${days[selectedDay.value].date.padStart(2, '0')}` : '2025-12-15', code: '', depTime: '', arrTime: '', fromCode: '', fromTerminal: '', toCode: '', toTerminal: '', title: '', note: '' });
          const dayType = days[selectedDay.value]?.type;
          if (dayType === 'flight-out') newFlight.type = 'outbound';
          else if (dayType === 'flight-return') newFlight.type = 'return';
          let flight = flights.value.find(f => f.id === flightId);
          if (!flight && flightId === 'new') { 
             flight = flights.value.find(f => f.type === newFlight.type);
          }
          
          if (flight) Object.assign(newFlight, deepClone(flight));
          else if(dayType === 'flight-out' && !flightId){
            newFlight.fromCode = 'HKG';
            newFlight.toCode = 'TPE';
          } else if(dayType === 'flight-return' && !flightId){
            newFlight.fromCode = 'TPE';
            newFlight.toCode = 'HKG';
          }
          flightModalOpen.value = true;
        }
        function closeFlightModal() {
          flightModalOpen.value = false;
        }
        function saveFlight(){
          if (!newFlight.code.trim()) return;
          const itemToSave = { ...deepClone(newFlight), id: newFlight.id || newFlight.type || generateId() };
          const index = flights.value.findIndex(f => f.id === itemToSave.id);
          if (index !== -1) flights.value.splice(index, 1, itemToSave);
          else flights.value.push(itemToSave);
          closeFlightModal();
          saveAll();
        }
        function openAddModal() {
            if (isFlightDay.value && currentTab.value === 'Ë°åÁ®ã') openFlightModal('new');
            else if (currentTab.value === 'Ë°åÁ®ã') openItineraryModal();
            else if (currentTab.value === 'Ë≥ºÁâ©') openShoppingModal();
            else if (currentTab.value === 'Ë≥áË®ä') openInfoModal();
            else if (currentTab.value === 'Ë°åÂâç') addPreNote(); 
            else if (currentTab.value === 'Ë®òÂ∏≥') openExpenseModal(null); 
        }

        // Shopping
        function openShoppingModal(item = null) {
          Object.assign(newShoppingItem, { id: null, name: '', imageURL: '', isDone: false });
          tempUploadPreview.shopping = null;
          pendingUploadFiles.shopping = null;
          uploadStatus.shopping = '';

          if (item) Object.assign(newShoppingItem, deepClone(item));
          shoppingModalOpen.value = true;
        }
        function closeShoppingModal() {
          shoppingModalOpen.value = false;
        }
        async function saveShoppingItem() {
          if (!newShoppingItem.name.trim()) return;
          if (pendingUploadFiles.shopping) {
              isUploading.value = true;
              uploadStatus.shopping = 'Ê≠£Âú®‰∏äÂÇ≥...';
              const uploadedUrl = await uploadFileToSupabase(pendingUploadFiles.shopping);
              isUploading.value = false;
              if (uploadedUrl) {
                  newShoppingItem.imageURL = uploadedUrl;
              }
          }

          const itemToSave = { ...deepClone(newShoppingItem), id: newShoppingItem.id || generateId() };
          const index = shoppingList.value.findIndex(i => i.id === itemToSave.id);
          if (index !== -1) shoppingList.value.splice(index, 1, itemToSave);
          else shoppingList.value.push(itemToSave);
          closeShoppingModal();
          saveAll();
        }
        function removeShoppingItem(idToRemove) {
          if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë≥ºÁâ©È†ÖÁõÆÂóéÔºü')) return;
          const index = shoppingList.value.findIndex(i => i.id === idToRemove);
          if (index !== -1) {
            shoppingList.value.splice(index, 1);
            saveAll();
          }
        }

        // Info
        const infoModalOpen = ref(false);
        const newInfoItem = reactive({ id: null, title: '', note: '', isDone: false, imageURL: '' });
        function openInfoModal(item = null) {
          Object.assign(newInfoItem, { id: null, title: '', note: '', isDone: false, imageURL: '' });
          tempUploadPreview.info = null;
          pendingUploadFiles.info = null;
          uploadStatus.info = '';

          if (item) Object.assign(newInfoItem, deepClone(item));
          infoModalOpen.value = true;
        }
        function closeInfoModal() {
          infoModalOpen.value = false;
        }
        async function saveInfoItem() {
          if (!newInfoItem.title.trim()) return;
          if (pendingUploadFiles.info) {
              isUploading.value = true;
              uploadStatus.info = 'Ê≠£Âú®‰∏äÂÇ≥...';
              const uploadedUrl = await uploadFileToSupabase(pendingUploadFiles.info);
              isUploading.value = false;
              if (uploadedUrl) {
                  newInfoItem.imageURL = uploadedUrl;
              }
          }

          const itemToSave = { ...deepClone(newInfoItem), id: newInfoItem.id || generateId() };
          const index = infoList.value.findIndex(i => i.id === itemToSave.id);
          if (index !== -1) infoList.value.splice(index, 1, itemToSave);
          else infoList.value.push(itemToSave);
          closeInfoModal();
          saveAll();
        }
        function removeInfo(idToRemove) {
          if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë≥áË®äÈ†ÖÁõÆÂóéÔºü')) return;
          const index = infoList.value.findIndex(i => i.id === idToRemove);
          if (index !== -1) {
            infoList.value.splice(index, 1);
            saveAll();
          }
        }

        // PRE-TRIP notes
        const preTripNotes = ref(initializeListWithIds([
          { name:'ÂÖåÊèõÂè∞Âπ£', isDone: true },
          { name:'Á¢∫Ë™ç‰ΩèÂÆøÈ†êÁ¥ÑÂñÆ', isDone: false },
          { name:'Ë≥ºË≤∑ SIM Âç°', isDone: false },
          { name:'Ë≠∑ÁÖßÂΩ±Êú¨ÂÇô‰ªΩ', isDone: true }
        ]));
        const newPreNote = ref(''); 
        const preNoteModalOpen = ref(false);
        const editingPreNote = reactive({ id: null, name: '', isDone: false });
        function addPreNote() {
            if (!newPreNote.value.trim()) return;
            preTripNotes.value.push({ id: generateId(), name: newPreNote.value.trim(), isDone: false });
            newPreNote.value = '';
            saveAll();
        }
        function removePreNote(id) {
            if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§È†ÖÁõÆÂóéÔºü')) return;
            preTripNotes.value = preTripNotes.value.filter(n => n.id !== id);
            saveAll();
        }
        function togglePreNoteDone(id) {
            const note = preTripNotes.value.find(n => n.id === id);
            if (note) {
                note.isDone = !note.isDone;
                saveAll();
            }
        }
        function editPreNote(note) {
            Object.assign(editingPreNote, deepClone(note));
            preNoteModalOpen.value = true;
        }
        function closePreNoteModal() {
            preNoteModalOpen.value = false;
        }
        function savePreNoteEdit() {
            if (!editingPreNote.name.trim()) return;
            const index = preTripNotes.value.findIndex(n => n.id === editingPreNote.id);
            if (index !== -1) {
                preTripNotes.value.splice(index, 1, deepClone(editingPreNote));
            }
            closePreNoteModal();
            saveAll();
        }


        // Expenses (UPDATED with Edit + Date Logic)
        function openExpenseModal(item = null) {
            if(item) {
                // EDIT MODE
                // Convert 12/15 format to 2025-12-15 for input type="date"
                let dateVal = '';
                if(item.date) {
                    const [m, d] = item.date.split('/');
                    if(m && d) {
                        dateVal = `2025-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                    }
                }
                
                Object.assign(newExpense, { 
                    id: item.id,
                    name: item.name, 
                    amount: item.amount, 
                    currency: item.currency, 
                    category: item.category, 
                    paymentMethod: item.paymentMethod,
                    date: dateVal
                });
            } else {
                // NEW MODE (Auto Date)
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
                
                Object.assign(newExpense, { 
                    id: null,
                    name:'', 
                    amount:null, 
                    currency:'TWD', 
                    category:'È§êÈ£≤', 
                    paymentMethod: 'cash',
                    date: todayStr 
                });
            }
            expenseModalOpen.value = true;
        }
        function closeExpenseModal() {
            expenseModalOpen.value = false;
        }
        function saveExpense(){
          if (!newExpense.name.trim() || !newExpense.amount) return;
          
          // Format date back to "M/D"
          let dateString = '';
          if (newExpense.date) {
             const [y, m, d] = newExpense.date.split('-');
             dateString = `${parseInt(m)}/${parseInt(d)}`;
          } else {
             const dObj = new Date();
             dateString = `${dObj.getMonth() + 1}/${dObj.getDate()}`;
          }

          const itemToSave = {
            id: newExpense.id || generateId(),
            name: newExpense.name.trim(),
            amount: Number(newExpense.amount),
            currency: newExpense.currency,
            category: newExpense.category,
            paymentMethod: newExpense.paymentMethod,
            date: dateString,
            isDone: false,
          };
          
          if (newExpense.id) {
              // Update existing
              const index = expenses.value.findIndex(e => e.id === newExpense.id);
              if (index !== -1) expenses.value.splice(index, 1, itemToSave);
          } else {
              // Create new (Top of list)
              expenses.value.unshift(itemToSave);
          }
          
          closeExpenseModal();
          saveAll();
        }
        function removeExpense(idToRemove) {
          if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ê∂àË≤ªË®òÈåÑÂóéÔºü')) return;
          expenses.value = expenses.value.filter(e => e.id !== idToRemove);
          saveAll();
        }

        // --- CLOUD SYNC ---
        const TRIP_ID = 'taipei_trip2025';
        let isRemoteUpdate = false;
        let debounceTimer = null;

        function getAppPayload() {
          return {
            itinerary: JSON.parse(JSON.stringify(itinerary)),
            preTripNotes: preTripNotes.value,
            shoppingList: shoppingList.value,
            expenses: expenses.value,
            infoList: infoList.value,
            flights: flights.value
          };
        }

        function applyCloudData(data) {
          if (!data) return;
          isRemoteUpdate = true;
          if (data.itinerary && Array.isArray(data.itinerary)){
            for (let i=0;i<4;i++){
              const loadedItems = (data.itinerary[i] || []).map(item => ({...item, id: item.id || generateId(), address: item.address || '' }));
              itinerary[i].splice(0, itinerary[i].length, ...loadedItems);
            }
          }
          if (data.preTripNotes) preTripNotes.value = initializeListWithIds(data.preTripNotes);
          if (data.shoppingList) shoppingList.value = initializeListWithIds(data.shoppingList);
          
          if (data.expenses) {
              // Ensure paymentMethod exists for older data
              expenses.value = initializeListWithIds(data.expenses).map(e => ({
                  ...e,
                  paymentMethod: e.paymentMethod || 'cash'
              }));
          }
          if (data.infoList) infoList.value = initializeListWithIds(data.infoList);
          if (data.flights) flights.value = initializeListWithIds(data.flights);
          if (syncState.value === 'loading' || syncState.value === 'error') {
            syncState.value = 'synced';
          }
          setTimeout(() => { isRemoteUpdate = false; }, 300);
        }

        async function saveAll() {
            if(isRemoteUpdate) return;
            syncState.value = 'saving';
            if (debounceTimer) clearTimeout(debounceTimer);

            debounceTimer = setTimeout(async () => {
                const payload = getAppPayload();
                try {
                    const { error } = await supabaseClient
                        .from('trip_data')
                        .upsert({ id: TRIP_ID, content: payload });

                    if (error) throw error;
                    syncState.value = 'synced';
                } catch (e) {
                    console.error('Save failed', e);
                    syncState.value = 'error';
                }
            }, 1000);
        }
        
        async function fetchCloudData(isAuto = true){
          if (syncState.value === 'saving' && isAuto) return;
          if(!isAuto) syncState.value = 'loading';
          
          try {
            const { data, error } = await supabaseClient
              .from('trip_data')
              .select('content')
              .eq('id', TRIP_ID)
              .single();
            if (error) throw error;

            if (data && data.content && JSON.stringify(data.content) !== JSON.stringify(getAppPayload())) {
                applyCloudData(data.content);
                syncState.value = 'synced';
            } else {
                syncState.value = 'synced';
            }
          } catch (e) {
            console.error('Fetch fail', e);
            if(!isAuto) syncState.value = 'error';
          }
        }
        
        async function forceReloadCloud() {
             await fetchCloudData(false);
        }

        // --- EXTERNAL DATA FETCHING ---
        async function fetchRate(){
          const API_URL = 'https://open.er-api.com/v6/latest/TWD';
          try {
            const res = await fetch(API_URL);
            if (!res.ok){ rate.value = null; return; }
            const data = await res.json();
            if (data && data.rates && data.rates.HKD){
              if (data.base === 'TWD') {
                rate.value = (data.rates.HKD).toFixed(3);
              } else if (data.rates && data.rates.HKD && data.rates.TWD) {
                rate.value = (1 / data.rates.TWD * data.rates.HKD).toFixed(3);
              } else {
                rate.value = (data.rates.HKD || null);
              }
              lastRateUpdate.value = new Date().toISOString();
            }
          } catch(e){
            console.warn('rate fail', e);
            rate.value = null;
          }
        }

        async function fetchWeather(){
          try {
            const lat = 25.0330, lon = 121.5654;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=precipitation_probability&timezone=Asia%2FTaipei`;
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.current_weather){
              weather.temp = Math.round(data.current_weather.temperature);
              weather.code = data.current_weather.weathercode || 0;
              weather.desc = describeWeather(weather.code);
              if (data.hourly && data.hourly.precipitation_probability){
                const nowTime = data.current_weather.time.slice(0, 13);
                const nowIdx = data.hourly.time.findIndex(t => t.startsWith(nowTime));
                const prob = (nowIdx >= 0) ? data.hourly.precipitation_probability[nowIdx] : (data.hourly.precipitation_probability[0] || 0);
                weather.rain = Math.round(prob);
              } else weather.rain = 0;
            }
          } catch(e){
            console.warn('weather fail', e);
            weather.temp = '...';
            weather.desc = 'ËºâÂÖ•Â§±Êïó';
          }
        }


        // --- LIFECYCLE ---
        onMounted(() => {
          fetchCloudData(false);
          fetchRate();
          fetchWeather();
          
          setInterval(fetchRate, 10*60*1000);
          setInterval(fetchWeather, 10*60*1000);
          setInterval(() => { fetchCloudData(true); }, 15000);
        });
        watch([itinerary, preTripNotes, shoppingList, expenses, infoList, flights], () => { saveAll(); }, { deep:true });
        return {
          appVersion, syncState, syncStatusText, forceReloadCloud,
          currentTab, days, selectedDay, selectDay, isFlightDay,
          preTripNotes, newPreNote, addPreNote, removePreNote, editPreNote, togglePreNoteDone,
          preNoteModalOpen, editingPreNote, closePreNoteModal, savePreNoteEdit,
          itinerary, sortedItinerary, itineraryModalOpen, newItineraryItem, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem,
          quickItinerary, addQuickItinerary,
          selectedMapLocation, showLocationOnMap, generateMapLink,
          shoppingList, shoppingModalOpen, newShoppingItem, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, isInstagramLink,
          expenses, newExpense, saveExpense, removeExpense, expenseFilter, filteredExpenses, totalExpense,
          expenseModalOpen, openExpenseModal, closeExpenseModal,
          infoList, infoModalOpen, newInfoItem, openInfoModal, closeInfoModal, saveInfoItem, removeInfo,
          activeFlight, shouldShowFlightCard, weather, weatherIconClass, rate, formattedRate, lastRateUpdateLabel,
          openAddModal, flightModalOpen, newFlight, openFlightModal, closeFlightModal, saveFlight,
          handleFileUpload, uploadStatus, tempUploadPreview, isUploading,
          imageViewer, openImageViewer
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
