<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v3.17</title> <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html {
      height: 100%;
      overscroll-behavior-y: none;
    }

    body {
      height: 100%;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #000;
      margin: 0;
      color: #000;
      overflow: hidden;
    }

    /* Scrollable Container */
    #app {
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Main Scroll Area */
    main {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 20px;
    }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    
    /* --- Components --- */

    /* iOS Glass Card (Light) */
    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      border-radius: 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      overflow: hidden;
    }

    /* iOS Premium Dark Glass Card (Flight/Expense) */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      /* Slightly darker for better contrast */
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px; /* iOS 26 rounded corners */
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .dark-glass-gradient {
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none;
        z-index: 0;
    }

    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      margin-bottom: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s, transform 0.1s;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .ios-list-item:active {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(0.98);
    }

    /* Action Buttons */
    .action-btn-group {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
        padding-left: 8px;
        opacity: 0.4;
        transition: opacity 0.2s;
    }
    .ios-list-item:hover .action-btn-group,
    .action-btn-group:active {
        opacity: 1;
    }
    .icon-btn {
        padding: 8px;
        color: #8E8E93;
        transition: color 0.2s;
        border-radius: 50%;
    }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    .icon-btn.edit:hover { color: var(--ios-primary); }
    .icon-btn.delete:hover { color: var(--ios-danger); }

    /* Inputs */
    .ios-input {
      background: rgba(118, 118, 128, 0.12);
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 17px;
      color: #000;
      width: 100%;
      box-sizing: border-box;
      transition: background 0.2s;
    }
    .ios-input:focus {
      background: rgba(118, 118, 128, 0.2);
      outline: none;
    }
    .ios-input::placeholder { color: #8E8E93; }

    /* Modals */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
    }
    
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.9);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 32px;
      display: flex;
      flex-direction: column;
      max-height: 85vh;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.4);
    }

    .ios-modal-header {
      padding: 16px;
      text-align: center;
      font-weight: 600;
      font-size: 17px;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .ios-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      -webkit-overflow-scrolling: touch;
    }

    .ios-modal-footer {
      padding: 16px 24px;
      border-top: 0.5px solid rgba(0,0,0,0.1);
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.5);
    }

    /* Buttons */
    .btn-ios-cancel {
      flex: 1;
      height: 50px;
      border-radius: 14px;
      background: rgba(118, 118, 128, 0.12);
      color: #000;
      font-weight: 600;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-ios-primary {
      flex: 1;
      height: 50px;
      border-radius: 14px;
      background: var(--ios-primary);
      color: white;
      font-weight: 600;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
    }
    .btn-ios-primary:active { opacity: 0.8; transform: scale(0.98); }
    .btn-ios-primary:disabled { opacity: 0.5; box-shadow: none; }

    /* Dock */
    .iphone-dock {
      background: rgba(245, 245, 245, 0.75);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border-radius: 38px;
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    /* Tabs */
    .day-tab {
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .day-tab.active {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }

    .task-done { text-decoration: line-through; color: #8E8E93; opacity: 0.7; }
    
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    /* Flight Status Colors */
    .status-ontime { color: var(--ios-success); background: rgba(52, 199, 89, 0.15); border: 1px solid rgba(52, 199, 89, 0.2); }
    .status-delayed { color: var(--ios-danger); background: rgba(255, 59, 48, 0.15); border: 1px solid rgba(255, 59, 48, 0.2); }
    .status-boarding { color: var(--ios-warning); background: rgba(255, 204, 0, 0.15); border: 1px solid rgba(255, 204, 0, 0.2); }

  </style>
</head>

<body>
  <div id="app">

    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover blur-[4px] scale-105" alt="Taipei Background">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 no-scrollbar pb-safe px-5">

      <div class="flex items-center justify-between mb-8 mt-4">
        <div>
          <h1 class="text-[34px] leading-tight font-bold tracking-tight text-black drop-shadow-sm font-[SF Pro Display]">
            eMenu Taipei
          </h1>
          <div class="flex items-center gap-2 mt-0.5 pl-1">
            <span class="text-[9px] font-semibold text-gray-400/80 uppercase tracking-widest">{{ appVersion }}</span>
            
            <div class="flex items-center gap-2 bg-white/50 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
              <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300"
                     :class="{
                        'bg-green-500': syncState === 'synced',
                        'bg-yellow-400': syncState === 'saving' || syncState === 'loading',
                        'bg-red-500': syncState === 'error'
                     }"></div>
                <span class="text-[10px] font-medium text-gray-500">{{ syncStatusText }}</span>
            </div>
             <button @click="forceReloadCloud" class="text-gray-400 hover:text-gray-600 transition p-1" title="Reload">
                <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
            </button>
          </div>
        </div>
      
        <div class="text-right">
           <div class="flex flex-col items-end">
              <span class="text-[10px] font-bold text-[#007AFF] uppercase tracking-wide mb-0.5">即時匯率</span>
              <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide mb-1">HKD / TWD</span>
           </div>
           <div class="text-xl font-bold text-gray-800 tracking-tight font-mono leading-none">
             {{ formattedRate }}
           </div>
           <div class="text-[9px] font-medium text-gray-400/80 mt-1 font-mono tracking-tight">
             更新：{{ lastRateUpdateLabel }}
           </div>
        </div>
      </div>

      <div class="mb-8">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button @click="currentTab = '準備'" 
               class="day-tab flex-shrink-0 w-[20%] h-[76px] rounded-2xl flex flex-col items-center justify-center text-xs relative overflow-hidden group"
               :class="{ 'active': currentTab === '準備' }">
             <i class="ph ph-list-checks text-2xl mb-1 text-gray-400 transition-colors group-[.active]:text-[#007AFF]"></i>
             <span class="font-medium text-gray-500 group-[.active]:font-bold">準備</span>
          </button>
          
          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = '行程'"
                  class="day-tab flex-shrink-0 w-[22%] h-[76px] rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group"
                  :class="{ 'active': selectedDay === i && currentTab === '行程' }">
            <span class="text-[10px] font-bold uppercase text-gray-400 mb-0.5 group-[.active]:text-[#007AFF]">Day {{ i + 1 }}</span>
            <span class="text-[11px] font-medium text-gray-400 group-[.active]:text-gray-800">{{ d.week }}</span>
            <span class="text-lg font-bold mt-0.5 leading-none text-gray-600 group-[.active]:text-black">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentTab === '行程'" class="space-y-5 mb-6">
        
        <div class="ios-card p-5 relative">
          <div class="flex justify-between items-start">
              
              <div>
                  <div class="flex items-center gap-1.5 text-gray-500 mb-0.5">
                    <i class="ph ph-map-pin-simple-area text-xs"></i>
                    <span class="text-[11px] font-bold uppercase tracking-wider">台北市</span>
                  </div>
            
                  <div class="text-[52px] leading-none font-light tracking-tighter text-black flex items-start">
                    {{ weather.temp }}<span class="text-3xl mt-1 font-normal">°</span>
                  </div>
              </div>
              <div class="text-right pt-1">
                <i :class="weatherIconClass" class="text-[3.5rem] text-gray-800/80 drop-shadow-sm"></i>
              </div>
          </div>
          
          <div class="mt-4 border-t border-gray-400/20 pt-3">
             <div class="flex flex-wrap items-center justify-between gap-y-2">
               
                  <div class="flex items-center gap-2">
                     <span class="text-lg font-bold text-gray-800 tracking-tight">{{ weather.desc }}</span>
                     
                     <div class="flex items-center gap-1 text-[11px] font-bold text-[#007AFF] bg-blue-50/80 px-2 py-0.5 rounded-full border border-blue-100/50">
                       <i class="ph ph-drop-fill text-xs"></i> 降雨機率 {{ weather.rain }}%
                     </div>

                     <div v-if="weather.warning" class="flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full border border-red-100 animate-pulse">
                        <i class="ph ph-warning-fill"></i> {{ weather.warning }}
                     </div>
                 </div>
                 
                 <div class="flex gap-2 text-sm font-semibold text-gray-700/80">
                     <span>H:{{ weather.max }}°</span>
                     <span>L:{{ weather.min }}°</span>
                 </div>
             </div>

             <div class="mt-4 grid grid-cols-4 gap-1 w-full text-center">
            
                <div class="flex flex-col items-center justify-center border-r border-gray-300/30 last:border-0">
                   <span class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">體感</span>
                    <span class="text-xs font-semibold text-gray-800">{{ weather.feelsLike }}°</span>
                </div>
                <div class="flex flex-col items-center justify-center border-r border-gray-300/30 last:border-0">
                  <span class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">濕度</span>
                    <span class="text-xs font-semibold text-gray-800">{{ weather.humidity }}%</span>
                </div>
                <div class="flex flex-col items-center justify-center border-r border-gray-300/30 last:border-0">
                   <span class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">風速</span>
                    <span class="text-xs font-semibold text-gray-800">{{ weather.wind }}</span>
                </div>
                <div class="flex flex-col items-center justify-center">
                    <span class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">UV</span>
                    <span class="text-xs font-semibold text-gray-800">{{ weather.uv }}</span>
                </div>
             </div>
          </div>
        </div>

        <transition name="fade">
          <div v-if="shouldShowFlightCard" class="ios-card-dark-glass p-0">
            <div class="dark-glass-gradient"></div>
              
              <div class="p-5 pb-2 relative z-10">
                  <div class="flex justify-between items-center mb-1">
                      <div class="flex items-center gap-2">
                        <i class="ph ph-airplane-in-flight text-[#007AFF] text-lg"></i>
                          <span class="text-xs font-bold uppercase tracking-widest opacity-70">即時航班動態</span>
                      </div>
                      <button @click.stop="openFlightModal(activeFlight.id)" class="text-white/50 hover:text-white bg-white/10 hover:bg-white/20 p-1.5 rounded-full transition backdrop-blur-md">
                          <i class="ph ph-pencil-simple text-sm"></i>
                      </button>
                  </div>
                  
                  <div class="flex justify-between items-center mt-3">
                      <div class="px-3 py-1 rounded-full text-[11px] font-bold tracking-wide border backdrop-blur-md"
                           :class="getStatusClass(activeFlight.status)">
                          {{ activeFlight.status || 'Scheduled' }}
                      </div>
                      </div>
          
              </div>

              <div class="px-5 pt-1 pb-5 relative z-10"> <div class="flex items-center justify-between mt-4">
                    <div class="text-center min-w-[60px]">
                       <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.fromCode }}</div>
                       <div class="text-[10px] font-bold opacity-60 mt-1 uppercase">{{ activeFlight.fromTerminal }}</div>
                    </div>
                 
                    <div class="flex-1 px-4 flex flex-col items-center">
                       <div class="text-[10px] font-mono opacity-50 mb-1">{{ activeFlight.code }}</div>
                       <div class="w-full flex items-center gap-2">
                           <div class="h-[2px] bg-white/20 flex-1 rounded-full"></div>
                           <i class="ph ph-airplane-tilt text-xl opacity-90 text-[#007AFF]"></i>
                           <div class="h-[2px] bg-white/20 flex-1 rounded-full"></div>
                       </div>
                       <div class="text-[10px] mt-1.5 opacity-80 font-medium tracking-wide text-center">{{ activeFlight.note }}</div>
                     </div>
                    
                    <div class="text-center min-w-[60px]">
                       <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.toCode }}</div>
                       <div class="text-[10px] font-bold opacity-60 mt-1 uppercase">{{ activeFlight.toTerminal }}</div>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-end mt-6 pt-4 border-t border-white/10">
                      <div>
                          <div class="text-[10px] opacity-50 uppercase tracking-wider mb-0.5">預計起飛</div>
                          <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.depTime }}</div>
                      </div>
                      
                      <div class="flex flex-col items-center bg-white/10 px-4 py-2 rounded-xl border border-white/10">
                          <div class="text-[9px] opacity-50 uppercase tracking-widest mb-0.5">登機閘口</div> 
                          <div class="text-xl font-bold text-[#FFCC00]">{{ activeFlight.gate || '--' }}</div>
                      </div>

                      <div class="text-right">
                          <div class="text-[10px] opacity-50 uppercase tracking-wider mb-0.5">預計抵達</div>
                          <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.arrTime }}</div>
                      </div>
                  </div>
              </div>

              <div v-if="activeFlight.liveLink" class="relative z-10 p-5 pt-0">
                  <button @click="window.open(activeFlight.liveLink, '_blank')"
                          class="w-full h-[44px] rounded-xl bg-blue-200/80 backdrop-blur-md border border-blue-200 text-[#007AFF] font-bold text-sm tracking-wide flex items-center justify-center gap-2 active:scale-[0.98] transition-all shadow-md shadow-blue-500/10">
                      <i class="ph ph-wave-sine text-lg text-[#007AFF] animate-pulse"></i>
                      <span>查看即時航班狀態</span>
                  </button>
              </div>

            </div>
        </transition>

        <transition name="fade">
          <div v-if="selectedMapLocation" class="ios-card bg-white/90 p-4 border-2 border-[#007AFF]/10 relative">
                <button @click="selectedMapLocation = null" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 p-1 rounded-full bg-gray-100 transition">
                    <i class="ph ph-x text-base"></i>
                </button>
                <div class="mb-4 pr-8">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-500 flex-shrink-0">
                             <i class="ph ph-map-pin-fill text-lg"></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900 leading-tight">{{ selectedMapLocation.title }}</h4>
                    </div>
                    <p class="text-sm text-gray-500 pl-[44px] leading-relaxed">{{ selectedMapLocation.address }}</p>
                </div>
                <div class="flex gap-3 pl-[44px]">
                   <a :href="generateMapLink(selectedMapLocation.address, 'search')" target="_blank"
                       class="h-10 px-4 flex items-center justify-center gap-2 bg-gray-100 text-gray-700 rounded-xl font-bold active:scale-95 transition text-sm border border-gray-200">
                      Google Map
                    </a>
                   <a :href="generateMapLink(selectedMapLocation.address, 'navigate')" target="_blank"
                       class="flex-1 h-10 flex items-center justify-center gap-2 bg-[#007AFF] text-white rounded-xl font-bold active:scale-95 transition text-sm shadow-sm shadow-blue-200">
                       <i class="ph ph-navigation-arrow text-lg"></i> 導航
                    </a>
                 </div>
            </div>
        </transition>
      </div>

      <div v-if="currentTab !== '準備' && currentTab !== '記帳'" class="mb-6 sticky top-2 z-20 pointer-events-none w-full flex justify-between items-center px-1">
        <div class="pointer-events-auto">
             <button v-if="isFlightDay && currentTab === '行程'" @click="openFlightModal('new')" 
               class="h-10 pl-3 pr-4 rounded-full bg-white/80 backdrop-blur-xl border border-white/50 text-[#007AFF] shadow-sm active:scale-95 transition-all flex items-center gap-2">
                <i class="ph ph-airplane-tilt text-lg"></i>
                <span class="text-xs font-bold">新增航班</span>
           </button>
        </div>

        <button @click="openAddModal" 
            class="pointer-events-auto h-11 pl-4 pr-5 rounded-full bg-[#007AFF] text-white shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center gap-2">
           <i class="ph ph-plus text-xl text-white/90"></i>
           <span class="text-sm font-bold tracking-wide">{{ currentTab === '行程' ? '加入行程' : '新增項目' }}</span>
        </button>
      </div>

      <div class="rounded-3xl transition-all duration-300">
        
         <div v-if="currentTab === '準備'">
            <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">準備清單</h3>
            <ul class="space-y-2.5">
               <li v-for="(note, i) in preTripNotes" :key="note.id" class="ios-list-item">
                 <div class="flex items-center gap-3.5 flex-1 min-w-0">
                   <div class="relative cursor-pointer" @click="togglePreNoteDone(note.id)">
                      <i class="ph text-2xl transition-colors" :class="note.isDone ? 'ph-check-circle-fill text-[#007AFF]' : 'ph-circle text-gray-300 hover:text-gray-400'"></i>
                  </div>
                  <span class="font-medium text-[16px] truncate" :class="{'task-done': note.isDone, 'text-gray-900': !note.isDone}">{{ note.name }}</span>
                </div>
                <div class="action-btn-group">
                   <button @click.stop="editPreNote(note)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                   <button @click.stop="removePreNote(note.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                </div>
               </li>
            </ul>
            
            <div v-if="preTripNotes.length === 0" class="py-12 text-center">
                <i class="ph ph-clipboard-text text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-gray-400">尚未建立準備清單</p>
            </div>
            
            <div class="mt-6">
               <div class="flex gap-3">
                <input v-model="newPreNote" @keyup.enter="addPreNote" class="ios-input bg-white/70 shadow-sm" placeholder="快速新增項目...">
                <button @click="addPreNote" class="w-12 h-12 flex items-center justify-center bg-[#007AFF] text-white rounded-xl shadow-lg active:scale-95 transition flex-shrink-0">
                    <i class="ph ph-plus text-xl"></i>
                </button>
              </div>
            </div>
         </div>

         <div v-if="currentTab === '行程'">
            <div class="relative pl-4 border-l-2 border-gray-300/50 ml-3 space-y-6 py-2">
               <div v-for="(it, idx) in sortedItinerary" :key="it.id" 
                  @click="showLocationOnMap(it)"
                  class="relative group cursor-pointer">
              
                <div class="absolute -left-[23px] top-1 w-3.5 h-3.5 rounded-full bg-white border-[3px] border-gray-300 group-hover:border-[#007AFF] transition-colors z-10 shadow-sm"></div>
                
                <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-4 border border-white/60 shadow-sm transition-all active:scale-[0.99] active:bg-white/90">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-bold text-[#007AFF] font-mono bg-blue-50/80 px-1.5 rounded">{{ it.time || '--:--' }}</span>
                            </div>
                            <div class="font-bold text-[17px] text-gray-900 leading-snug">{{ it.title }}</div>
                            <div v-if="it.note" class="text-sm text-gray-500 mt-1">{{ it.note }}</div>
                        </div>
                        
                        <div class="action-btn-group flex-col !gap-0">
                            <button @click.stop="openItineraryModal(it)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                             <button @click.stop="removeItineraryItem(it.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </div>
              
                    <div v-if="(it.address || '').trim() !== ''" class="mt-2.5 flex items-center gap-1.5 text-xs text-gray-400 group-hover:text-[#007AFF] transition-colors">
                        <i class="ph ph-map-pin-line"></i>
                        <span class="font-medium">查看地圖</span>
                    </div>
                </div>
              </div>
            </div>

            <p v-if="sortedItinerary.length === 0" class="py-12 text-center text-gray-400 text-sm">
                <i class="ph ph-coffee text-3xl mb-2 block text-gray-300"></i>
                今日無行程，享受自由時光
            </p>
            
            <div class="mt-8 ios-card !bg-white/60 p-3"> 
               <div class="flex gap-2">
                   <input v-model="quickItinerary.time" type="time" class="ios-input !w-auto text-center !px-2 font-mono text-sm">
              <input v-model="quickItinerary.title" @keyup.enter="addQuickItinerary" class="ios-input shadow-sm" placeholder="快速新增行程 (如: 18:30 晚餐)">
              <button @click="addQuickItinerary" class="w-12 h-12 flex items-center justify-center bg-[#007AFF] text-white rounded-xl shadow-lg active:scale-95 transition flex-shrink-0">
                  <i class="ph ph-plus text-xl"></i>
              </button>
            </div>
          </div>
         </div>
         
         <div v-if="currentTab === '購物'">
            <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">購物清單</h3>
            <div class="flex gap-2 mb-4 ml-1">
              <button @click="shoppingFilter = 'all'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="shoppingFilter==='all' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">全部</button>
              <button @click="shoppingFilter = 'pending'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="shoppingFilter==='pending' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">未購買 ({{ pendingShoppingCount }})</button>
              <button @click="shoppingFilter = 'done'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="shoppingFilter==='done' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">已購買 ({{ doneShoppingCount }})</button>
            </div>
            <ul class="space-y-2.5">
               <li v-for="(item, i) in filteredShoppingList" :key="item.id" class="ios-list-item items-start">
                 <div class="flex items-start gap-3.5 flex-1 min-w-0">
                   <div class="relative cursor-pointer pt-0.5 flex-shrink-0" @click="toggleShoppingDone(item.id)">
                      <i class="ph text-2xl transition-colors" :class="item.isDone ? 'ph-check-circle-fill text-[#007AFF]' : 'ph-circle text-gray-300 hover:text-gray-400'"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between">
                          <span class="font-bold text-[17px] truncate" :class="{'task-done': item.isDone, 'text-gray-900': !item.isDone}">{{ item.name }}</span>
                          <span v-if="item.price" class="text-lg font-bold font-mono ml-4 text-[#FF3B30] flex-shrink-0" :class="{'task-done': item.isDone, 'text-gray-500': item.isDone}">
                            <span class="text-sm mr-0.5">{{ item.currency }}</span>{{ item.price }}
                          </span>
                      </div>
                      <div v-if="item.note" class="text-sm text-gray-500 mt-2 whitespace-pre-wrap leading-relaxed">{{ item.note }}</div>
                      <div v-if="item.imageURL" class="mt-4">
                        <div class="relative group/img cursor-pointer w-full h-40 overflow-hidden rounded-xl border border-gray-200 shadow-sm" @click="openImageViewer(item.imageURL)">
                          <img :src="item.imageURL" class="w-full h-full object-cover" alt="Thumbnail">
                        </div>
                      </div>
                  </div>
                </div>
                <div class="action-btn-group">
                   <button @click.stop="openShoppingModal(item)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                   <button class="icon-btn delete" @click="removeShoppingItem(item.id)"><i class="ph ph-trash text-lg"></i></button>
                </div>
               </li>
            </ul>
            <div v-if="shoppingList.length === 0" class="py-12 text-center">
                <i class="ph ph-bag text-4xl text-gray-300 mb-2"></i>
                <p class="text-sm text-gray-400">購物清單是空的</p>
            </div>
         </div>

         <div v-if="currentTab === '記帳'">
            <div class="ios-card-dark-glass p-6 mb-6">
               <div class="dark-glass-gradient"></div>
               <div class="absolute top-4 right-4 z-10">
                 <button @click="openExpenseModal(null)" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white p-2 rounded-full backdrop-blur-md transition">
                    <i class="ph ph-plus text-xl font-bold"></i>
                 </button>
               </div>
               <div class="relative z-10">
                  <div class="text-white/60 text-[11px] font-bold tracking-widest uppercase mb-1">總支出 (HKD)</div>
                  <div class="text-5xl font-light tracking-tight mb-2 text-white flex items-baseline">
                    <span class="text-2xl opacity-60 mr-1">$</span>{{ formatNumber(totalExpense.hkd, 0) }}
                  </div>
                  <div class="text-white/40 text-sm font-medium">≈ TWD {{ formatNumber(totalExpense.twd, 0) }}</div>
               </div>
               <div class="grid grid-cols-2 gap-4 mt-6 relative z-10">
                  <div class="bg-white/5 rounded-xl p-3 backdrop-blur-sm border border-white/5">
                     <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph ph-credit-card mr-1"></i>信用卡</div>
                     <div class="text-lg font-bold text-white">${{ formatNumber(totalExpense.creditHkd, 0) }}</div>
                  </div>
                  <div class="bg-white/5 rounded-xl p-3 backdrop-blur-sm border border-white/5">
                     <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph ph-wallet mr-1"></i>現金</div>
                     <div class="text-lg font-bold text-white">${{ formatNumber(totalExpense.cashHkd, 0) }}</div>
                  </div>
               </div>
            </div>
            
            <div class="flex gap-2 mb-4 ml-1">
              <button @click="expenseFilter = 'all'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="expenseFilter==='all' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">全部</button>
              <button @click="expenseFilter = 'credit'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="expenseFilter==='credit' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">信用卡</button>
              <button @click="expenseFilter = 'cash'" class="text-xs font-bold px-3 py-1.5 rounded-full transition-all" :class="expenseFilter==='cash' ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-500'">現金</button>
            </div>

            <ul class="space-y-2.5">
              <li v-for="(e, i) in filteredExpenses" :key="e.id" class="ios-list-item items-start">
                 <div class="flex items-start gap-3.5 flex-1 min-w-0">
                    <div class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0 text-lg text-gray-500">
                        <i v-if="e.category === '餐飲'" class="ph ph-pizza"></i>
                        <i v-else-if="e.category === '交通'" class="ph ph-train"></i>
                        <i v-else-if="e.category === '購物'" class="ph ph-bag"></i>
                        <i v-else-if="e.category === '住宿'" class="ph ph-house"></i>
                        <i v-else-if="e.category === '娛樂'" class="ph ph-ticket"></i>
                        <i v-else class="ph ph-money"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                       <div class="font-bold text-[17px] text-gray-900 truncate">{{ e.name }}</div>
                       <div class="text-sm text-gray-500 mt-0.5">
                          <span class="font-bold">{{ e.category }}</span> 
                          <span class="mx-1 text-gray-300">|</span> 
                          {{ e.paymentMethod === 'credit_card' ? '信用卡' : '現金' }} 
                          <span class="mx-1 text-gray-300">|</span> 
                          {{ e.date.substring(5).replace('-', '/') }}
                       </div>
                    </div>
                 </div>
                 <div class="text-right flex items-center gap-2">
                    <div class="text-lg font-bold font-mono text-[#FF3B30] flex-shrink-0 leading-none">
                       <span class="text-sm mr-0.5">{{ e.currency }}</span>{{ formatNumber(e.amount, 0) }}
                    </div>
                    <div class="action-btn-group !opacity-100 flex-col !gap-0">
                       <button @click.stop="openExpenseModal(e)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                       <button class="icon-btn delete" @click.stop="removeExpense(e.id)"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                 </div>
              </li>
            </ul>
            <div v-if="expenses.length === 0" class="py-12 text-center">
               <i class="ph ph-calculator text-4xl text-gray-300 mb-2"></i>
               <p class="text-sm text-gray-400">目前沒有消費紀錄</p>
            </div>
         </div>
         
         <div v-if="currentTab === '備忘'">
            <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">重要資訊</h3>
            <ul class="space-y-2.5">
              <li v-for="(it, i) in infoList" :key="it.id" class="ios-list-item items-start">
                 <div class="flex items-start gap-3.5 flex-1 min-w-0">
                    <div class="mt-1 cursor-pointer" @click="it.isDone = !it.isDone">
                       <i class="ph text-2xl" :class="it.isDone ? 'ph-check-circle-fill text-green-500' : 'ph-info text-[#007AFF]'"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                       <div class="font-bold text-[17px] text-gray-900 truncate">{{ it.title }}</div>
                       <div class="text-sm text-gray-500 mt-2 whitespace-pre-wrap leading-relaxed">{{ it.note }}</div>
                       <div v-if="it.imageURL" class="mt-4">
                         <div class="relative group/img cursor-pointer w-full h-40 overflow-hidden rounded-xl border border-gray-200 shadow-sm" @click="openImageViewer(it.imageURL)">
                           <img :src="it.imageURL" class="w-full h-full object-cover" alt="Thumbnail">
                         </div>
                       </div>
                    </div>
                 </div>
                 <div class="action-btn-group">
                    <button @click.stop="openInfoModal(it)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                    <button class="icon-btn delete" @click="removeInfo(it.id)"><i class="ph ph-trash text-lg"></i></button>
                 </div>
              </li>
            </ul>
            <div v-if="infoList.length === 0" class="py-12 text-center text-gray-400 text-sm">
                請新增重要的資訊備忘
            </div>
         </div>

      </div>

      <div class="flex flex-col items-center justify-end pb-4 h-32 opacity-30 select-none pointer-events-none">
          <div class="text-[10px] font-bold uppercase tracking-widest">Travel Sync System</div>
          <div class="text-[9px] font-mono mt-0.5">Build {{ appVersion }}</div>
      </div>
    </main>

    <nav class="fixed bottom-6 left-0 right-0 z-30 px-4 pointer-events-none">
      <div class="iphone-dock w-full max-w-[360px] mx-auto pointer-events-auto transition-transform hover:scale-[1.01] duration-300">
        <button @click="currentTab='行程'" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400 hover:text-gray-500" :class="{'!text-[#007AFF]': currentTab==='行程'}">
          <i class="ph ph-map-pin text-[28px] mb-1 transition-transform group-active:scale-90" :class="currentTab==='行程' ? 'fill-current' : ''"></i>
          <span class="text-[10px] font-semibold tracking-wide">行程</span>
        </button>
        <button @click="currentTab='記帳'" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400 hover:text-gray-500" :class="{'!text-[#007AFF]': currentTab==='記帳'}">
          <i class="ph ph-currency-circle-dollar text-[28px] mb-1 transition-transform group-active:scale-90" :class="currentTab==='記帳' ? 'fill-current' : ''"></i>
          <span class="text-[10px] font-semibold tracking-wide">記帳</span>
        </button>
        <button @click="currentTab='購物'" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400 hover:text-gray-500" :class="{'!text-[#007AFF]': currentTab==='購物'}">
          <i class="ph ph-bag-simple text-[28px] mb-1 transition-transform group-active:scale-90" :class="currentTab==='購物' ? 'fill-current' : ''"></i>
          <span class="text-[10px] font-semibold tracking-wide">購物</span>
        </button>
        <button @click="currentTab='備忘'" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400 hover:text-gray-500" :class="{'!text-[#007AFF]': currentTab==='備忘'}">
          <i class="ph ph-info text-[28px] mb-1 transition-transform group-active:scale-90" :class="currentTab==='備忘' ? 'fill-current' : ''"></i>
          <span class="text-[10px] font-semibold tracking-wide">備忘</span>
        </button>
        <button @click="currentTab='準備'" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400 hover:text-gray-500" :class="{'!text-[#007AFF]': currentTab==='準備'}">
          <i class="ph ph-list-checks text-[28px] mb-1 transition-transform group-active:scale-90" :class="currentTab==='準備' ? 'fill-current' : ''"></i>
          <span class="text-[10px] font-semibold tracking-wide">準備</span>
        </button>
      </div>
    </nav>
    
    <div>
      
      <transition name="fade">
        <div v-if="itineraryModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeItineraryModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newItineraryItem.id ? '編輯行程' : '新增行程' }}</div>
            <div class="ios-modal-body space-y-4">
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">標題</label>
                <input v-model="newItineraryItem.title" class="ios-input" placeholder="如: 晚餐、景點名稱">
              </div>
              <div class="flex gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">時間</label>
                  <input v-model="newItineraryItem.time" type="time" class="ios-input w-full">
                </div>
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">日期</label>
                  <select v-model.number="newItineraryItem.dayIndex" class="ios-input appearance-none w-full">
                    <option v-for="(d, i) in days" :key="i" :value="i">Day {{ i + 1 }} ({{ d.date }})</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">地址 / 地點</label>
                <input v-model="newItineraryItem.address" class="ios-input" placeholder="Google Map 可搜尋的地址或名稱">
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">備註</label>
                <textarea v-model="newItineraryItem.note" class="ios-input h-20 resize-none" placeholder="詳細資訊"></textarea>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeItineraryModal" class="btn-ios-cancel">取消</button>
              <button @click="saveItineraryItem" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="shoppingModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeShoppingModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newShoppingItem.id ? '編輯購物項目' : '新增購物項目' }}</div>
            <div class="ios-modal-body space-y-4">
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">名稱</label>
                <input v-model="newShoppingItem.name" class="ios-input" placeholder="如: 鳳梨酥 (佳德)">
              </div>
              <div class="flex gap-3">
                 <div class="flex-1 min-w-0">
                    <label class="text-xs text-gray-400 ml-1 font-bold">價格</label>
                    <input v-model.number="newShoppingItem.price" type="number" class="ios-input w-full" placeholder="價格 (可選)">
                 </div>
                 <div class="flex-1 min-w-0">
                    <label class="text-xs text-gray-400 ml-1 font-bold">幣別</label>
                    <select v-model="newShoppingItem.currency" class="ios-input appearance-none w-full">
                       <option value="TWD">TWD (台幣)</option>
                       <option value="HKD">HKD (港幣)</option>
                       <option value="JPY">JPY (日元)</option>
                    </select>
                 </div>
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">備註</label>
                <textarea v-model="newShoppingItem.note" class="ios-input h-16 resize-none" placeholder="哪裏買/給誰的"></textarea>
              </div>
              <div class="p-4 bg-gray-100/50 rounded-xl flex flex-col items-center justify-center">
                 <label class="w-full text-center p-3 cursor-pointer">
                   <div class="text-center" v-if="!tempUploadPreview.shopping && !newShoppingItem.imageURL">
                      <i class="ph ph-image text-3xl text-gray-300 mb-2"></i>
                      <div class="text-[#007AFF] text-sm font-medium">上傳圖片</div>
                   </div>
                   <div v-else class="text-center text-[#007AFF] font-bold text-sm">
                      {{ uploadStatus.shopping || '圖片已選取 (點擊更換)' }}
                   </div>
                   <input type="file" accept="image/*" class="hidden" @change="(e) => handleFileUpload(e, 'shopping')">
                 </label>
                 <input v-model="newShoppingItem.imageURL" class="w-full mt-3 p-2 text-xs text-gray-400 bg-transparent text-center border-none focus:outline-none" placeholder="或是貼上圖片網址">
                 <div v-if="tempUploadPreview.shopping || newShoppingItem.imageURL" class="mt-4 flex justify-center">
                    <img :src="tempUploadPreview.shopping || newShoppingItem.imageURL" class="h-24 w-24 object-cover rounded-2xl shadow-sm border border-gray-100">
                 </div>
              </div>
              <div class="flex items-center gap-3 p-3 bg-gray-100 rounded-xl">
                <input type="checkbox" id="shopping-done" v-model="newShoppingItem.isDone" class="w-5 h-5 text-[#007AFF] rounded focus:ring-[#007AFF]">
                <label for="shopping-done" class="text-gray-900 font-medium select-none flex-1">已購買</label>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeShoppingModal" class="btn-ios-cancel">取消</button>
              <button @click="saveShoppingItem" class="btn-ios-primary" :disabled="isUploading">
                {{ isUploading ? '上傳中...' : '儲存' }}
              </button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="expenseModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeExpenseModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newExpense.id ? '編輯消費' : '新增消費' }}</div>
            <div class="ios-modal-body space-y-4">
               <div>
                 <label class="text-xs text-gray-400 ml-1 font-bold">項目名稱</label>
                 <input v-model="newExpense.name" class="ios-input" placeholder="如: 鼎泰豐午餐">
               </div>
               <div class="flex gap-3">
                 <div class="flex-1 min-w-0">
                    <label class="text-xs text-gray-400 ml-1 font-bold">金額</label>
                    <input v-model.number="newExpense.amount" type="number" class="ios-input w-full text-lg font-mono font-bold" placeholder="0">
                 </div>
                 <div class="flex-1 min-w-0">
                    <label class="text-xs text-gray-400 ml-1 font-bold">幣別</label>
                    <select v-model="newExpense.currency" class="ios-input appearance-none w-full">
                       <option value="TWD">TWD (台幣)</option>
                       <option value="HKD">HKD (港幣)</option>
                       <option value="JPY">JPY (日元)</option>
                    </select>
                 </div>
               </div>
               <div>
                  <label class="text-xs text-gray-400 ml-1 font-bold">分類</label>
                  <select v-model="newExpense.category" class="ios-input appearance-none w-full">
                       <option value="餐飲">餐飲</option>
                       <option value="交通">交通</option>
                       <option value="購物">購物</option>
                       <option value="住宿">住宿</option>
                       <option value="娛樂">娛樂</option>
                       <option value="其他">其他</option>
                  </select>
               </div>
               <div class="flex gap-3">
                   <div class="flex-1 min-w-0">
                       <label class="text-xs text-gray-400 ml-1 font-bold">支付方式</label>
                       <select v-model="newExpense.paymentMethod" class="ios-input appearance-none w-full">
                           <option value="cash">現金</option>
                           <option value="credit_card">信用卡</option>
                       </select>
                   </div>
                   <div class="flex-1 min-w-0">
                      <label class="text-xs text-gray-400 ml-1 font-bold">日期</label>
                      <input v-model="newExpense.date" type="date" class="ios-input w-full">
                   </div>
               </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeExpenseModal" class="btn-ios-cancel">取消</button>
              <button @click="saveExpense" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>
      
      <transition name="fade">
        <div v-if="infoModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeInfoModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newInfoItem.id ? '編輯備忘' : '新增備忘' }}</div>
            <div class="ios-modal-body space-y-4">
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">標題</label>
                <input v-model="newInfoItem.title" class="ios-input" placeholder="如: 護照號碼、飯店訂單">
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">內容</label>
                <textarea v-model="newInfoItem.note" class="ios-input h-20 resize-none" placeholder="重要資訊 (可換行)"></textarea>
              </div>
              <div class="p-4 bg-gray-100/50 rounded-xl flex flex-col items-center justify-center">
                 <label class="w-full text-center p-3 cursor-pointer">
                   <div class="text-center" v-if="!tempUploadPreview.info && !newInfoItem.imageURL">
                      <i class="ph ph-file-image text-2xl text-gray-300 mb-1"></i>
                      <div class="text-[#007AFF] text-xs font-medium">上傳 / 貼上網址</div>
                   </div>
                   <div v-else class="text-center text-[#007AFF] font-bold text-xs">
                      {{ uploadStatus.info || '檔案已就緒' }}
                   </div>
                   <input type="file" accept="image/*" class="hidden" @change="(e) => handleFileUpload(e, 'info')">
                 </label>
                 <input v-model="newInfoItem.imageURL" class="w-full mt-2 p-2 bg-transparent text-xs text-gray-400 text-center border-none focus:outline-none" placeholder="或在此貼上網址">
                 <div v-if="tempUploadPreview.info || newInfoItem.imageURL" class="mt-3 flex justify-center">
                    <img :src="tempUploadPreview.info || newInfoItem.imageURL" class="h-20 w-20 object-cover rounded-xl shadow-sm border border-gray-200">
                 </div>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeInfoModal" class="btn-ios-cancel">取消</button>
              <button @click="saveInfoItem" class="btn-ios-primary" :disabled="isUploading">
                {{ isUploading ? '上傳中...' : '儲存' }}
              </button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="preNoteModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closePreNoteModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">編輯準備項目</div>
            <div class="ios-modal-body space-y-4">
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">項目名稱</label>
                <input v-model="editingPreNote.name" class="ios-input" placeholder="如: 兌換台幣">
              </div>
              <div class="flex items-center gap-3 p-3 bg-gray-100 rounded-xl">
                <input type="checkbox" id="prenote-done" v-model="editingPreNote.isDone" class="w-5 h-5 text-[#007AFF] rounded focus:ring-[#007AFF]">
                <label for="prenote-done" class="text-gray-900 font-medium select-none flex-1">已完成</label>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closePreNoteModal" class="btn-ios-cancel">取消</button>
              <button @click="savePreNoteEdit" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>
      
      <transition name="fade">
        <div v-if="flightModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeFlightModal">
          <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newFlight.id ? '編輯航班' : '新增航班' }}</div>
            <div class="ios-modal-body space-y-4">
              <div class="p-1 bg-gray-200/50 rounded-xl flex">
                <button class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all" :class="newFlight.type==='outbound' ? 'bg-white shadow text-black' : 'text-gray-400'" @click="newFlight.type='outbound'">去程</button>
                <button class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all" :class="newFlight.type==='return' ? 'bg-white shadow text-black' : 'text-gray-400'" @click="newFlight.type='return'">回程</button>
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">航班代碼</label>
                <input v-model="newFlight.code" class="ios-input" placeholder="如: CX400">
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">狀態 (顯示於卡片)</label>
                <select v-model="newFlight.status" class="ios-input appearance-none">
                   <option value="On Time">On Time (準時)</option>
                   <option value="Boarding">Boarding (登機中)</option>
                   <option value="Delayed">Delayed (延誤)</option>
                   <option value="Landed">Landed (已抵達)</option>
                   <option value="Scheduled">Scheduled (已排程)</option>
                </select>
              </div>
              <div class="flex gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">出發地</label>
                  <input v-model="newFlight.fromCode" class="ios-input text-center uppercase w-full" placeholder="HKG">
                </div>
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">目的地</label>
                  <input v-model="newFlight.toCode" class="ios-input text-center uppercase w-full" placeholder="TPE">
                </div>
              </div>
              <div class="flex gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">起飛</label>
                  <input v-model="newFlight.depTime" type="time" class="ios-input w-full">
                </div>
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">抵達</label>
                  <input v-model="newFlight.arrTime" type="time" class="ios-input w-full">
                </div>
              </div>
              <div class="flex gap-3">
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">航廈 (T1/T2)</label>
                  <input v-model="newFlight.fromTerminal" class="ios-input w-full text-center uppercase" placeholder="T1">
                </div>
                <div class="flex-1 min-w-0">
                  <label class="text-xs text-gray-400 ml-1 font-bold">登機閘口</label> <input v-model="newFlight.gate" class="ios-input w-full text-center uppercase" placeholder="24">
                </div>
              </div>
              <div>
                 <label class="text-xs text-gray-400 ml-1 font-bold">Live Activity 連結 (Flighty)</label>
                 <input v-model="newFlight.liveLink" class="ios-input" placeholder="https://live.flighty.app/...">
              </div>
              <div>
                <label class="text-xs text-gray-400 ml-1 font-bold">備註</label>
                <textarea v-model="newFlight.note" class="ios-input h-16 resize-none" placeholder="如: Economy / Premium"></textarea>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeFlightModal" class="btn-ios-cancel">取消</button>
              <button @click="saveFlight" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="imageViewer.open" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center" @click="imageViewer.open = false">
          <img :src="imageViewer.url" class="max-w-[90%] max-h-[90%] object-contain" alt="Full image">
          <button class="absolute top-8 right-8 text-white p-3 rounded-full bg-white/10 backdrop-blur-md" @click.stop="imageViewer.open = false">
             <i class="ph ph-x text-2xl"></i>
          </button>
        </div>
      </transition>
      
    </div>

  </div>
  
  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    // --- Constants & Config ---
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi';
    const TRIP_ID = 'taipei_trip2025';
    const DEFAULT_RATE = 0.25;
    const CURRENCY_RATES = {
      'HKD': 1, // Base
      'JPY': 0.05,
      'TWD': 0.25 // Default TWD rate
    };

    // --- State Management ---
    const appVersion = ref('3.17'); // 版本序號更新: v3.16 -> v3.17
    const syncState = ref('loading'); // 'loading', 'saving', 'synced', 'error'
    let debounce = null;
    let isRemoteUpdate = false;

    const currentTab = ref('行程');
    const selectedDay = ref(0); // 0 is Day 1
    const days = ref([
      { date: '15', week: '一', type: 'flight-outbound' },
      { date: '16', week: '二', type: 'normal' },
      { date: '17', week: '三', type: 'normal' },
      { date: '18', week: '四', type: 'flight-return' },
    ]);
    
    // Updated Flights Data Structure for Live Tracking
    const flights = ref([
      { id: 'outbound', type: 'outbound', date: '2025-12-15', code: 'CX400', depTime: '12:45', arrTime: '14:45', fromCode: 'HKG', fromTerminal: 'T1', toCode: 'TPE', toTerminal: 'T2', title: 'Cathay Pacific', note: 'Economy', isConfirmed: true, status: 'On Time', gate: '24', liveLink: 'https://live.flighty.app/2af42e286-3d91-4f25-91b8-d22148de4e6a' },
      { id: 'return', type: 'return', date: '2025-12-18', code: 'CX443', depTime: '17:00', arrTime: '18:55', fromCode: 'TPE', fromTerminal: 'T2', toCode: 'HKG', toTerminal: 'T1', title: 'Cathay Pacific', note: 'Economy', isConfirmed: false, status: 'Scheduled', gate: '--', liveLink: 'https://live.flighty.app/29fab3b3b-3e56-439f-8292-853a0a6f1bf3' }, // 回程 Live Link 更新
    ]);

    // Dummy itinerary structure: itinerary[dayIndex] = [{item}, {item}]
    const itinerary = reactive([
      [
        { id:1, title: '航班抵達', time:'14:45', note:'第二航廈', address:'', dayIndex: 0 },
        { id:2, title: '登記入住', time:'16:30', note:'西門町', address:'Westgate Hotel', dayIndex: 0 }
      ], 
      [], [], []
    ]);
    const rate = ref(DEFAULT_RATE);
    const lastRateUpdate = ref(new Date().toISOString());
    const weather = ref({
      temp: 23, desc: '晴時多雲', icon: 'sun-clouds', rain: 10, feelsLike: 25, max: 27, min: 21, humidity: 70, wind: '12km/h', uv: 9, warning: null
    });

    const selectedMapLocation = ref(null);

    const shoppingList = ref([]);
    const shoppingFilter = ref('all');
    const shoppingModalOpen = ref(false);
    const newShoppingItem = reactive({});

    const expenses = ref([]);
    const expenseModalOpen = ref(false);
    const expenseFilter = ref('all');
    const newExpense = reactive({});

    const infoList = ref([]);
    const infoModalOpen = ref(false);
    const newInfoItem = reactive({});
    
    const preTripNotes = ref([]);
    const newPreNote = ref('');
    const preNoteModalOpen = ref(false);
    const editingPreNote = reactive({});

    const itineraryModalOpen = ref(false);
    const newItineraryItem = reactive({});
    const quickItinerary = reactive({ title: '', time: '' });

    const flightModalOpen = ref(false);
    const newFlight = reactive({});

    const uploadStatus = reactive({ shopping: null, info: null });
    const tempUploadPreview = reactive({ shopping: null, info: null });
    const isUploading = ref(false);
    const imageViewer = reactive({ open: false, url: '' });

    // --- Computed Properties ---

    const syncStatusText = computed(() => {
      if (syncState.value === 'loading') return '同步中...';
      if (syncState.value === 'saving') return '儲存中...';
      if (syncState.value === 'error') return '錯誤';
      return '已同步';
    });
    
    const isFlightDay = computed(() => {
      const day = days.value[selectedDay.value];
      return day && (day.type === 'flight-outbound' || day.type === 'flight-return');
    });

    const activeFlight = computed(() => {
      if (!isFlightDay.value) return null;
      const day = days.value[selectedDay.value];
      return flights.value.find(f => f.type === day.type) || {};
    });

    const shouldShowFlightCard = computed(() => {
      return isFlightDay.value && (activeFlight.value.code || activeFlight.value.id);
    });

    const sortedItinerary = computed(() => {
      return [...itinerary[selectedDay.value]].sort((a, b) => {
        if (!a.time) return 1;
        if (!b.time) return -1;
        return a.time.localeCompare(b.time);
      });
    });

    const filteredShoppingList = computed(() => {
      let list = shoppingList.value;
      if (shoppingFilter.value === 'pending') list = list.filter(item => !item.isDone);
      else if (shoppingFilter.value === 'done') list = list.filter(item => item.isDone);
      return [...list].sort((a, b) => b.id - a.id);
    });

    const pendingShoppingCount = computed(() => shoppingList.value.filter(item => !item.isDone).length);
    const doneShoppingCount = computed(() => shoppingList.value.filter(item => item.isDone).length);

    const totalExpense = computed(() => {
      const rateVal = 1 / (Number(rate.value) || 4); // Convert back for logic
      let total = 0, credit = 0, cash = 0;
      expenses.value.forEach(e => {
        let amount = Number(e.amount) || 0;
        if (e.currency === 'TWD') amount *= rateVal;
        else if (CURRENCY_RATES[e.currency]) amount *= CURRENCY_RATES[e.currency];
        total += amount;
        if(e.paymentMethod === 'credit_card') credit += amount;
        else cash += amount;
      });
      return { hkd: total, twd: total / rateVal, creditHkd: credit, creditTwd: credit / rateVal, cashHkd: cash, cashTwd: cash / rateVal };
    });

    const filteredExpenses = computed(() => {
      let list = expenses.value;
      if (expenseFilter.value === 'credit') list = list.filter(e => e.paymentMethod === 'credit_card');
      else if (expenseFilter.value === 'cash') list = list.filter(e => e.paymentMethod !== 'credit_card');
      return [...list].sort((a, b) => b.id - a.id);
    });

    // --- Weather Logic ---

    const weatherIconClass = computed(() => {
      const iconMap = {
        'sun-clouds': 'ph-sun-cloud',
        'rain': 'ph-cloud-rain',
        'thunderstorm': 'ph-cloud-lightning',
        'clear': 'ph-sun',
        'cloudy': 'ph-cloud'
      };
      return `ph ${iconMap[weather.value.icon] || 'ph-cloud'} text-gray-800/80 drop-shadow-sm`;
    });

    // --- Rate/Time Formatting ---

    const formattedRate = computed(() => (rate.value || DEFAULT_RATE).toFixed(4));
    
    const lastRateUpdateLabel = computed(() => {
        const d = new Date(lastRateUpdate.value);
        return d.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', hour12: false });
    });

    // --- Utility Functions ---

    function generateId() { return Date.now() + Math.floor(Math.random() * 1000); }

    function getStatusClass(status) {
      if (!status) return 'bg-gray-500/20 text-white opacity-70 border-gray-400/20';
      const s = status.toLowerCase().replace(' ', '');
      if (s.includes('on') || s.includes('landed')) return 'status-ontime';
      if (s.includes('delay')) return 'status-delayed';
      if (s.includes('board')) return 'status-boarding';
      return 'bg-gray-500/20 text-white opacity-70 border-gray-400/20';
    }

    function selectDay(index) { selectedDay.value = index; }

    function showLocationOnMap(item) {
      selectedMapLocation.value = (item.address && item.address.trim() !== '') ? { title: item.title, address: item.address, id: item.id } : null;
    }

    function generateMapLink(address, type) {
      if (!address) return '#';
      const q = encodeURIComponent(address);
      if (type === 'search') {
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
      } else {
        return `https://www.google.com/maps/dir/?api=1&destination=${q}&travelmode=walking`;
      }
    }

    function formatNumber(num, decimalPlaces = 2) {
      if (typeof num !== 'number') return '0';
      return num.toFixed(decimalPlaces).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function openImageViewer(url) {
        imageViewer.url = url;
        imageViewer.open = true;
    }

    // --- Data Persistence (Supabase Simulation) ---

    const supabaseClient = {
      from: () => ({
        upsert: async () => ({ error: null }),
        select: () => ({ eq: () => ({ single: async () => ({ data: null }) }) })
      })
    };

    function getPayload() {
      return {
        itinerary: JSON.parse(JSON.stringify(itinerary)),
        rate: rate.value,
        weather: JSON.parse(JSON.stringify(weather.value)),
        shoppingList: JSON.parse(JSON.stringify(shoppingList.value)),
        expenses: JSON.parse(JSON.stringify(expenses.value)),
        infoList: JSON.parse(JSON.stringify(infoList.value)),
        preTripNotes: JSON.parse(JSON.stringify(preTripNotes.value)),
        flights: JSON.parse(JSON.stringify(flights.value)),
      };
    }

    function initializeListWithIds(list) {
      return list.map(item => ({ ...item, id: item.id || generateId() }));
    }

    function applyData(d) {
      isRemoteUpdate = true;
      rate.value = d.rate || DEFAULT_RATE;
      weather.value = d.weather || weather.value;
      shoppingList.value = initializeListWithIds(d.shoppingList);
      expenses.value = initializeListWithIds(d.expenses);
      infoList.value = initializeListWithIds(d.infoList);
      preTripNotes.value = initializeListWithIds(d.preTripNotes);
      // Flights are treated as a single list for simplicity
      flights.value = initializeListWithIds(d.flights);
      setTimeout(() => isRemoteUpdate = false, 500);
    }

    async function saveAll() {
      if(isRemoteUpdate) return;
      syncState.value = 'saving';
      if(debounce) clearTimeout(debounce);
      debounce = setTimeout(async () => {
        try {
          // console.log('Saving data...');
          const { error } = await supabaseClient.from('trip_data').upsert({ id: TRIP_ID, content: getPayload() });
          if(error) throw error;
          syncState.value = 'synced';
          // console.log('Data synced.');
        } catch(e) {
          console.error(e);
          syncState.value = 'error';
        }
      }, 1500);
    }

    async function fetchCloud(auto = true) {
      if(syncState.value === 'saving' && auto) return;
      if(!auto) syncState.value = 'loading';
      try {
        const { data } = await supabaseClient.from('trip_data').select('content').eq('id', TRIP_ID).single();
        if(data?.content && JSON.stringify(data.content) !== JSON.stringify(getPayload())) {
          applyData(data.content);
        }
        syncState.value = 'synced';
      } catch(e) {
        if(!auto) syncState.value = 'error';
      }
    }

    async function forceReloadCloud() {
      await fetchCloud(false);
    }

    async function fetchRate() {
      try {
        // Source: open.er-api.com
        const res = await fetch('https://open.er-api.com/v6/latest/HKD');
        const data = await res.json();
        if (data.rates && data.rates.TWD) {
          rate.value = data.rates.TWD;
          lastRateUpdate.value = new Date().toISOString();
        }
      } catch (e) {
        console.error('Failed to fetch exchange rate:', e);
      }
    }
    
    // --- Generic CRUD Helpers ---
    function openGenericModal(modalRef, dataRef, defaultData, item) {
        Object.assign(dataRef, item ? JSON.parse(JSON.stringify(item)) : defaultData);
        if(!item) dataRef.id = null;
        modalRef.value = true;
    }
    function saveToList(list, item) {
      if(!item.id) {
        list.value.unshift({ ...item, id: generateId() });
      } else {
        const idx = list.value.findIndex(i => i.id === item.id);
        if(idx !== -1) list.value.splice(idx, 1, JSON.parse(JSON.stringify(item)));
      }
      saveAll();
    }
    function removeFromList(list, id) {
      if(confirm('確定刪除？')) {
        const idx = list.value.findIndex(i => i.id === id);
        if(idx !== -1) list.value.splice(idx, 1);
        saveAll();
      }
    }
    
    // --- Shopping List Functions ---
    function openShoppingModal(item) {
      const def = { id: null, name:'', price:null, currency:'TWD', note:'', imageURL:'', isDone:false };
      openGenericModal(shoppingModalOpen, newShoppingItem, def, item);
      tempUploadPreview.shopping = null;
      uploadStatus.shopping = null;
    }
    function closeShoppingModal() { shoppingModalOpen.value = false; }
    function saveShoppingItem() { if(!newShoppingItem.name) return; saveToList(shoppingList, newShoppingItem); closeShoppingModal(); }
    function removeShoppingItem(id) { removeFromList(shoppingList, id); }
    function toggleShoppingDone(id) {
      const item = shoppingList.value.find(i => i.id === id);
      if(item) item.isDone = !item.isDone;
      saveAll();
    }

    // --- Info/Memo Functions ---
    function openInfoModal(item) {
      const def = { id: null, title: '', note: '', imageURL: '', isDone: false };
      openGenericModal(infoModalOpen, newInfoItem, def, item);
      tempUploadPreview.info = null;
      uploadStatus.info = null;
    }
    function closeInfoModal() { infoModalOpen.value = false; }
    function saveInfoItem() { if(!newInfoItem.title) return; saveToList(infoList, newInfoItem); closeInfoModal(); }
    function removeInfo(id) { removeFromList(infoList, id); }

    // --- Pre-Trip Notes Functions ---
    function addPreNote() {
      if (!newPreNote.value.trim()) return;
      preTripNotes.value.unshift({ id: generateId(), name: newPreNote.value.trim(), isDone: false });
      newPreNote.value = '';
      saveAll();
    }
    function removePreNote(id) { removeFromList(preTripNotes, id); }
    function togglePreNoteDone(id) {
      const note = preTripNotes.value.find(n => n.id === id);
      if(note) note.isDone = !note.isDone;
      saveAll();
    }
    function editPreNote(n) { openGenericModal(preNoteModalOpen, editingPreNote, {}, n); }
    function closePreNoteModal() { preNoteModalOpen.value = false; }
    function savePreNoteEdit() { saveToList(preTripNotes, editingPreNote); closePreNoteModal(); }

    // --- Expense Functions ---
    function openExpenseModal(item) {
      const def = { id: null, name:'', amount:null, currency:'TWD', category:'餐飲', paymentMethod:'cash', date: new Date().toISOString().split('T')[0] };
      openGenericModal(expenseModalOpen, newExpense, def, item);
    }
    function closeExpenseModal() { expenseModalOpen.value = false; }
    function saveExpense() {
      if(!newExpense.name || !newExpense.amount) return;
      const item = { ...newExpense, id: newExpense.id || generateId() };
      if (newExpense.id) {
        const idx = expenses.value.findIndex(e => e.id === newExpense.id);
        if(idx !== -1) expenses.value.splice(idx, 1, item);
      } else { expenses.value.unshift(item); }
      closeExpenseModal(); saveAll();
    }
    function removeExpense(id) { removeFromList(expenses, id); }

    // --- Flight Functions ---
    function openFlightModal(id) {
      const def = { id: null, type: 'outbound', date: '2025-12-15', code: '', depTime:'', arrTime:'', fromCode:'HKG', toCode:'TPE', status: 'Scheduled', gate: '--', fromTerminal: 'T1', toTerminal: 'T2', title: '', note: '', liveLink: '' };
      if(id === 'new') {
        def.type = days.value[selectedDay.value]?.type === 'flight-return' ? 'return' : 'outbound';
        if(def.type === 'return') { def.fromCode='TPE'; def.toCode='HKG'; def.date='2025-12-18'; def.fromTerminal = 'T2'; def.toTerminal = 'T1'; }
        Object.assign(newFlight, def);
      } else {
        const f = flights.value.find(x => x.id === id) || flights.value.find(x => x.type === id);
        if(f) { Object.assign(newFlight, JSON.parse(JSON.stringify(f))); } else { Object.assign(newFlight, def); }
      }
      flightModalOpen.value = true;
    }
    function closeFlightModal() { flightModalOpen.value = false; }
    function saveFlight() {
      if(!newFlight.code) return;
      const item = { ...newFlight, id: newFlight.id || newFlight.type };
      const idx = flights.value.findIndex(f => f.id === item.id);
      if(idx !== -1) {
        flights.value.splice(idx, 1, item);
      } else {
        flights.value.push(item);
      }
      closeFlightModal(); saveAll();
    }

    // --- Itinerary Functions ---
    function openItineraryModal(item = null) {
      let targetDayIndex = selectedDay.value;
      if (item && item.dayIndex !== undefined) { targetDayIndex = item.dayIndex; }
      const defaultData = { id: null, title: '', time: '', note: '', address: '', dayIndex: targetDayIndex };
      openGenericModal(itineraryModalOpen, newItineraryItem, defaultData, item);
      newItineraryItem.dayIndex = targetDayIndex;
      if (item) newItineraryItem.originalDayIndex = targetDayIndex;
      itineraryModalOpen.value = true;
    }

    function closeItineraryModal() { itineraryModalOpen.value = false; }
    
    function saveItineraryItem() {
      if (!newItineraryItem.title.trim()) return;
      const item = { ...newItineraryItem, id: newItineraryItem.id || generateId() };
      const target = itinerary[item.dayIndex];
      if (item.id && item.originalDayIndex !== undefined && item.originalDayIndex !== item.dayIndex) {
        const oldList = itinerary[item.originalDayIndex];
        const idx = oldList.findIndex(i => i.id === item.id);
        if (idx !== -1) oldList.splice(idx, 1);
        target.push(item);
      } else if (item.id) {
        const idx = target.findIndex(i => i.id === item.id);
        if(idx !== -1) target.splice(idx, 1, item);
        else target.push(item);
      } else { target.push(item); }
      if (selectedMapLocation.value?.id === item.id) showLocationOnMap(item);
      closeItineraryModal(); saveAll();
    }

    function removeItineraryItem(id) {
      if(confirm('確定刪除？')) {
        const idx = itinerary[selectedDay.value].findIndex(i => i.id === id);
        if(idx !== -1) itinerary[selectedDay.value].splice(idx, 1);
        saveAll();
      }
    }

    function addQuickItinerary(){
      if(!quickItinerary.title) return;
      itinerary[selectedDay.value].push({ 
        id: generateId(), 
        title: quickItinerary.title, 
        time: quickItinerary.time || '', 
        note: '', 
        address: '', 
        dayIndex: selectedDay.value 
      });
      quickItinerary.title = ''; 
      quickItinerary.time = ''; 
      saveAll(); 
    }

    // --- Combined Add Button ---
    function openAddModal() {
      if (currentTab.value === '行程') openItineraryModal();
      else if (currentTab.value === '購物') openShoppingModal();
      else if (currentTab.value === '記帳') openExpenseModal();
      else if (currentTab.value === '備忘') openInfoModal();
    }

    // --- File Upload Simulation ---

    async function handleFileUpload(event, type) {
      const file = event.target.files[0];
      if (!file) return;

      if(type === 'shopping') {
        uploadStatus.shopping = '上傳中...';
        tempUploadPreview.shopping = URL.createObjectURL(file);
      } else if(type === 'info') {
        uploadStatus.info = '上傳中...';
        tempUploadPreview.info = URL.createObjectURL(file);
      }

      isUploading.value = true;

      // Simulate file upload delay and return a dummy URL
      await new Promise(resolve => setTimeout(resolve, 1500));
      const dummyURL = 'https://picsum.photos/400/400?random=' + generateId(); // Use a new random image

      if(type === 'shopping') {
        newShoppingItem.imageURL = dummyURL;
        uploadStatus.shopping = '上傳完成';
        tempUploadPreview.shopping = null; // Clear preview
      } else if(type === 'info') {
        newInfoItem.imageURL = dummyURL;
        uploadStatus.info = '上傳完成';
        tempUploadPreview.info = null; // Clear preview
      }

      isUploading.value = false;
      event.target.value = null; // Reset file input
    }
    
    // --- Lifecycle ---
    
    onMounted(() => {
        fetchCloud();
        fetchRate();
        setInterval(fetchRate, 600000); // Fetch rate every 10 minutes
    });

    watch([itinerary, preTripNotes, shoppingList, expenses, infoList, flights], () => saveAll(), { deep: true });

    return {
       appVersion, syncState, syncStatusText, forceReloadCloud,
       currentTab, days, selectDay, selectedDay, isFlightDay,
       weather, weatherIconClass, formattedRate, lastRateUpdateLabel,
       activeFlight, shouldShowFlightCard, getStatusClass,
       selectedMapLocation, showLocationOnMap, generateMapLink,
       
       preTripNotes, newPreNote, addPreNote, removePreNote, editPreNote, togglePreNoteDone, preNoteModalOpen, editingPreNote, closePreNoteModal, savePreNoteEdit,
       
       sortedItinerary, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem, itineraryModalOpen, newItineraryItem, quickItinerary, addQuickItinerary,
       
       shoppingList, filteredShoppingList, pendingShoppingCount, doneShoppingCount, shoppingFilter, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, toggleShoppingDone, shoppingModalOpen, newShoppingItem, 
       
       expenses, totalExpense, filteredExpenses, expenseFilter, openExpenseModal, closeExpenseModal, saveExpense, removeExpense, expenseModalOpen, newExpense,
       
       infoList, openInfoModal, closeInfoModal, saveInfoItem, removeInfo, infoModalOpen, newInfoItem,
       
       openAddModal, flightModalOpen, newFlight, openFlightModal, closeFlightModal, saveFlight,
       
       handleFileUpload, uploadStatus, tempUploadPreview, isUploading,
       imageViewer, openImageViewer, formatNumber
    };
  }
}).mount('#app');
  </script>
</body>
</html>
