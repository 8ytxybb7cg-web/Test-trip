<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v4.00</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html { height: 100%; overscroll-behavior-y: none; }
    body {
      height: 100%; font-family: var(--font-stack); -webkit-font-smoothing: antialiased;
      background-color: #000; margin: 0; color: #000; overflow: hidden;
    }

    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: 20px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    
    .ios-card {
      background: var(--ios-card-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border); border-radius: 22px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); overflow: hidden;
    }

    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 26px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white; position: relative; overflow: hidden;
    }
    
    .dark-glass-gradient {
        position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none; z-index: 0;
    }

    .ios-list-item {
      background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border-radius: 18px;
      margin-bottom: 10px; padding: 16px; display: flex; align-items: center; justify-content: space-between;
      transition: background 0.2s, transform 0.1s; border: 1px solid rgba(255,255,255,0.5);
    }

    .drag-handle {
      cursor: grab; padding: 10px; color: #8E8E93; display: flex; align-items: center;
    }

    .action-btn-group { display: flex; align-items: center; gap: 4px; flex-shrink: 0; opacity: 0.4; transition: opacity 0.2s; }
    .ios-list-item:hover .action-btn-group { opacity: 1; }
    .icon-btn { padding: 8px; color: #8E8E93; border-radius: 50%; transition: background 0.2s; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    .icon-btn.edit:hover { color: var(--ios-primary); }
    .icon-btn.delete:hover { color: var(--ios-danger); }

    .ios-input {
      background: rgba(118, 118, 128, 0.12); border: none; border-radius: 12px; padding: 12px 16px; font-size: 17px;
      color: #000; width: 100%; box-sizing: border-box;
    }

    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); }
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.9); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      border-radius: 32px; display: flex; flex-direction: column; max-height: 85vh; width: 100%; max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4);
    }
    .ios-modal-header { padding: 16px; text-align: center; font-weight: 600; font-size: 17px; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; }
    .ios-modal-footer { padding: 16px 24px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; }

    .btn-ios-cancel { flex: 1; height: 50px; border-radius: 14px; background: rgba(118, 118, 128, 0.12); font-weight: 600; display: flex; align-items: center; justify-content: center; }
    .btn-ios-primary { flex: 1; height: 50px; border-radius: 14px; background: var(--ios-primary); color: white; font-weight: 600; display: flex; align-items: center; justify-content: center; }

    .iphone-dock {
      background: rgba(245, 245, 245, 0.75); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
      border-radius: 38px; padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: flex-end;
    }

    .day-tab { transition: all 0.3s ease; background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255,255,255,0.2); }
    .day-tab.active { background: rgba(255, 255, 255, 0.9); border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }

    .task-done { text-decoration: line-through; color: #8E8E93; opacity: 0.7; }
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    .sortable-ghost { opacity: 0.3; background: var(--ios-primary) !important; }
  </style>
</head>

<body>
  <div id="app">
    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg" class="w-full h-full object-cover blur-[4px] scale-105">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 no-scrollbar pb-safe px-5">
      <div class="flex items-center justify-between mb-8 mt-4">
        <div>
          <h1 class="text-[34px] leading-tight font-bold tracking-tight text-black drop-shadow-sm font-[SF Pro Display]">eMenu Taipei</h1>
          <div class="flex items-center gap-2 mt-0.5 pl-1">
            <span class="text-[9px] font-semibold text-gray-400/80 uppercase tracking-widest">{{ appVersion }}</span>
            <div class="flex items-center gap-2 bg-white/50 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
                <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300"
                     :class="syncStatusClass"></div>
                <span class="text-[10px] font-medium text-gray-500">{{ syncStatusText }}</span>
            </div>
             <button @click="forceReloadCloud" class="text-gray-400 hover:text-gray-600 transition p-1">
                <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
            </button>
          </div>
        </div>
      
        <div class="text-right">
           <div class="flex flex-col items-end">
              <span class="text-[10px] font-bold text-[#007AFF] uppercase tracking-wide mb-0.5">Âç≥ÊôÇÂåØÁéá</span>
              <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide mb-1">HKD / TWD</span>
           </div>
           <div class="text-xl font-bold text-gray-800 tracking-tight font-mono leading-none">
             {{ formattedRate }}
           </div>
           <div class="text-[9px] font-medium text-gray-400/80 mt-1 font-mono tracking-tight">
             Â∑≤Âê´Á¥Ñ 2% ÈäÄË°åÊâãÁ∫åË≤ª
           </div>
        </div>
      </div>

      <div class="mb-8">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button @click="currentTab = 'Ê∫ñÂÇô'" class="day-tab flex-shrink-0 w-[20%] h-[76px] rounded-2xl flex flex-col items-center justify-center text-xs group" :class="{ 'active': currentTab === 'Ê∫ñÂÇô' }">
             <i class="ph ph-list-checks text-2xl mb-1 text-gray-400 transition-colors group-[.active]:text-[#007AFF]"></i>
             <span class="font-medium text-gray-500 group-[.active]:font-bold">Ê∫ñÂÇô</span>
          </button>
          
          <button v-for="(d, i) in days" :key="i" @click="selectDay(i); currentTab = 'Ë°åÁ®ã'" class="day-tab flex-shrink-0 w-[22%] h-[76px] rounded-2xl flex flex-col items-center justify-center group" :class="{ 'active': selectedDay === i && currentTab === 'Ë°åÁ®ã' }">
            <span class="text-[10px] font-bold uppercase text-gray-400 mb-0.5 group-[.active]:text-[#007AFF]">Day {{ i + 1 }}</span>
            <span class="text-[11px] font-medium text-gray-400 group-[.active]:text-gray-800">{{ d.week }}</span>
            <span class="text-lg font-bold mt-0.5 leading-none text-gray-600 group-[.active]:text-black">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentTab === 'Ê∫ñÂÇô'" class="space-y-4 mb-6">
          <h3 class="ml-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-widest">Âá∫ÁôºÂâçÊ∫ñÂÇô</h3>
          <ul id="pre-note-list" class="space-y-2">
            <li v-for="note in sortedPreNotes" :key="note.id" :data-id="note.id" class="ios-list-item !py-3">
              <div class="flex items-center gap-3 flex-1">
                <div class="drag-handle"><i class="ph ph-equals"></i></div>
                <div class="cursor-pointer" @click="togglePreNoteDone(note.id)">
                  <i class="ph text-2xl" :class="note.isDone ? 'ph-check-circle-fill text-green-500' : 'ph-circle text-gray-300'"></i>
                </div>
                <span class="font-medium text-gray-800" :class="{'task-done': note.isDone}">{{ note.name }}</span>
              </div>
              <div class="action-btn-group">
                <button @click.stop="openPreNoteModal(note)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                <button @click.stop="removePreNote(note.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
              </div>
            </li>
          </ul>
          <div class="mt-6 flex gap-3">
            <input v-model="newPreNote" @keyup.enter="addPreNote" class="ios-input bg-white/70" placeholder="Âø´ÈÄüÊñ∞Â¢ûÈ†ÖÁõÆ...">
            <button @click="addPreNote" class="w-12 h-12 flex items-center justify-center bg-[#007AFF] text-white rounded-xl shadow-lg active:scale-95 flex-shrink-0"><i class="ph ph-plus text-xl"></i></button>
          </div>
      </div>

      <div v-if="currentTab === 'Ë°åÁ®ã'" class="space-y-6 mb-6">
        <div class="relative pl-4 border-l-2 border-gray-300/50 ml-3 space-y-6 py-2" id="itinerary-list">
          <div v-for="it in sortedItinerary" :key="it.id" :data-id="it.id" class="relative group">
            <div class="absolute -left-[35px] top-1 drag-handle text-gray-300 hover:text-[#007AFF]"><i class="ph ph-equals"></i></div>
            <div class="absolute -left-[23px] top-1 w-3.5 h-3.5 rounded-full bg-white border-[3px] border-gray-300 z-10"></div>
            <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-4 border border-white/60 shadow-sm flex items-start gap-4" @click="showLocationOnMap(it)">
              <div class="flex-1 min-w-0">
                <div class="text-[10px] font-bold text-[#007AFF] uppercase mb-1">{{ it.time || 'Êú™ÂÆö' }}</div>
                <div class="font-bold text-gray-900">{{ it.title }}</div>
                <div class="text-xs text-gray-500 mt-1 line-clamp-1">{{ it.note }}</div>
              </div>
              <div class="action-btn-group">
                <button @click.stop="openItineraryModal(it)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                <button @click.stop="removeItineraryItem(it.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentTab === 'Ë≥ºÁâ©'" class="space-y-4 mb-6">
         <ul id="shopping-list-el" class="space-y-3">
           <li v-for="item in sortedShopping" :key="item.id" :data-id="item.id" class="ios-list-item">
             <div class="flex items-center gap-3">
               <div class="drag-handle"><i class="ph ph-equals"></i></div>
               <div class="w-12 h-12 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0">
                 <img v-if="item.imageURL" :src="item.imageURL" class="w-full h-full object-cover">
                 <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="ph ph-image"></i></div>
               </div>
               <span class="font-bold text-gray-800">{{ item.name }}</span>
             </div>
             <div class="action-btn-group">
                <button @click.stop="openShoppingModal(item)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                <button @click="removeShoppingItem(item.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
             </div>
           </li>
         </ul>
      </div>

      <div v-if="currentTab === 'Ë®òÂ∏≥'" class="space-y-4 mb-6">
        <ul id="expense-list-el" class="space-y-2">
           <li v-for="ex in sortedExpenses" :key="ex.id" :data-id="ex.id" class="ios-list-item !py-3">
             <div class="flex items-center gap-3">
               <div class="drag-handle"><i class="ph ph-equals"></i></div>
               <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 text-lg">
                 {{ ex.categoryIcon || 'üí∏' }}
               </div>
               <div>
                 <div class="font-bold text-gray-900">{{ ex.title }}</div>
                 <div class="text-[10px] text-gray-400 font-bold uppercase">{{ ex.date }}</div>
               </div>
             </div>
             <div class="flex items-center gap-4">
                <div class="text-right">
                  <div class="font-mono font-bold text-gray-900">${{ ex.amount }}</div>
                  <div class="text-[10px] font-bold text-gray-400 uppercase">{{ ex.currency }}</div>
                </div>
                <div class="action-btn-group">
                  <button @click.stop="openExpenseModal(ex)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                  <button @click="removeExpense(ex.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
                </div>
             </div>
           </li>
        </ul>
      </div>

      <div v-if="currentTab === 'Ë≥áË®ä'" class="space-y-4 mb-6">
        <ul id="info-list-el" class="space-y-3">
          <li v-for="it in sortedInfo" :key="it.id" :data-id="it.id" class="ios-list-item !items-start !p-5">
            <div class="flex items-start gap-3 flex-1">
              <div class="drag-handle mt-1"><i class="ph ph-equals"></i></div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-[17px] text-gray-900">{{ it.title }}</div>
                <div class="text-sm text-gray-500 mt-2 whitespace-pre-wrap leading-relaxed">{{ it.note }}</div>
              </div>
            </div>
            <div class="action-btn-group">
              <button @click.stop="openInfoModal(it)" class="icon-btn edit"><i class="ph ph-pencil-simple text-lg"></i></button>
              <button @click="removeInfo(it.id)" class="icon-btn delete"><i class="ph ph-trash text-lg"></i></button>
            </div>
          </li>
        </ul>
      </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-5 pb-8 z-40">
        <div class="iphone-dock max-w-md mx-auto relative">
            <button v-for="tab in ['Ê∫ñÂÇô','Ë°åÁ®ã','Ë≥ºÁâ©','Ë®òÂ∏≥','Ë≥áË®ä']" :key="tab" @click="currentTab = tab" class="flex flex-col items-center gap-1 group transition-all" :class="currentTab === tab ? 'scale-110 -translate-y-2' : 'opacity-60 hover:opacity-100'">
                <div class="w-14 h-14 rounded-[1.2rem] flex items-center justify-center shadow-lg transition-all"
                     :class="currentTab === tab ? 'bg-white' : 'bg-gray-200/50 backdrop-blur-md'">
                     <i class="ph text-2xl" :class="tabIcons[tab]" :style="{color: currentTab === tab ? tabColors[tab] : '#8E8E93'}"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-500">{{ tab }}</span>
            </button>
            <button @click="openAddModal" class="absolute -top-6 -right-2 w-12 h-12 bg-black text-white rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition">
              <i class="ph ph-plus text-2xl"></i>
            </button>
        </div>
    </div>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;
    const supabaseClient = supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_KEY');

    createApp({
      setup() {
        // --- State ---
        const appVersion = 'v4.00';
        const syncState = ref('synced'); // synced, saving, loading, error, conflict
        const lastSyncTimestamp = ref(0);
        const currentTab = ref('Ë°åÁ®ã');
        const selectedDay = ref(0);
        
        // Data Collections
        const days = ref([
          { date: '15', week: 'Mon', type: 'flight-out', itinerary: [] },
          { date: '16', week: 'Tue', type: 'normal', itinerary: [] },
          { date: '17', week: 'Wed', type: 'normal', itinerary: [] },
          { date: '18', week: 'Thu', type: 'flight-return', itinerary: [] }
        ]);
        const preTripNotes = ref([]);
        const shoppingList = ref([]);
        const expenses = ref([]);
        const infoList = ref([]);
        const flights = ref([]);
        
        const rate = ref(null);
        const newPreNote = ref('');

        // --- Computed for Sort ---
        const sortByOrder = (a, b) => (a.order || 0) - (b.order || 0);
        const sortedPreNotes = computed(() => [...preTripNotes.value].sort(sortByOrder));
        const sortedShopping = computed(() => [...shoppingList.value].sort(sortByOrder));
        const sortedExpenses = computed(() => [...expenses.value].sort(sortByOrder));
        const sortedInfo = computed(() => [...infoList.value].sort(sortByOrder));
        const sortedItinerary = computed(() => {
          const list = days.value[selectedDay.value]?.itinerary || [];
          return [...list].sort(sortByOrder);
        });

        const formattedRate = computed(() => {
            if (!rate.value) return '...';
            // ÂØ¶‰ΩúÈäÄË°åÊâãÁ∫åË≤ª‰º∞ÁÆó (rawRate * 0.98) 
            return (rate.value * 0.98).toFixed(2);
        });

        const syncStatusText = computed(() => {
          if (syncState.value === 'saving') return 'ÂêåÊ≠•‰∏≠...';
          if (syncState.value === 'loading') return 'ËºâÂÖ•‰∏≠...';
          if (syncState.value === 'conflict') return 'ÁâàÊú¨Ë°ùÁ™Å (Ëá™ÂãïÊõ¥Êñ∞‰∏≠)';
          if (syncState.value === 'error') return 'ÂêåÊ≠•Â§±Êïó';
          return 'Â∑≤ÂêåÊ≠•Èõ≤Á´Ø';
        });

        const syncStatusClass = computed(() => ({
          'bg-green-500': syncState.value === 'synced',
          'bg-yellow-400': ['saving', 'loading', 'conflict'].includes(syncState.value),
          'bg-red-500': syncState.value === 'error'
        }));

        // --- Core Sync Logic (‰øÆÊ≠£Ë≥áÊñôÂõûÊ∫Ø) ---
        
        async function loadFromCloud() {
          syncState.value = 'loading';
          try {
            const { data, error } = await supabaseClient.from('itinerary_data').select('*').eq('id', 1).single();
            if (data) {
              const payload = data.payload;
              lastSyncTimestamp.value = new Date(data.updated_at).getTime();
              
              if (payload.days) days.value = payload.days;
              if (payload.preTripNotes) preTripNotes.value = payload.preTripNotes;
              if (payload.shoppingList) shoppingList.value = payload.shoppingList;
              if (payload.expenses) expenses.value = payload.expenses;
              if (payload.infoList) infoList.value = payload.infoList;
              if (payload.flights) flights.value = payload.flights;
            }
            syncState.value = 'synced';
          } catch (e) {
            syncState.value = 'error';
          }
        }

        async function saveToCloud() {
          if (syncState.value === 'loading') return;
          syncState.value = 'saving';
          
          try {
            // 1. ÊØîÂ∞çÈõ≤Á´ØÊôÇÈñìÊà≥ (Èò≤ÂõûÊ∫ØÊ©üÂà∂) [cite: 2]
            const { data: remote } = await supabaseClient.from('itinerary_data').select('updated_at').eq('id', 1).single();
            const cloudTime = new Date(remote.updated_at).getTime();
            
            if (cloudTime > lastSyncTimestamp.value) {
                // Èõ≤Á´ØËºÉÊñ∞ÔºåÊîæÊ£ÑÂØ´ÂÖ•‰∏¶ÈáçÊñ∞ÊãâÂèñ
                syncState.value = 'conflict';
                await loadFromCloud();
                return;
            }

            // 2. Ê∫ñÂÇô Payload
            const payload = {
              days: JSON.parse(JSON.stringify(days.value)),
              preTripNotes: preTripNotes.value,
              shoppingList: shoppingList.value,
              expenses: expenses.value,
              infoList: infoList.value,
              flights: flights.value
            };

            // 3. Êõ¥Êñ∞
            const now = new Date();
            const { error } = await supabaseClient.from('itinerary_data').update({
              payload,
              updated_at: now.toISOString()
            }).eq('id', 1);

            if (error) throw error;
            lastSyncTimestamp.value = now.getTime();
            syncState.value = 'synced';
          } catch (e) {
            console.error(e);
            syncState.value = 'error';
          }
        }

        // --- Drag & Drop Initialization ---
        function initSortable(selector, listRef, onEndCallback) {
          const el = document.querySelector(selector);
          if (!el) return;
          Sortable.create(el, {
            animation: 150,
            handle: '.drag-handle',
            delay: 400, // Èï∑ÊåâËß∏ÁôºÈÅøÂÖçË™§Ëß∏ 
            delayOnTouchOnly: true,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
              const items = [...listRef.value].sort(sortByOrder);
              const [movedItem] = items.splice(evt.oldIndex, 1);
              items.splice(evt.newIndex, 0, movedItem);
              
              // ÈáçÊñ∞Ë®àÁÆó order 
              items.forEach((item, idx) => { item.order = idx; });
              if (onEndCallback) onEndCallback(items);
              saveToCloud(); // ÂÉÖÂú®ÊãñÂãïÁµêÊùüÊôÇÂØ´ÂÖ• 
            }
          });
        }

        // --- Actions ---
        function addPreNote() {
          if (!newPreNote.value.trim()) return;
          preTripNotes.value.push({
            id: Date.now().toString(),
            name: newPreNote.value,
            isDone: false,
            order: preTripNotes.value.length
          });
          newPreNote.value = '';
          saveToCloud();
        }

        function togglePreNoteDone(id) {
          const note = preTripNotes.value.find(n => n.id === id);
          if (note) note.isDone = !note.isDone;
          saveToCloud();
        }

        function removePreNote(id) {
          if (!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
          preTripNotes.value = preTripNotes.value.filter(n => n.id !== id);
          saveToCloud();
        }

        async function fetchRate() {
          try {
            const res = await fetch('https://open.er-api.com/v6/latest/TWD');
            const d = await res.json();
            if (d?.rates?.HKD) rate.value = (1 / d.rates.HKD).toFixed(4);
          } catch (e) {}
        }

        // --- Lifecycle ---
        onMounted(async () => {
          await loadFromCloud();
          fetchRate();
          
          // ÂàùÂßãÂåñÊâÄÊúâÂàóË°®ÁöÑ Sortable
          setTimeout(() => {
            initSortable('#pre-note-list', preTripNotes);
            initSortable('#shopping-list-el', shoppingList);
            initSortable('#expense-list-el', expenses);
            initSortable('#info-list-el', infoList);
            initSortable('#itinerary-list', computed({
              get: () => days.value[selectedDay.value].itinerary,
              set: (val) => { days.value[selectedDay.value].itinerary = val; }
            }));
          }, 1000);
        });

        // Áõ£Êéß Visibility Change (ÂÉÖÊãâÂèñÔºå‰∏çÂØ´Âõû) [cite: 2]
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') loadFromCloud();
        });

        return {
          appVersion, syncState, syncStatusText, syncStatusClass, lastSyncTimestamp,
          currentTab, days, selectedDay, preTripNotes, shoppingList, expenses, infoList,
          formattedRate, newPreNote, addPreNote, togglePreNoteDone, removePreNote,
          sortedPreNotes, sortedShopping, sortedExpenses, sortedInfo, sortedItinerary,
          selectDay: (i) => { selectedDay.value = i; },
          forceReloadCloud: loadFromCloud,
          tabIcons: { 'Ê∫ñÂÇô': 'ph-list-checks', 'Ë°åÁ®ã': 'ph-map-trifold', 'Ë≥ºÁâ©': 'ph-bag', 'Ë®òÂ∏≥': 'ph-coins', 'Ë≥áË®ä': 'ph-info' },
          tabColors: { 'Ê∫ñÂÇô': '#007AFF', 'Ë°åÁ®ã': '#5856D6', 'Ë≥ºÁâ©': '#FF9500', 'Ë®òÂ∏≥': '#34C759', 'Ë≥áË®ä': '#8E8E93' }
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
